---
title: "Adaptive shrinkage of log-fold changes"
author: Peter Carbonetto
output: workflowr::wflow_html
---

Here we illustrate the use of the adaptive shrinkage method in the
differential expression analysis using a topic model. Since the
effect of the shrinkage is hard to see on the full data set, we
perform the differential expression analysis on a random subset of 100
cells.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below, as well as additional
functions that we will use to generate some of the plots.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(fastTopics)
library(ggplot2)
library(cowplot)
```

Load the count data.

```{r load-data}
load("../data/pbmc_purified.RData")
```

Load the $K = 6$ Poisson NMF model fit.

```{r load-fit}
fit <- readRDS(file.path("../output/pbmc-purified/rds",
                         "fit-pbmc-purified-scd-ex-k=6.rds"))$fit
fit <- poisson2multinom(fit)
```

Set the seed to ensure that the results are reproducible.

```{r set-seed}
set.seed(1)
```

Take a random subset of 100 cells.

```{r subset-cells}
n       <- nrow(counts)
rows    <- sample(n,100)
samples <- samples[rows,]
counts  <- counts[rows,]
fit     <- select_loadings(fit,loadings = rows)
```

Perform differential expression analysis using the multinomial topic
model, without shrinkage:

```{r diff-count-analysis-1}
res1 <- diff_count_analysis(fit,counts,shrink.method = "none")
```

Redo the different expression analysis, this time applying adaptive
shrinkage to the log-fold change estimates and standard errors:

```{r diff-count-analysis-2}
res2 <- diff_count_analysis(fit,counts,shrink.method = "ash")
```

The adaptive shrinkage is applied separately to each topic. In these
next plots, we illustrate the effect of the adaptive shrinkage on
topic 3, which corresponds to B cells.

These two scatterplots show the "raw" *z*-scores and the posterior
*z*-scores ("shrunk"), coloured by their average expression. Since a
handful of genes have much larger *z*-scores than the others, it is
hard to see the effect of the adaptive shrinkage, so the right-hand
plot shows the same results, but zoomed in on *z*-scores closer to
zero.

```{r scatterplot, fig.height=2.5, fig.width=7, warning=FALSE}
pdat <- data.frame(mean   = res1$colmeans,
                   raw    = res1$Z[,3],
                   shrunk = res2$Z[,3])
p1 <- ggplot(pdat,aes(x = raw,y = shrunk,fill = log10(mean))) +
  geom_point(shape = 21,color = "white") +
  scale_fill_gradient2(low = "deepskyblue",mid = "gold",high = "orangered",
                       na.value = "gainsboro",midpoint = 0) +
  geom_abline(slope = 1,intercept = 0,color = "skyblue",linetype = "dotted") +
  theme_cowplot(font_size = 10)
p2 <- p1 + xlim(-4,8) + ylim(-4,8)
plot_grid(p1,p2)
```

The log-fold changes that are most strongly shrunk to zero tend to be
for the genes with lower levels of expression.

This is what the volcano plots look like with and without adaptive
shrinkage:

```{r volcano-plots, fig.width=6.5, fig.height=3}
p3 <- volcano_plot(res1,k = "k3",labels = genes$symbol,
                   filter_low_counts = 0.05,
                   label_above_quantile = 0.999) +
  ggtitle("topic 3 (raw)")
p4 <- volcano_plot(res2,k = "k3",labels = genes$symbol,
                   filter_low_counts = 0.05,
                   label_above_quantile = 0.999) +
  ggtitle("topic 3 (shrunk)")
plot_grid(p3,p4)
```
