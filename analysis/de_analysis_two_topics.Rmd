---
title: "Evaluation of fastTopics DE analysis methods in simulations---case of 2 topics"
author: Peter Carbonetto
output: workflowr::wflow_html
---

Here we evaluate performance of the grade-of-membership DE methods in
simulations, focussing on the case of $K = 2$ topics. A smaller
simulation with $K = 2$ topics was first performed
[here](de_analysis_detailed_look.html), and based on this initial
simulation we have conducted a larger set of simulations using the
`run_sims.R` script. Here we summarize the results of this larger set
of simulations.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.show = "hold",fig.align = "center",dpi = 120)
```

Load the packages needed for this analysis, and some additional
functions used to compile the results and generate the plots.

```{r load-pkgs, message=FALSE, warning=FALSE}
library(Matrix)
library(fastTopics)
library(ggplot2)
library(cowplot)
source("../code/de_analysis_functions.R")
```

Load the results of the simulations.

```{r load-sims}
load("../output/sims/sims-k=2.RData")
```

These were the R packages used to run the simulations:

```{r session-info}
res$session.info
```

Before comparing the methods, we first assess accuracy of the Monte
Carlo computations by comparing the estimates from two independent
MCMC runs.

```{r mcmc-scatterplots, fig.height=3, fig.width=6}
res["session.info"] <- NULL
pdat <- data.frame(lfc1 = combine_sim_res(res,function (x) x$de1$postmean[,2]),
                   lfc2 = combine_sim_res(res,function (x) x$de2$postmean[,2]),
                   z1   = combine_sim_res(res,function (x) x$de1$z[,2]),
		           z2   = combine_sim_res(res,function (x) x$de2$z[,2]))
p1 <- ggplot(pdat,aes(x = lfc1,y = lfc2)) +
  geom_point(color = "dodgerblue",shape = 4,size = 0.75) +
  geom_abline(intercept = 0,slope = 1,linetype = "dotted") +
  labs(x = "first posterior mean",y = "second posterior mean") +
  theme_cowplot(font_size = 12)
p2 <- ggplot(pdat,aes(x = z1,y = z2)) +
  geom_point(color = "dodgerblue",shape = 4,size = 0.75) +
  geom_abline(intercept = 0,slope = 1,linetype = "dotted") +
  labs(x = "first z-score estimate",y = "second z-score estimate") +
  theme_cowplot(font_size = 12)
plot_grid(p1,p2)
```

We see from these scatterplots that the estimates of the posterior
mean LFCs and *z*-scores generated by the two MCMC runs are very
similar.

```{r mcmc-scatterplots-for-paper, echo=FALSE}
ggsave("../plots/mcmc_scatterplots_sims_k=2.png",
       plot_grid(p1,p2),height = 3,width = 6,dpi = 600)
```

Next we consider the K-L divergence measure used in Dey, Hsiao &
Stephens (2017) to rank genes, and compare its ranking to a ranking
based on *p*-values (without using adaptive shrinkage) or *s*-values
(after applying adaptive shrinkage). Since the K-L divergence is not a
signed ranking, we restrict this comparison only to genes that are
estimated to have greater (or equal) expression in topic 2 compared to
topic 1.

```{r ranking-histograms, fig.height=2.25, fig.width=7}
get_nonneg_lfcs <- function (F)
  which(F[,2] - F[,1] > -1e-8)
nonzero_lfc <- combine_sim_res(res,
                 function (x) {
                   i <- get_nonneg_lfcs(x$fit$F)
                   return(abs(x$dat$F[i,1] - x$dat$F[i,2]) > 1e-8)
                 })
noshrink <-
  combine_sim_res(res,function (x) x$de0$lpval[get_nonneg_lfcs(x$fit$F),2])
shrink <-
  combine_sim_res(res,function(x)x$de1$svalue[get_nonneg_lfcs(x$fit$F),2])
lfsr <- combine_sim_res(res,function(x)x$de1$lfsr[get_nonneg_lfcs(x$fit$F),2])
lkl <- combine_sim_res(res,function (x)
         fastTopics:::min_kl_poisson(x$fit$F)[get_nonneg_lfcs(x$fit$F),2])
pdat <- data.frame(nonzero_lfc = factor(nonzero_lfc),
                   noshrink    = 10^(-noshrink),
                   shrink      = shrink,
                   lfsr        = lfsr,
                   lkl         = log10(lkl + 1e-8))
p1 <- ggplot(pdat,aes(x = lkl,color = nonzero_lfc,fill = nonzero_lfc)) +
  geom_histogram(bins = 64,show.legend = FALSE) +
  scale_color_manual(values = c("darkorange","darkblue")) +
  scale_fill_manual(values = c("darkorange","darkblue")) +
  labs(x = "log10 K-L divergence",y = "genes",title = "K-L divergence") +
  theme_cowplot(font_size = 12)
p2 <- ggplot(pdat,aes(x = noshrink,color = nonzero_lfc,fill = nonzero_lfc)) +
  geom_histogram(bins = 64,show.legend = FALSE) +
  scale_color_manual(values = c("darkorange","darkblue")) +
  scale_fill_manual(values = c("darkorange","darkblue")) +
  labs(x = "p-value",y = "genes",title = "without shrinkage") +
  theme_cowplot(font_size = 12)
p3 <- ggplot(pdat,aes(x = shrink,color = nonzero_lfc,fill = nonzero_lfc)) +
  geom_histogram(bins = 64,show.legend = FALSE) +
  scale_color_manual(values = c("darkorange","darkblue")) +
  scale_fill_manual(values = c("darkorange","darkblue")) +
  labs(x = "s-value",y = "genes",title = "with shrinkage") +
  theme_cowplot(font_size = 12)
plot_grid(p1,p2,p3,nrow = 1,ncol = 3)
```

```{r ranking-histograms-for-paper, echo=FALSE}
ggsave("../plots/rankings_sims_k=2.eps",
       plot_grid(p1,p2,p3,nrow = 1,ncol = 3),height = 2.25,width = 7)
```

Having compared the overall distributions of the gene-wise rankings,
we now compare performance of these rankings by plotting power
vs. FDR. Again, we restrict this comparison only to genes that are
estimated to have greater (or equal) expression in topic 2 compared to
topic 1.

```{r fdr-vs-power, fig.height=2.5, fig.width=4}
v1  <- create_fdr_vs_power_curve(-pdat$lkl,nonzero_lfc,length.out = 200)
v2  <- create_fdr_vs_power_curve(pdat$noshrink,nonzero_lfc,length.out = 200)
v3  <- create_fdr_vs_power_curve(pdat$lfsr,nonzero_lfc,length.out = 200)
dat <- rbind(cbind(v1,method = "kl"),
             cbind(v2,method = "noshrink"),
             cbind(v3,method = "shrink"))
p <- ggplot(dat,aes(x = fdr,y = power,color = method)) +
  geom_line(size = 0.65,orientation = "y")  +
  scale_color_manual(values = c("royalblue","limegreen","orange")) +
  theme_cowplot()
print(p)
```

```{r fdr-vs-power-for-paper, echo=FALSE}
ggsave("../plots/fdr_vs_power_sims_k=2.eps",p,height = 2.5,width = 4)
```
