---
title: Visualize and interpret topics in PBMC data
author: Peter Carbonetto
output: workflowr::wflow_html
---

*TO DO: Add introductory text here.*

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below.

```{r load-pkgs, message=FALSE}
library(dplyr)
library(fastTopics)
library(ggplot2)
library(cowplot)
source("../code/plots.R")
```

Load the sample annotations. (The count data are no longer needed at this
stage of the analysis.)

```{r load-data}
load("../data/pbmc_purified.RData")
samples_purified <- samples
load("../data/pbmc_68k.RData")
samples_68k <- samples
rm(genes,counts)
```

Load the $k = 6$ Poisson NMF model fits for both PBMC data sets. To
reduce confusion, topics in the `fit_68k` Poisson NMF model fit are
reordered to better align with the topics in `fit_purified` Poisson
NMF model fit.

```{r load-fits}
fit_purified <-
  readRDS("../output/pbmc-purified/rds/fit-pbmc-purified-scd-ex-k=6.rds")$fit
fit_68k <- readRDS("../output/pbmc-68k/rds/fit-pbmc-68k-scd-ex-k=6.rds")$fit
cols      <- c(4,1,5,3,6,2)
fit_68k$F <- fit_68k$F[,cols]
fit_68k$L <- fit_68k$L[,cols]
colnames(fit_68k$F) <- paste0("k",1:6)
colnames(fit_68k$L) <- paste0("k",1:6)
```

We begin my exploring the structure in the PBMC data as inferred by
the topic model. Here we show that a basic PCA rotation of the topic
proportions is an effective way to visualize this structure. We begin
with the mixture of FACS-purified PBMC data sets.

```{r pbmc-purified-clustering-1}
pca_purified <- prcomp(poisson2multinom(fit_purified)$L)$x
```

Three large clusters are evident from first two PCs (with possibly
more subtle structures within these clusters):

```{r pbmc-purified-clustering-2, fig.width=4.5, fig.height=4}
n <- nrow(pca_purified)
x <- rep("c3",n)
pc1 <- pca_purified[,"PC1"]
pc2 <- pca_purified[,"PC2"]
x[pc1 + 0.2 > pc2] <- "c1"
x[pc2 > 0.25] <- "c2"
x[(pc1 + 0.4)^2 + (pc2 + 0.1)^2 < 0.07] <- "c3"
samples_purified$cluster <- factor(x)
purified_cluster_colors <- c("tomato","dodgerblue","lightskyblue")
p1 <- pca_plot_with_labels(fit_purified,c("PC1","PC2"),
                           samples_purified$cluster,
                           purified_cluster_colors) +
      labs(fill = "cluster")
print(p1)
```

Most of the samples are included in the first (red) cluster:

```{r pbmc-purified-clustering-3}
print(table(samples_purified$cluster))
```

Next we turn to the 68k PBMC data.

```{r pbmc-68k-clustering-1}
pca_68k <- prcomp(poisson2multinom(fit_68k)$L)$x
```

Here, we see at least three distinct clusters in the projection onto
PCs 3 and 4:

```{r pbmc-68k-clustering-2, fig.width=4.5, fig.height=4}
n <- nrow(pca_68k)
x <- rep("c1",n)
pc3 <- pca_68k[,"PC3"]
pc4 <- pca_68k[,"PC4"]
x[pc4 < -0.13 | pc3/2 - 0.17 > pc4] <- "c2"
x[pc4 < -0.75] <- "c3"
samples_68k$cluster <- factor(x)
pbmc_68k_cluster_colors <- c("cornflowerblue","darkorange","firebrick")
p2 <- pca_plot_with_labels(fit_68k,c("PC3","PC4"),factor(x),
                           pbmc_68k_cluster_colors) +
      labs(fill = "cluster")
print(p2)
```

The vast majority of the cells are in the first (blue) cluster:

```{r pbmc-68k-clustering-3}
table(samples_68k$cluster)
```

**TO DO:** Add text here.

```{r pbmc-purified-structure-plot, fig.width=6, fig.height=2}
set.seed(1)
pbmc_purified_topics       <- c(2,5,1,3,4,6)
pbmc_purified_topic_colors <- c("gold","forestgreen","dodgerblue",
                                "gray","greenyellow","magenta")
rows <- sort(c(sample(which(samples_purified$cluster == "c1"),1200),
               sample(which(samples_purified$cluster == "c2"),600),
               sample(which(samples_purified$cluster == "c3"),600)))
fit2 <- select(poisson2multinom(fit_purified),loadings = rows)
p3 <- structure_plot(fit2,grouping = samples_purified[rows,"cluster"],
                     topics = pbmc_purified_topics,
                     colors = pbmc_purified_topic_colors[pbmc_purified_topics],
                     gap = 40,num_threads = 4,verbose = FALSE)
print(p3)
```

**TO DO:** Add text here.

```{r pbmc-68k-structure-plot, fig.width=6, fig.height=2}
pbmc_68k_topics       <- c(2,5,1,3,4,6)
pbmc_68k_topic_colors <- c("darkorange","olivedrab","dodgerblue",
                           "gray","royalblue","magenta")
set.seed(1)
rows <- sort(c(sample(which(samples_68k$cluster == "c1"),1400),
               sample(which(samples_68k$cluster == "c2"),500),
               which(samples_68k$cluster == "c3")))
fit2 <- select(poisson2multinom(fit_68k),loadings = rows)
p4 <- structure_plot(fit2,grouping = samples_68k[rows,"cluster"],
                     topics = pbmc_68k_topics,
                     colors = pbmc_68k_topic_colors[pbmc_68k_topics],
                     gap = 40,num_threads = 4,verbose = FALSE)
print(p4)
```

```{r}
```

Comparison to Zheng et al (2017) cell-type labeling of the
FACS-purified PBMC data:

```{r, eval=FALSE}
purified_celltype_colors <-
  c("dodgerblue",  # CD19+ B
    "forestgreen", # CD14+ Monocyte
    "lightskyblue",# CD34+
    "plum",        # CD4+ T Helper2
    "slategray",   # CD56+ NK
    "tomato",      # CD8+ Cytotoxic T
    "gold",        # CD4+/CD45RO+ Memory
    "magenta",     # CD8+/CD45RA+ Naive Cytotoxic
    "darkorange",  # CD4+/CD45RA+/CD25- Naive T
    "yellowgreen") # CD4+/CD25 T Reg
library(Ternary)
par(mar = c(0,0,0,0))
rows <- which(samples_purified$cluster == "c1")
pdat <- cbind(poisson2multinom(fit_purified)$L,samples_purified["celltype"])
levels(pdat$celltype) <- purified_celltype_colors
TernaryPlot(alab = "k1",blab = "k4",clab = "k6",grid.col = "skyblue",
            grid.minor.lines = 0)
TernaryPoints(pdat[rows,c(1,4,6)],pch = 20,
  			  col = as.character(pdat[rows,"celltype"]),cex = 0.5)
```

```{r, eval=FALSE}
clrs <- c("forestgreen",  # CD14+ Monocyte
          "dodgerblue",   # CD19+ B
          "darkmagenta",  # CD34+"
          "yellowgreen",  # CD4+ T Helper2
          "gold",         # CD4+/CD25 T Reg
          "limegreen",    # CD4+/CD45RA+/CD25- Naive T
          "orange",       # CD4+/CD45RO+ Memory"
          "gray",         # CD56+ NK
          "tomato",       # CD8+ Cytotoxic T
          "magenta",      # CD8+/CD45RA+ Naive Cytotoxic"
          "darkblue")     # Dendritic"
library(Ternary)
par(mar = c(0,0,0,0))
L    <- poisson2multinom(fit_68k)$L
rows <- which(samples_68k$cluster == "c1" & L[,3] < 0.5)
pdat <- cbind(L,samples_68k["celltype"])
levels(pdat$celltype) <- clrs
TernaryPlot(alab = "k4",blab = "k5",clab = "k6",grid.col = "skyblue",
            grid.minor.lines = 0)
TernaryPoints(pdat[rows,c(4,5,6)],pch = 20,
  			  col = as.character(pdat[rows,"celltype"]),cex = 0.5)
```

```{r pbmc-purified-pca-with-celltypes, eval=FALSE}
p4 <- pca_plot_with_labels(fit_purified,c("PC1","PC2"),
                           samples_purified$celltype,
                           purified_celltype_colors) + labs(fill = "celltype")
p5 <- pca_plot_with_labels(fit_purified,c("PC4","PC5"),
                           samples_purified$celltype,
                           purified_celltype_colors) + labs(fill = "celltype")
```

Loadings plot:

```{r loading-plot, eval=FALSE}
loadings_plot(poisson2multinom(fit_purified),samples_purified$celltype)
loadings_plot(poisson2multinom(fit_68k),samples_68k$celltype)
```

PCA plot:

```{r pca-plot, eval=FALSE}
clrs <- c("forestgreen",  # CD14+ Monocyte
          "dodgerblue",   # CD19+ B
          "darkmagenta",  # CD34+"
          "yellowgreen",  # CD4+ T Helper2
          "gold",         # CD4+/CD25 T Reg
          "limegreen",    # CD4+/CD45RA+/CD25- Naive T
          "orange",       # CD4+/CD45RO+ Memory"
          "gray",         # CD56+ NK
          "tomato",       # CD8+ Cytotoxic T
          "magenta",      # CD8+/CD45RA+ Naive Cytotoxic"
          "darkblue")     # Dendritic"
fit2 <- poisson2multinom(fit)
pca  <- prcomp(fit2$L)
pdat <- cbind(samples,pca$x)
ggplot(pdat,aes(x = PC3,y = PC4,fill = celltype)) +
  geom_point(shape = 21,color = "white",size = 1.5) +
  scale_fill_manual(values = clrs) +
  theme_cowplot(font_size = 10)
```

t-SNE plot:

```{r tsne-plot, eval=FALSE}
set.seed(1)
p2 <- tsne_plot(fit,n = 8000,num_threads = 4)
```

Differential count analysis:

```{r diff-count-analysis, eval=FALSE}
diff_count_res <- diff_count_analysis(fit,counts)
```

Volcano plots:

```{r volcano-plots, eval=FALSE}
p3 <- volcano_plot(diff_count_res,labels = genes$symbol,
                   label_above_quantile = 0.995)
```

Structure plots:

```{r structure-plots, eval=FALSE}
set.seed(1)
fit2 <- select(poisson2multinom(fit),
               loadings = which(samples$celltype == "CD19+ B"))
p4   <- structure_plot(fit2,n = 2000,num_threads = 4) # B-cells.
set.seed(1)
fit2 <- select(poisson2multinom(fit),
               loadings = which(samples$celltype == "CD56+ NK"))
p5   <- structure_plot(fit2,n = 2000,num_threads = 4) # NK cells.
set.seed(1)
fit2 <- select(poisson2multinom(fit),
               loadings = which(samples$celltype == "CD34+"))
p6   <- structure_plot(fit2,num_threads = 4,perplexity = 50) # CD34+ cells
set.seed(1)
fit2 <- select(poisson2multinom(fit),
               loadings = which(samples$celltype == "CD14+ Monocyte"))
p7   <- structure_plot(fit2,num_threads = 4) # CD14+ monocytes
set.seed(1)
fit2 <- select(poisson2multinom(fit),
               loadings = which(samples$celltype == "Dendritic"))
p8   <- structure_plot(fit2,num_threads = 4) # dendritic cells
plot_grid(p7,p8,nrow = 2)
set.seed(1)
fit2 <- select(poisson2multinom(fit),
               loadings = which(samples$celltype == "CD4+ T Helper2"))
p9   <- structure_plot(fit2,num_threads = 4,perplexity = 30) +
          ggtitle("CD4+ T Helper2") +
set.seed(1)
fit2 <- select(poisson2multinom(fit),
          loadings = which(samples$celltype == "CD4+/CD45RA+/CD25- Naive T"))
p10  <- structure_plot(fit2,num_threads = 4) +
          ggtitle("CD4+/CD45RA+/CD25- Naive T")
set.seed(1)
fit2 <- select(poisson2multinom(fit),
               loadings = which(samples$celltype == "CD4+/CD45RO+ Memory"))
p11  <- structure_plot(fit2,num_threads = 4) +
  	      ggtitle("CD4+/CD45RO+ Memory")
set.seed(1)
fit2 <- select(poisson2multinom(fit),
               loadings = which(samples$celltype == "CD4+/CD25 T Reg"))
p12  <- structure_plot(fit2,num_threads = 4) +
          ggtitle("CD4+/CD25 T Reg")
fit2 <- select(poisson2multinom(fit),
          loadings = which(samples$celltype == "CD8+/CD45RA+ Naive Cytotoxic"))
p13  <- structure_plot(fit2,num_threads = 4) +
          ggtitle("CD8+/CD45RA+ Naive Cytotoxic")
fit2 <- select(poisson2multinom(fit),
          loadings = which(samples$celltype == "CD8+ Cytotoxic T"))
p14  <- structure_plot(fit2,num_threads = 4) +
          ggtitle("CD8+ Cytotoxic T")
plot_grid(p9,p10,p11,p12,p13,p14,nrow = 6)
```

Another structure plot:

```{r more-structure-plots, eval=FALSE}
p15 <- structure_plot(fit,num_threads = 4)
```
