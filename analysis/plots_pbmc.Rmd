---
title: Visualize and interpret topics in PBMC data
author: Peter Carbonetto
output: workflowr::wflow_html
---

Here we closely examine, and compare, the topic modeling results for the
two closely related data sets from [Zheng *et al* (2017)][zheng-2017],
the mixture of FACS-purified PBMC data and the "unsorted" 68k PBMC
data. The goal is to illustrate how the topic models fitted to these
data sets can be used to learn about the structure in the data,
including identifying clusters, and interpret the clusters and topics
as "cell types" or "gene programs".

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below, as well as additional
functions that will be used to generate some of the plots.

```{r load-pkgs, message=FALSE}
library(dplyr)
library(fastTopics)
library(ggplot2)
library(cowplot)
source("../code/plots.R")
```

Mixture of FACS-purified PBMC data
----------------------------------

We begin with the mixture of FACS-purified PBMC data. Note that the
count data are no longer needed at this stage.

```{r load-purified-data}
load("../data/pbmc_purified.RData")
samples_purified <- samples
rm(samples,genes,counts)
```

Load the $k = 6$ Poisson NMF model fit.

```{r load-purified-fit}
fit_purified <-
  readRDS("../output/pbmc-purified/rds/fit-pbmc-purified-scd-ex-k=6.rds")$fit
```

Here we explore the structure of the single-cell data as inferred by
the topic model. Specifically, we will use PCA to uncover structure in
the topic proportions. Although PCA is simple, we will see that it
works well, and avoids the complications of the popular t-SNE and UMAP
nonlinear dimensionality reduction methods.

```{r pbmc-purified-clustering-1}
fit <- poisson2multinom(fit_purified)
pca <- prcomp(fit$L)$x
```

Three large clusters are evident from first two PCs (there is also
finer-scale structure which we will examine below). We label these
clusters as "A", "B" and "C".

```{r pbmc-purified-clustering-2, fig.width=5, fig.height=4}
n   <- nrow(pca)
x   <- rep("C",n)
pc1 <- pca[,"PC1"]
pc2 <- pca[,"PC2"]
x[pc1 + 0.2 > pc2] <- "A"
x[pc2 > 0.25] <- "B"
x[(pc1 + 0.4)^2 + (pc2 + 0.1)^2 < 0.07] <- "C"
samples_purified$cluster <- x
p1 <- pca_plot_with_labels(fit_purified,c("PC1","PC2"),
                           samples_purified$cluster) +
      labs(fill = "cluster")
print(p1)
```

Most of the samples are in cluster A:

```{r pbmc-purified-clustering-3}
table(x)
```

Note that other PCs beyond the first two may also sometimes reveal
additional clustering, and we will see examples of this in the 68k
PBMC data.

Within cluster C there are two fairly well-defined subclusters
(labeled "C1" and "C2"). There are perhaps other, less defined
subclusters that are less defined, but in this analysis we focus on
the largest, most obvious clusters.

```{r pbmc-purified-clustering-4, fig.width=5, fig.height=4}
rows <- which(samples_purified$cluster == "C")
fit  <- select(poisson2multinom(fit_purified),loadings = rows)
pca  <- prcomp(fit$L)$x
n    <- nrow(pca)
x    <- rep("C3",n)
pc1  <- pca[,1]
pc2  <- pca[,2]
x[pc1 < 0 & pc2 < 0.4] <- "C1"
x[pc1 > 0.5 & pc2 < 0.3] <- "C2"
samples_purified[rows,"cluster"] <- x
p2 <- pca_plot_with_labels(fit,c("PC1","PC2"),x) +
      labs(fill = "cluster")
print(p2)
```

The two subclusters, C1 and C2, account for most of the samples in
cluster C:

```{r pbmc-purified-clustering-5}
table(x)
```

Now we turn to cluster A. Within this cluster, there is a large
subcluster, which we label as "A1". (This cluster is much less
distinct than the other clusters we have seen so far, and may not show
up clearly in this plot---you may need to zoom in on the plot to see
the clustering.) Otherwise, there is no obvious additional clustering
of the samples within cluster A.

```{r pbmc-purified-clustering-6, fig.width=5, fig.height=4}
rows <- which(samples_purified$cluster == "A")
fit  <- select(poisson2multinom(fit_purified),loadings = rows)
pca  <- prcomp(fit$L)$x
n    <- nrow(fit$L)
x    <- rep("A2",n)
pc1  <- pca[,1]
pc2  <- pca[,2]
x[pc1 > 0.58 - pc2 | pc1 > 0.7] <- "A1"
samples_purified[rows,"cluster"] <- x
p3 <- pca_plot_with_labels(fit,c("PC1","PC2"),x) +
      labs(fill = "cluster")
print(p3)
```

In summary, we have subdivided the data into 6 subsets:

```{r pbmc-purified-clustering-7}
samples_purified$cluster <- factor(samples_purified$cluster)
table(samples_purified$cluster)
```

We also inspected principal components individually in each of these 6
clusters and we did not find any of clear examples of subclustering
withing these clusters.

The structure plot summarizes the topic proportions in each of these 6
subsets:

```{r pbmc-purified-structure-plot, fig.width=7, fig.height=1.5}
set.seed(1)
pbmc_purified_topic_colors <- c("gold","forestgreen","dodgerblue",
                                "gray","greenyellow","magenta")
pbmc_purified_topics <- c(2,5,3,1,4,6)
rows <- sort(c(sample(which(samples_purified$cluster == "A1"),250),
               sample(which(samples_purified$cluster == "A2"),1200),
               sample(which(samples_purified$cluster == "B"),250),
               sample(which(samples_purified$cluster == "C1"),250),
               sample(which(samples_purified$cluster == "C2"),200),
               sample(which(samples_purified$cluster == "C3"),200)))
p4 <- structure_plot(select(poisson2multinom(fit_purified),loadings = rows),
                     grouping = samples_purified[rows,"cluster"],
                     topics = pbmc_purified_topics,
                     colors = pbmc_purified_topic_colors[pbmc_purified_topics],
                     n = Inf,perplexity = c(70,100,70,70,50,50),
					 gap = 40,num_threads = 4,verbose = FALSE)
print(p4)
```

Out of the 6 topics, 4 of them ($k = 2, 3, 4, 5$) align closely with
clusters (labeled A1, B, C1, C2). And, indeed, they align closely with
their inclusion in the individual FACS-purified data sets:

```{r pbmc-purified-clusters-vs-celltypes, fig.width=4, fig.height=3.5}
pdat <- as.data.frame(with(samples_purified,table(celltype,cluster)))
ggplot(pdat,aes(x = cluster,y = celltype,size = Freq)) +
  geom_point(color = "dodgerblue",na.rm = TRUE,show.legend = FALSE) +
  ylim(rev(levels(samples_purified$celltype))) +
  theme_cowplot(font_size = 10)
```

Based on the above results, we make a few observations:

+ Because they correspond very closely, subsequent analysis of topics
  2, 3, 4 and 5 should yield similar results to analyzing the clusters
  A1, B, C1, C2 For example, cluster B corresponds almost perfectly to
  the B-cell data set. The largest cluster, cluster A2, is mostly
  comprised of the T-cell data sets.

+ Cluster A2---see also the PCA plot above---is an example where
  analyzing the most prevalent topics ($k = 1, 6$) will yield
  *different* results than analyzing clusters within cluster A1 as any
  additional clustering of the data will be necessarily arbitrary (see
  the PCA plot above).

+ Many samples labeled as "CD34+" are not assigned to the CD34+
  cluster (C1). This is probably due to the fact that this
  population was much less pure (45%) than the others.

+ Cluster C3 is a heterogeneous cluster with a relatively small number
  of samples (790) that could potentially contain additional clusters
  of biological relevance, but will likely be more challenging to
  analyze and interpret than the other clusters, so we do not this
  investigate further.

In summary, a cluster-based analysis and topic-based analysis should
yield mostly similar results, except for the analysis of cluster A2,
which should benefit from a topic-based analysis (specifically,
analysis of topics 1 and 6).

Unsorted 68k PBMC data
----------------------

Next, we turn to the 68k data set.

```{r load-68k-data}
load("../data/pbmc_68k.RData")
samples_68k <- samples
rm(samples,genes,counts)
```

Load the $k = 6$ Poisson NMF model fit, and compute PCs from the topic
proportions.

```{r load-68k-fit}
fit_68k <- readRDS("../output/pbmc-68k/rds/fit-pbmc-68k-scd-ex-k=6.rds")$fit
fit <- poisson2multinom(fit_68k)
pca <- prcomp(fit$L)$x
```

In this case, we find least three distinct clusters in the projection
onto PCs 3 and 4. We label these clusters "A", "B" and "C", as above,
noting that this labeling does not imply a connection with the
purified PBMC clusters above.

```{r pbmc-68k-clustering-2, fig.width=5, fig.height=4}
n <- nrow(pca)
x <- rep("A",n)
pc3 <- pca[,"PC3"]
pc4 <- pca[,"PC4"]
x[pc4 < -0.13 | pc3/1.9 - 0.17 > pc4] <- "B"
x[pc4 < -0.75] <- "C"
samples_68k$cluster <- x
p5 <- pca_plot_with_labels(fit_68k,c("PC3","PC4"),x) +
      labs(fill = "cluster")
print(p5)
```

The vast majority of the cells are in cluster A.

```{r pbmc-68k-clustering-3}
table(samples_68k$cluster)
```

Looking more closely at the top two PCs in cluster B, we identify two
large clusters, with the remaining samples assigned to the "B3"
subset.

```{r pbmc-68k-clustering-4, fig.width=5, fig.height=4}
rows <- which(samples_68k$cluster == "B")
fit  <- select(poisson2multinom(fit_68k),loadings = rows)
pca  <- prcomp(fit$L)$x
n    <- nrow(pca)
x    <- rep("B3",n)
pc1  <- pca[,"PC1"]
x[pc1 > -0.05] <- "B1"
x[pc1 < -0.3] <- "B2"
samples_68k[rows,"cluster"] <- x
p6 <- pca_plot_with_labels(fit,c("PC1","PC2"),x) +
      labs(fill = "cluster")
print(p6)
```

The B1 cluster can be further subdivided into clusters (B1a, B1b), with
subset B1c compresing the B1 samples that do not fit into either
cluster.

```{r pbmc-68k-clustering-5, fig.width=5, fig.height=4}
rows <- which(samples_68k$cluster == "B1")
fit  <- select(poisson2multinom(fit_68k),loadings = rows)
pca  <- prcomp(fit$L)$x
n    <- nrow(pca)
x    <- rep("B1c",n)
pc1  <- pca[,"PC1"]
pc2  <- pca[,"PC2"]
x[pc2 > -0.02 & pc1 > -0.25] <- "B1a"
x[pc1 > 0.1 & pc2 < 0.05 & pc2 > -0.225] <- "B1b"
samples_68k[rows,"cluster"] <- x
p7 <- pca_plot_with_labels(fit,c("PC1","PC2"),x) +
      labs(fill = "cluster")
print(p7)
```

Cluster A subdivides fairly neatly into two large clusters, A1 and A2.

```{r pbmc-68k-clustering-6, fig.width=5, fig.height=4}
rows <- which(samples_68k$cluster == "A")
fit  <- select(poisson2multinom(fit_68k),loadings = rows)
pca  <- prcomp(fit$L)$x
n    <- nrow(pca)
x    <- rep("A3",n)
pc2  <- pca[,"PC2"]
pc3  <- pca[,"PC3"]
x[2.5*pc3 < 0.3 - pc2] <- "A1"
x[pc3 > 0.8 - pc2] <- "A2"
samples_68k[rows,"cluster"] <- x
p7 <- pca_plot_with_labels(fit,c("PC2","PC3"),x) +
      labs(fill = "cluster")
print(p7)
```

Within cluster A, the vast majority of the samples are assigned to the
A1 subcluster:

```{r pbmc-68k-clustering-7}
table(x)
```

In summary, we have subdivided these data into 9 subsets:

```{r pbmc-68k-clustering-8}
samples_68k$cluster <- factor(samples_68k$cluster)
table(samples_68k$cluster)
```

The wide range in the sizes of these clusters is notable; the smallest
cluster (C) is less than 1% the size of the largest (A1). By contrast,
community detection methods such as the Louvain algorithm are
preferentially biased toward more uniformly sized clusters (this is a
known limitation of community detection methods).

The structure plot summarizes the topic proportions in each of these 9
subsets:

```{r pbmc-68k-structure-plot, fig.width=7.5, fig.height=1.5}
set.seed(1)
pbmc_68k_topic_colors <- c("yellow","lightskyblue","salmon",
                           "firebrick","royalblue","olivedrab")
pbmc_68k_topics <- c(2,5,1,3,4,6)
rows <- sort(c(sample(which(samples_68k$cluster == "A1"),1200),
               sample(which(samples_68k$cluster == "A2"),500),
               sample(which(samples_68k$cluster == "A3"),300),
               sample(which(samples_68k$cluster == "B1a"),500),
               sample(which(samples_68k$cluster == "B1b"),300),
               sample(which(samples_68k$cluster == "B1c"),300),
               sample(which(samples_68k$cluster == "B2"),300),
               which(samples_68k$cluster == "B3"),
               which(samples_68k$cluster == "C")))
p8 <- structure_plot(select(poisson2multinom(fit_68k),loadings = rows),
                     grouping = samples_68k[rows,"cluster"],
                     topics = pbmc_68k_topics,
   				     colors = pbmc_68k_topic_colors[pbmc_68k_topics],
                     perplexity = c(100,100,50,100,80,80,80,80,50),
                     n = Inf,gap = 32,num_threads = 4,verbose = FALSE)
print(p8)
```

These subsets do not align as closely with the cell-type labeling
inferred by Zheng et al (2017), which is not surprising considering
that this labeling is based on the FACS-purified data set.

```{r pbmc-68k-clusters-vs-celltypes,, fig.width=4.5, fig.height=3.5}
pdat <- as.data.frame(with(samples_68k,table(celltype,cluster)))
ggplot(pdat,aes(x = cluster,y = celltype,size = Freq)) +
  geom_point(color = "dodgerblue",na.rm = TRUE,show.legend = FALSE) +
  ylim(rev(levels(samples_purified$celltype))) +
  theme_cowplot(font_size = 10)
```

A few notes about these results:

+ As in the purified fit, here we identify a B-cells cluster (B) and
  topic (5) that closely match.

+ We also identify what is most likely a cluster of CD34+ cells (C),
  although the corresponding topic (6) is not distinctive to this
  cluster, so it remains to be seen if topic 6 also characterises
  CD34+ cells.

+ Unlike the FACS-purified data, don't identify a clear-cut cluster
  for NK cells; the NK cells are mixed in with the T-cells (subset
  A1). NK cells will emerge only after subsequent analysis of topic 3.

+ Some of the distinct clusters (e.g., B1a, B1b, B2) are characterized
  by mixtures of topics, so if these clusters do indeed correspond to
  interesting cell types, analyzing the topics alone may not shed
  light onto these cell types.

In summary, the topics and clusters seem to offer very much
complementary biological insights, although subsequent analysis is
needed to determine what these insights are.

[zheng-2017]: https://doi.org/10.1038/ncomms14049
