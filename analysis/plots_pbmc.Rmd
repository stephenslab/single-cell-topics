---
title: Visualize and interpret topics in PBMC data
author: Peter Carbonetto
output: workflowr::wflow_html
---

**TO DO:** Add introductory text here.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below.

```{r load-pkgs, message=FALSE}
library(dplyr)
library(fastTopics)
library(ggplot2)
library(cowplot)
source("../code/plots.R")
```

Load the sample annotations. (The count data are no longer needed at this
stage of the analysis.)

```{r load-data}
load("../data/pbmc_purified.RData")
samples_purified <- samples
load("../data/pbmc_68k.RData")
samples_68k <- samples
rm(genes,counts)
```

Load the $k = 6$ Poisson NMF model fits for both PBMC data sets. To
reduce confusion, topics in the `fit_68k` Poisson NMF model fit are
reordered to better align with the topics in `fit_purified` Poisson
NMF model fit.

```{r load-fits}
fit_purified <-
  readRDS("../output/pbmc-purified/rds/fit-pbmc-purified-scd-ex-k=6.rds")$fit
fit_68k <- readRDS("../output/pbmc-68k/rds/fit-pbmc-68k-scd-ex-k=6.rds")$fit
cols      <- c(1,6,5,3,4,2)
fit_68k$F <- fit_68k$F[,cols]
fit_68k$L <- fit_68k$L[,cols]
colnames(fit_68k$F) <- paste0("k",1:6)
colnames(fit_68k$L) <- paste0("k",1:6)
```

PCs 1 and 2 in mixture of FACS-purified PBMC data:

```{r pbmc-purified-pca-basic, fig.width=4.2, fig.height=4}
p1 <- basic_pca_plot(fit_purified,c("PC1","PC2"))
print(p1)
```

**TO DO:** Add text here.

```{r pbmc-purified-clustering-1}
pca_purified <- prcomp(poisson2multinom(fit_purified)$L)$x
n   <- nrow(pca_purified)
x   <- rep("c3",n)
pc1 <- pca_purified[,"PC1"]
pc2 <- pca_purified[,"PC2"]
x[pc1 + 0.2 > pc2] <- "c1"
x[pc2 > 0.25] <- "c2"
x[(pc1 + 0.4)^2 + (pc2 + 0.1)^2 < 0.07] <- "c3"
samples_purified$cluster <- factor(x)
```

PCs 1 and 2 in mixture of FACS-purified PBMC data:

```{r pbmc-purified-clustering-2, fig.width=4.5, fig.height=4}
purified_cluster_colors <- c("tomato","dodgerblue","lightskyblue")
p2 <- pca_plot_with_labels(fit_purified,c("PC1","PC2"),
                           samples_purified$cluster,
                           purified_cluster_colors) +
      labs(fill = "cluster")
print(p2)
```

Most of the samples are in the first (red) cluster:

```{r pbmc-purified-clustering-3}
print(table(samples_purified$cluster))
```

PCs 3 and 4 in 68k PBMC data:

```{r pbmc-68k-pca-1, eval=FALSE}
p3 <- pca_plot(poisson2multinom(fit_68k),pcs = 3:4,k = 2:3)
```

Comparison to Zheng et al (2017) cell-type labeling of the
FACS-purified PBMC data:

```{r pbmc-purified-pca-with-celltypes, eval=FALSE}
purified_celltype_colors <-
  c("dodgerblue",  # CD19+ B
    "forestgreen", # CD14+ Monocyte
    "lightskyblue",# CD34+
    "plum",        # CD4+ T Helper2
    "slategray",   # CD56+ NK
    "tomato",      # CD8+ Cytotoxic T
    "gold",        # CD4+/CD45RO+ Memory
    "magenta",     # CD8+/CD45RA+ Naive Cytotoxic
    "darkorange",  # CD4+/CD45RA+/CD25- Naive T
    "yellowgreen") # CD4+/CD25 T Reg
p4 <- pca_plot_with_labels(fit_purified,c("PC1","PC2"),
                           samples_purified$celltype,
                           purified_celltype_colors) + labs(fill = "celltype")
p5 <- pca_plot_with_labels(fit_purified,c("PC4","PC5"),
                           samples_purified$celltype,
                           purified_celltype_colors) + labs(fill = "celltype")
```

Loadings plot:

```{r loading-plot, eval=FALSE}
loadings_plot(poisson2multinom(fit_purified),samples_purified$celltype)
loadings_plot(poisson2multinom(fit_68k),samples_68k$celltype)
```

PCA plot:

```{r pca-plot, eval=FALSE}
clrs <- c("forestgreen",  # CD14+ Monocyte
          "dodgerblue",   # CD19+ B
          "darkmagenta",  # CD34+"
          "yellowgreen",  # CD4+ T Helper2
          "gold",         # CD4+/CD25 T Reg
          "limegreen",    # CD4+/CD45RA+/CD25- Naive T
          "orange",       # CD4+/CD45RO+ Memory"
          "gray",         # CD56+ NK
          "tomato",       # CD8+ Cytotoxic T
          "magenta",      # CD8+/CD45RA+ Naive Cytotoxic"
          "darkblue")     # Dendritic"
fit2 <- poisson2multinom(fit)
pca  <- prcomp(fit2$L)
pdat <- cbind(samples,pca$x)
ggplot(pdat,aes(x = PC3,y = PC4,fill = celltype)) +
  geom_point(shape = 21,color = "white",size = 1.5) +
  scale_fill_manual(values = clrs) +
  theme_cowplot(font_size = 10)
```

t-SNE plot:

```{r tsne-plot, eval=FALSE}
set.seed(1)
p2 <- tsne_plot(fit,n = 8000,num_threads = 4)
```

Differential count analysis:

```{r diff-count-analysis, eval=FALSE}
diff_count_res <- diff_count_analysis(fit,counts)
```

Volcano plots:

```{r volcano-plots, eval=FALSE}
p3 <- volcano_plot(diff_count_res,labels = genes$symbol,
                   label_above_quantile = 0.995)
```

Structure plots:

```{r structure-plots, eval=FALSE}
set.seed(1)
fit2 <- select(poisson2multinom(fit),
               loadings = which(samples$celltype == "CD19+ B"))
p4   <- structure_plot(fit2,n = 2000,num_threads = 4) # B-cells.
set.seed(1)
fit2 <- select(poisson2multinom(fit),
               loadings = which(samples$celltype == "CD56+ NK"))
p5   <- structure_plot(fit2,n = 2000,num_threads = 4) # NK cells.
set.seed(1)
fit2 <- select(poisson2multinom(fit),
               loadings = which(samples$celltype == "CD34+"))
p6   <- structure_plot(fit2,num_threads = 4,perplexity = 50) # CD34+ cells
set.seed(1)
fit2 <- select(poisson2multinom(fit),
               loadings = which(samples$celltype == "CD14+ Monocyte"))
p7   <- structure_plot(fit2,num_threads = 4) # CD14+ monocytes
set.seed(1)
fit2 <- select(poisson2multinom(fit),
               loadings = which(samples$celltype == "Dendritic"))
p8   <- structure_plot(fit2,num_threads = 4) # dendritic cells
plot_grid(p7,p8,nrow = 2)
set.seed(1)
fit2 <- select(poisson2multinom(fit),
               loadings = which(samples$celltype == "CD4+ T Helper2"))
p9   <- structure_plot(fit2,num_threads = 4,perplexity = 30) +
          ggtitle("CD4+ T Helper2") +
set.seed(1)
fit2 <- select(poisson2multinom(fit),
          loadings = which(samples$celltype == "CD4+/CD45RA+/CD25- Naive T"))
p10  <- structure_plot(fit2,num_threads = 4) +
          ggtitle("CD4+/CD45RA+/CD25- Naive T")
set.seed(1)
fit2 <- select(poisson2multinom(fit),
               loadings = which(samples$celltype == "CD4+/CD45RO+ Memory"))
p11  <- structure_plot(fit2,num_threads = 4) +
  	      ggtitle("CD4+/CD45RO+ Memory")
set.seed(1)
fit2 <- select(poisson2multinom(fit),
               loadings = which(samples$celltype == "CD4+/CD25 T Reg"))
p12  <- structure_plot(fit2,num_threads = 4) +
          ggtitle("CD4+/CD25 T Reg")
fit2 <- select(poisson2multinom(fit),
          loadings = which(samples$celltype == "CD8+/CD45RA+ Naive Cytotoxic"))
p13  <- structure_plot(fit2,num_threads = 4) +
          ggtitle("CD8+/CD45RA+ Naive Cytotoxic")
fit2 <- select(poisson2multinom(fit),
          loadings = which(samples$celltype == "CD8+ Cytotoxic T"))
p14  <- structure_plot(fit2,num_threads = 4) +
          ggtitle("CD8+ Cytotoxic T")
plot_grid(p9,p10,p11,p12,p13,p14,nrow = 6)
```

Another structure plot:

```{r more-structure-plots, eval=FALSE}
p15 <- structure_plot(fit,num_threads = 4)
```
