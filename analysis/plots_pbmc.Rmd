---
title: Visualize and interpret topics in PBMC data
author: Peter Carbonetto
output: workflowr::wflow_html
---

*TO DO: Add introductory text here.*

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below.

```{r load-pkgs, message=FALSE}
library(dplyr)
library(fastTopics)
library(ggplot2)
library(cowplot)
library(Ternary)
source("../code/plots.R")
```

Load the sample annotations. (The count data are no longer needed at this
stage of the analysis, so I have removed them.)

```{r load-data}
load("../data/pbmc_purified.RData")
samples_purified <- samples
load("../data/pbmc_68k.RData")
samples_68k <- samples
rm(genes,counts)
```

Load the $k = 6$ Poisson NMF model fits for both PBMC data sets. In
the descriptions below, I refer to these Poisson NMF model fits as the
"purified" and "68k" fits.

To aid presentation of the results, topics in the 68k fit are
reordered to better align with the topics in purified Poisson NMF fit.

```{r load-fits}
fit_purified <-
  readRDS("../output/pbmc-purified/rds/fit-pbmc-purified-scd-ex-k=6.rds")$fit
fit_68k <- readRDS("../output/pbmc-68k/rds/fit-pbmc-68k-scd-ex-k=6.rds")$fit
cols      <- c(4,1,5,3,6,2)
fit_68k$F <- fit_68k$F[,cols]
fit_68k$L <- fit_68k$L[,cols]
colnames(fit_68k$F) <- paste0("k",1:6)
colnames(fit_68k$L) <- paste0("k",1:6)
```

We begin by exploring structure in the data as inferred by the topic
model. We will visualize this structure by plotting principal
components (PCs) of the topic proportions. Although PCA is simple, we
will see that it quite effective, and avoids the complications of
nonlinear dimensionality reduction techniques such as t-SNE and UMAP.

We begin with the mixture of FACS-purified PBMC data.

```{r pbmc-purified-clustering-1}
fit <- poisson2multinom(fit_purified)
pca <- prcomp(fit$L)$x
```

Three large clusters are clearly evident from first two PCs (there is
also finer-scale structure which we will examine shortly). We label
these clusters as "A", "B" and "C".

```{r pbmc-purified-clustering-2, fig.width=5, fig.height=4}
n   <- nrow(pca)
x   <- rep("C",n)
pc1 <- pca[,"PC1"]
pc2 <- pca[,"PC2"]
x[pc1 + 0.2 > pc2] <- "A"
x[pc2 > 0.25] <- "B"
x[(pc1 + 0.4)^2 + (pc2 + 0.1)^2 < 0.07] <- "C"
samples_purified$cluster <- x
p1 <- pca_plot_with_labels(fit_purified,c("PC1","PC2"),
                           samples_purified$cluster) +
      labs(fill = "cluster")
print(p1)
```

Most of the samples are in cluster A:

```{r pbmc-purified-clustering-3}
table(x)
```

In cluster C, there are two well-defined subclusters, labeled "C1" and
"C2". There are other possible subclusters that are less defined, but
here we focus on the most obvious clustering:

```{r pbmc-purified-clustering-4, fig.width=5, fig.height=4}
rows <- which(samples_purified$cluster == "C")
fit  <- select(poisson2multinom(fit_purified),loadings = rows)
pca  <- prcomp(fit$L)$x
n    <- nrow(pca)
x    <- rep("C3",n)
pc1  <- pca[,1]
pc2  <- pca[,2]
x[pc1 < 0 & pc2 < 0.4] <- "C1"
x[pc1 > 0.5 & pc2 < 0.3] <- "C2"
samples_purified$cluster[rows] <- x
p5 <- pca_plot_with_labels(fit,c("PC1","PC2"),x) +
      labs(fill = "cluster")
print(p5)
```

The two subclusters C1 and C2 account for most of the samples:

```{r pbmc-purified-clustering-5}
table(x)
```

Let's now look more closely at cluster A. There is a large, much less
distinct subcluster, which we label as "A1". Otherwise, there are no
other clearly well-defined clusters.

```{r pbmc-purified-clustering-6, fig.width=5, fig.height=4}
rows <- which(samples_purified$cluster == "A")
fit  <- select(poisson2multinom(fit_purified),loadings = rows)
pca  <- prcomp(fit$L)$x
n    <- nrow(fit$L)
x    <- rep("A2",n)
pc1  <- pca[,1]
pc2  <- pca[,2]
x[pc1 > 0.58 - pc2 | pc1 > 0.7] <- "A1"
samples_purified$cluster[rows] <- x
p6 <- pca_plot_with_labels(fit,c("PC1","PC2"),x) +
      labs(fill = "cluster")
print(p6)
```

In summary, we have subdivided these data into 6 clusters:

```{r pbmc-purified-clustering-7}
samples_purified$cluster <- factor(samples_purified$cluster)
table(samples_purified$cluster)
```

The Structure plot gives a compact visual summary of topic proportions
in each of these six clusters:

```{r pbmc-purified-structure-plot, fig.width=7, fig.height=1.5}
set.seed(1)
pbmc_purified_topics       <- c(2,5,1,3,4,6)
pbmc_purified_topic_colors <- c("gold","forestgreen","dodgerblue",
                                "gray","greenyellow","magenta")
rows <- sort(c(sample(which(samples_purified$cluster == "A1"),250),
               sample(which(samples_purified$cluster == "A2"),750),
               sample(which(samples_purified$cluster == "B"),250),
               sample(which(samples_purified$cluster == "C1"),250),
               sample(which(samples_purified$cluster == "C2"),250),
               sample(which(samples_purified$cluster == "C3"),200)))
p3 <- structure_plot(select(poisson2multinom(fit_purified),loadings = rows),
                     grouping = samples_purified[rows,"cluster"],
                     topics = pbmc_purified_topics,
                     colors = pbmc_purified_topic_colors[pbmc_purified_topics],
                     gap = 40,num_threads = 4,verbose = FALSE)
print(p3)
```

Compare these clusters with the Zheng *et al* (2017) cell-type
labeling:

```{r pbmc-purified-clusters-vs-celltypes}
with(samples_purified,table(celltype,cluster))
```

Next, we turn to the 68k fit.

```{r pbmc-68k-clustering-1}
fit <- poisson2multinom(fit_68k)
pca <- prcomp(fit$L)$x
```

In this case, we find least three distinct clusters in the projection
onto PCs 3 and 4. We label these clusters "A", "B" and "C", as above,
but this labeling does not imply a connection between the two sets
of clusters.

```{r pbmc-68k-clustering-2, fig.width=5, fig.height=4}
n <- nrow(pca)
x <- rep("A",n)
pc3 <- pca[,"PC3"]
pc4 <- pca[,"PC4"]
x[pc4 > 0.13 | 0.17 - pc3/1.9 < pc4] <- "B"
x[pc4 > 0.75] <- "C"
samples_68k$cluster <- x
p7 <- pca_plot_with_labels(fit_68k,c("PC3","PC4"),x) +
      labs(fill = "cluster")
print(p7)
```

The vast majority of the cells are in cluster A:

```{r pbmc-68k-clustering-3}
table(samples_68k$cluster)
```

Looking more closely at cluster B...

```{r pbmc-68k-clustering-4, fig.width=4, fig.height=4, eval=FALSE}
L    <- poisson2multinom(fit_68k)$L
pdat <- cbind(L,samples_68k["celltype"])
rows <- which(samples_68k$cluster == "c2")
levels(pdat$celltype) <- pbmc_68k_celltype_colors
TernaryPlot(alab = "k3",blab = "k5",clab = "k6",
            grid.col = "gainsboro",grid.minor.lines = 0)
TernaryPoints(pdat[rows,c(3,5,6)],pch = 21,cex = 0.65,col = "white",
  			  bg = as.character(pdat[rows,"celltype"]))
```

**TO DO:** Add text here.

```{r pbmc-68k-structure-plot, fig.width=7, fig.height=2, eval=FALSE}
set.seed(1)
pbmc_68k_topics       <- c(2,5,1,3,4,6)
pbmc_68k_topic_colors <- c("darkorange","olivedrab","dodgerblue",
                           "gray","royalblue","magenta")
rows <- sort(c(sample(which(samples_68k$cluster == "c1"),1400),
               sample(which(samples_68k$cluster == "c2"),500),
               which(samples_68k$cluster == "c3")))
p4 <- structure_plot(select(poisson2multinom(fit_68k),loadings = rows),
                     grouping = samples_68k[rows,"cluster"],
                     topics = pbmc_68k_topics,
                     colors = pbmc_68k_topic_colors[pbmc_68k_topics],
                     gap = 40,num_threads = 4,verbose = FALSE)
print(p4)
```

**TO DO:** Before comparing to Zheng et al (2017) labeling, do more
manual identification of clusters from the PCA plots.

Comparison to Zheng et al (2017) cell-type labeling of the
FACS-purified PBMC data. In `fit_purified`, cluster 2 captures
B-cells; cluster 3 is almost exclusively CD34+ and CD14+ monocytes:

Now let's look more closely at cluster 1 in `fit_purified`:

```{r pbmc-purified-ternary-plot-c1, fig.width=4, fig.height=4, eval=FALSE}
par(mar = c(0,0,0,0))
rows <- which(samples_purified$cluster == "c1")
TernaryPlot(alab = "k1",blab = "k4",clab = "k6",
            grid.col = "gainsboro",grid.minor.lines = 0)
TernaryPoints(pdat[rows,c(1,4,6)],pch = 21,cex = 0.65,col = "white",
  			  bg = as.character(pdat[rows,"celltype"]))
```

In `fit_68k`, cluster 2 mostly consists of CD14+ monocyte and
dendritic cells, whereas cluster 3 is a small population of CD34+
cells.

```{r pbmc-68k-vs-celltypes, eval=FALSE}
with(samples_68k,table(celltype,cluster))
```

Finally, let's look more closely at cluster 1 in `fit_68k`:

```{r pbmc-68k-ternary-plot-c1, fig.width=4, fig.height=4, eval=FALSE}
par(mar = c(0,0,0,0))
rows <- which(samples_68k$cluster == "c1")
TernaryPlot(alab = "k2",blab = "k4",clab = "k6",
            grid.col = "gainsboro",grid.minor.lines = 0)
TernaryPoints(pdat[rows,c(2,4,6)],pch = 21,cex = 0.65,col = "white",
  			  bg = as.character(pdat[rows,"celltype"]))
```

```{r pbmc-purified-pca-with-celltypes, eval=FALSE}
p4 <- pca_plot_with_labels(fit_purified,c("PC1","PC2"),
                           samples_purified$celltype,
                           purified_celltype_colors) + labs(fill = "celltype")
p5 <- pca_plot_with_labels(fit_purified,c("PC4","PC5"),
                           samples_purified$celltype,
                           purified_celltype_colors) + labs(fill = "celltype")
```

```{r, eval=FALSE}
pbmc_purified_celltype_colors <-
  c("dodgerblue",  # CD19+ B
    "forestgreen", # CD14+ Monocyte
    "palegreen",   # CD34+
    "plum",        # CD4+ T Helper2
    "gray",        # CD56+ NK
    "tomato",      # CD8+ Cytotoxic T
    "gold",        # CD4+/CD45RO+ Memory
    "magenta",     # CD8+/CD45RA+ Naive Cytotoxic
    "darkorange",  # CD4+/CD45RA+/CD25- Naive T
    "yellowgreen") # CD4+/CD25 T Reg
```
	
Loadings plot:

```{r loading-plot, eval=FALSE}
loadings_plot(poisson2multinom(fit_purified),samples_purified$celltype)
loadings_plot(poisson2multinom(fit_68k),samples_68k$celltype)
```

PCA plot:

```{r pca-plot, eval=FALSE}
clrs <- c("forestgreen",  # CD14+ Monocyte
          "dodgerblue",   # CD19+ B
          "darkmagenta",  # CD34+"
          "yellowgreen",  # CD4+ T Helper2
          "gold",         # CD4+/CD25 T Reg
          "limegreen",    # CD4+/CD45RA+/CD25- Naive T
          "orange",       # CD4+/CD45RO+ Memory"
          "gray",         # CD56+ NK
          "tomato",       # CD8+ Cytotoxic T
          "magenta",      # CD8+/CD45RA+ Naive Cytotoxic"
          "darkblue")     # Dendritic"
fit2 <- poisson2multinom(fit)
pca  <- prcomp(fit2$L)
pdat <- cbind(samples,pca$x)
ggplot(pdat,aes(x = PC3,y = PC4,fill = celltype)) +
  geom_point(shape = 21,color = "white",size = 1.5) +
  scale_fill_manual(values = clrs) +
  theme_cowplot(font_size = 10)
```

t-SNE plot:

```{r tsne-plot, eval=FALSE}
set.seed(1)
p2 <- tsne_plot(fit,n = 8000,num_threads = 4)
```

Differential count analysis:

```{r diff-count-analysis, eval=FALSE}
diff_count_res <- diff_count_analysis(fit,counts)
```

Volcano plots:

```{r volcano-plots, eval=FALSE}
p3 <- volcano_plot(diff_count_res,labels = genes$symbol,
                   label_above_quantile = 0.995)
```

Structure plots:

```{r structure-plots, eval=FALSE}
set.seed(1)
fit2 <- select(poisson2multinom(fit),
               loadings = which(samples$celltype == "CD19+ B"))
p4   <- structure_plot(fit2,n = 2000,num_threads = 4) # B-cells.
set.seed(1)
fit2 <- select(poisson2multinom(fit),
               loadings = which(samples$celltype == "CD56+ NK"))
p5   <- structure_plot(fit2,n = 2000,num_threads = 4) # NK cells.
set.seed(1)
fit2 <- select(poisson2multinom(fit),
               loadings = which(samples$celltype == "CD34+"))
p6   <- structure_plot(fit2,num_threads = 4,perplexity = 50) # CD34+ cells
set.seed(1)
fit2 <- select(poisson2multinom(fit),
               loadings = which(samples$celltype == "CD14+ Monocyte"))
p7   <- structure_plot(fit2,num_threads = 4) # CD14+ monocytes
set.seed(1)
fit2 <- select(poisson2multinom(fit),
               loadings = which(samples$celltype == "Dendritic"))
p8   <- structure_plot(fit2,num_threads = 4) # dendritic cells
plot_grid(p7,p8,nrow = 2)
set.seed(1)
fit2 <- select(poisson2multinom(fit),
               loadings = which(samples$celltype == "CD4+ T Helper2"))
p9   <- structure_plot(fit2,num_threads = 4,perplexity = 30) +
          ggtitle("CD4+ T Helper2") +
set.seed(1)
fit2 <- select(poisson2multinom(fit),
          loadings = which(samples$celltype == "CD4+/CD45RA+/CD25- Naive T"))
p10  <- structure_plot(fit2,num_threads = 4) +
          ggtitle("CD4+/CD45RA+/CD25- Naive T")
set.seed(1)
fit2 <- select(poisson2multinom(fit),
               loadings = which(samples$celltype == "CD4+/CD45RO+ Memory"))
p11  <- structure_plot(fit2,num_threads = 4) +
  	      ggtitle("CD4+/CD45RO+ Memory")
set.seed(1)
fit2 <- select(poisson2multinom(fit),
               loadings = which(samples$celltype == "CD4+/CD25 T Reg"))
p12  <- structure_plot(fit2,num_threads = 4) +
          ggtitle("CD4+/CD25 T Reg")
fit2 <- select(poisson2multinom(fit),
          loadings = which(samples$celltype == "CD8+/CD45RA+ Naive Cytotoxic"))
p13  <- structure_plot(fit2,num_threads = 4) +
          ggtitle("CD8+/CD45RA+ Naive Cytotoxic")
fit2 <- select(poisson2multinom(fit),
          loadings = which(samples$celltype == "CD8+ Cytotoxic T"))
p14  <- structure_plot(fit2,num_threads = 4) +
          ggtitle("CD8+ Cytotoxic T")
plot_grid(p9,p10,p11,p12,p13,p14,nrow = 6)
```

Another structure plot:

```{r more-structure-plots, eval=FALSE}
p15 <- structure_plot(fit,num_threads = 4)
```
