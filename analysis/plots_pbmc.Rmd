---
title: Visualize and interpret topics in PBMC data
author: Peter Carbonetto
output: workflowr::wflow_html
---

*TO DO: Add introductory text here.*

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below.

```{r load-pkgs, message=FALSE}
library(dplyr)
library(fastTopics)
library(ggplot2)
library(cowplot)
library(Ternary)
source("../code/plots.R")
```

Load the sample annotations. (The count data are no longer needed at this
stage of the analysis, so I have removed them.)

```{r load-data}
load("../data/pbmc_purified.RData")
samples_purified <- samples
load("../data/pbmc_68k.RData")
samples_68k <- samples
rm(genes,counts)
```

Load the $k = 6$ Poisson NMF model fits for both PBMC data sets. In
the descriptions below, I refer to these Poisson NMF model fits as the
"purified" and "68k" fits.

```{r load-fits}
fit_purified <-
  readRDS("../output/pbmc-purified/rds/fit-pbmc-purified-scd-ex-k=6.rds")$fit
fit_68k <- readRDS("../output/pbmc-68k/rds/fit-pbmc-68k-scd-ex-k=6.rds")$fit
colnames(fit_68k$F) <- paste0("k",1:6)
colnames(fit_68k$L) <- paste0("k",1:6)
```

We begin by exploring structure in the data as inferred by the topic
model. We will visualize this structure by plotting principal
components (PCs) of the topic proportions. Although PCA is simple, we
will see that it quite effective, and avoids the complications of the
popular t-SNE and UMAP nonlinear dimensionality reduction methods.

We begin with the mixture of FACS-purified PBMC data.

```{r pbmc-purified-clustering-1}
fit <- poisson2multinom(fit_purified)
pca <- prcomp(fit$L)$x
```

Three large clusters are clearly evident from first two PCs (there is
also finer-scale structure which we will examine below). We label
these clusters simply as "A", "B" and "C".

```{r pbmc-purified-clustering-2, fig.width=5, fig.height=4}
n   <- nrow(pca)
x   <- rep("C",n)
pc1 <- pca[,"PC1"]
pc2 <- pca[,"PC2"]
x[pc1 + 0.2 > pc2] <- "A"
x[pc2 > 0.25] <- "B"
x[(pc1 + 0.4)^2 + (pc2 + 0.1)^2 < 0.07] <- "C"
samples_purified$cluster <- x
p1 <- pca_plot_with_labels(fit_purified,c("PC1","PC2"),
                           samples_purified$cluster) +
      labs(fill = "cluster")
print(p1)
```

Most of the samples are in cluster A:

```{r pbmc-purified-clustering-3}
table(x)
```

In cluster C, there are two well-defined subclusters, which we label
"C1" and "C2". There are perhaps other subclusters that are less
defined, but we here we ignore this more subtle structure, and focus
on the most obvious clusters:

```{r pbmc-purified-clustering-4, fig.width=5, fig.height=4}
rows <- which(samples_purified$cluster == "C")
fit  <- select(poisson2multinom(fit_purified),loadings = rows)
pca  <- prcomp(fit$L)$x
n    <- nrow(pca)
x    <- rep("C3",n)
pc1  <- pca[,1]
pc2  <- pca[,2]
x[pc1 < 0 & pc2 < 0.4] <- "C1"
x[pc1 > 0.5 & pc2 < 0.3] <- "C2"
samples_purified[rows,"cluster"] <- x
p2 <- pca_plot_with_labels(fit,c("PC1","PC2"),x) +
      labs(fill = "cluster")
print(p2)
```

The two subclusters, C1 and C2, account for most of the samples in
cluster C:

```{r pbmc-purified-clustering-5}
table(x)
```

Let's now look more closely at cluster A. There is a large, much less
distinct subcluster, which we label as "A1". Otherwise, there are no
other clearly distinct clusters.

```{r pbmc-purified-clustering-6, fig.width=5, fig.height=4}
rows <- which(samples_purified$cluster == "A")
fit  <- select(poisson2multinom(fit_purified),loadings = rows)
pca  <- prcomp(fit$L)$x
n    <- nrow(fit$L)
x    <- rep("A2",n)
pc1  <- pca[,1]
pc2  <- pca[,2]
x[pc1 > 0.58 - pc2 | pc1 > 0.7] <- "A1"
samples_purified[rows,"cluster"] <- x
p3 <- pca_plot_with_labels(fit,c("PC1","PC2"),x) +
      labs(fill = "cluster")
print(p3)
```

In summary, we have subdivided these data into 6 clusters:

```{r pbmc-purified-clustering-7}
samples_purified$cluster <- factor(samples_purified$cluster)
table(samples_purified$cluster)
```

The Structure plot provides a visual summary of topic proportions
in each of these six clusters:

```{r pbmc-purified-structure-plot, fig.width=7, fig.height=1.5}
set.seed(1)
pbmc_purified_topic_colors <- c("gold","forestgreen","dodgerblue",
                                "gray","greenyellow","magenta")
pbmc_purified_topics <- c(2,5,1,3,4,6)
rows <- sort(c(sample(which(samples_purified$cluster == "A1"),250),
               sample(which(samples_purified$cluster == "A2"),1200),
               sample(which(samples_purified$cluster == "B"),250),
               sample(which(samples_purified$cluster == "C1"),250),
               sample(which(samples_purified$cluster == "C2"),250),
               sample(which(samples_purified$cluster == "C3"),200)))
p4 <- structure_plot(select(poisson2multinom(fit_purified),loadings = rows),
                     grouping = samples_purified[rows,"cluster"],
                     topics = pbmc_purified_topics,
                     colors = pbmc_purified_topic_colors[pbmc_purified_topics],
                     gap = 40,num_threads = 4,verbose = FALSE)
print(p4)
```

Out of the 6 topics, 4 of them ($k = 2, 3, 4, 5$) align closely with
the clusters (labeled A1, B, C1, C2). Indeed, they also align closely
with the FACS-purified data sets:

```{r pbmc-purified-clusters-vs-celltypes}
with(samples_purified,table(celltype,cluster))
```

For example, cluster B corresponds almost perfectly to the B-cell data
set, and the largest cluster---cluster A2---is comprised of the T-cell
data sets. It is also interesting that many of the samples labeled as
"CD34+" are not assigned to the CD34+ cluster (C1), which probably
reflects the fact that the this population was much less pure (45%)
than the others, and so probably contained other cell types.

Cluster C3 is a heterogeneous cluster that we do not investigate
further. Cluster A2---see also the PCA plot above---is a clear example
where topic modeling is more appropriate than clustering because any
additional clustering of the data will be arbitrary.

Next, we turn to the 68k fit.

```{r pbmc-68k-clustering-1}
fit <- poisson2multinom(fit_68k)
pca <- prcomp(fit$L)$x
```

In this case, we find least three distinct clusters in the projection
onto PCs 3 and 4. We label these clusters "A", "B" and "C", as above,
but this labeling does not imply a connection between the two sets
of clusters.

```{r pbmc-68k-clustering-2, fig.width=5, fig.height=4}
n <- nrow(pca)
x <- rep("A",n)
pc3 <- pca[,"PC3"]
pc4 <- pca[,"PC4"]
x[pc4 < -0.13 | pc3/1.9 - 0.17 > pc4] <- "B"
x[pc4 < -0.75] <- "C"
samples_68k$cluster <- x
p5 <- pca_plot_with_labels(fit_68k,c("PC3","PC4"),x) +
      labs(fill = "cluster")
print(p5)
```

The vast majority of the cells are in cluster A:

```{r pbmc-68k-clustering-3}
table(samples_68k$cluster)
```

Looking more closely at cluster B:

```{r pbmc-68k-clustering-4, fig.width=5, fig.height=4}
rows <- which(samples_68k$cluster == "B")
fit  <- select(poisson2multinom(fit_68k),loadings = rows)
pca  <- prcomp(fit$L)$x
n    <- nrow(pca)
x    <- rep("B3",n)
pc1  <- pca[,"PC1"]
x[pc1 > -0.05] <- "B1"
x[pc1 < -0.3] <- "B2"
samples_68k[rows,"cluster"] <- x
p6 <- pca_plot_with_labels(fit,c("PC1","PC2"),x) +
      labs(fill = "cluster")
print(p6)
```

Looking more closely at cluster A:

```{r pbmc-68k-clustering-5, fig.width=5, fig.height=4}
rows <- which(samples_68k$cluster == "A")
fit  <- select(poisson2multinom(fit_68k),loadings = rows)
pca  <- prcomp(fit$L)$x
n    <- nrow(pca)
x    <- rep("A3",n)
pc2  <- pca[,"PC2"]
pc3  <- pca[,"PC3"]
x[2.5*pc3 < 0.3 - pc2] <- "A1"
x[pc3 > 0.8 - pc2] <- "A2"
samples_68k[rows,"cluster"] <- x
p7 <- pca_plot_with_labels(fit,c("PC2","PC3"),x) +
      labs(fill = "cluster")
print(p7)
```

Within cluster A, the vast majority of the samples are assigned to the
A1 subcluster:

```{r pbmc-68k-clustering-6}
table(x)
```

In summary, we have subdivided these data into 7 clusters:

```{r pbmc-68k-clustering-7}
samples_68k$cluster <- factor(samples_68k$cluster)
table(samples_68k$cluster)
```

**TO DO:** Add text here.

```{r pbmc-68k-structure-plot, fig.width=7, fig.height=1.5}
set.seed(1)
pbmc_68k_topic_colors <- c("gold","lightskyblue","dodgerblue",
                           "gray","forestgreen","magenta")
pbmc_68k_topics <- c(2,5,1,3,4,6)
rows <- sort(c(sample(which(samples_68k$cluster == "A1"),1200),
               sample(which(samples_68k$cluster == "A2"),500),
               sample(which(samples_68k$cluster == "A3"),300),
               sample(which(samples_68k$cluster == "B1"),500),
               sample(which(samples_68k$cluster == "B2"),300),
               which(samples_68k$cluster == "B3"),
               which(samples_68k$cluster == "C")))
p8 <- structure_plot(select(poisson2multinom(fit_68k),loadings = rows),
                     grouping = samples_68k[rows,"cluster"],
                     topics = pbmc_68k_topics,
                     colors = pbmc_68k_topic_colors[pbmc_68k_topics],
                     gap = 40,num_threads = 4,verbose = FALSE)
print(p8)
```

Comparison to Zheng et al (2017) cell-type labeling:

```{r pbmc-68k-clusters-vs-celltypes}
with(samples_68k,table(celltype,cluster))
```
