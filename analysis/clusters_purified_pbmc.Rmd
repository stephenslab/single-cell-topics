---
title: "Identify clusters in mixture of FACS-purified PBMC data using topic model"
author: Peter Carbonetto
output: workflowr::wflow_html
---

Here we perform PCA on the topic proportions to identify clusters in
the mixture of FACS-purified PBMC data sets.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below, as well as additional
functions that we will use to generate some of the plots.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(dplyr)
library(fastTopics)
library(Rtsne)
library(uwot)
library(ggplot2)
library(cowplot)
source("../code/plots.R")
```

Load the count data.

```{r load-data}
load("../data/pbmc_purified.RData")
```

Load the $K = 6$ Poisson NMF model fit.

```{r load-fit}
fit <- readRDS(file.path("../output/pbmc-purified/rds",
                         "fit-pbmc-purified-scd-ex-k=6.rds"))$fit
```

Identify clusters from principal components
-------------------------------------------

From the PCs of the topic proportions, we define clusters for B-cells,
CD14+ cells and CD34+ cells. The remaining cells are assigned to the U
cluster ("U" for "unknown").

```{r clustering-1}
pca <- prcomp(poisson2multinom(fit)$L)$x
n   <- nrow(pca)
x   <- rep("U",n)
pc1 <- pca[,1]
pc2 <- pca[,2]
pc3 <- pca[,3]
pc4 <- pca[,4]
pc5 <- pca[,5]
x[pc2 > 0.25] <- "B"
x[pc3 < -0.2 & pc4 < 0.2] <- "CD34+"
x[(pc4 + 0.1)^2 + (pc5 - 0.8)^2 < 0.07] <- "CD14+"
```

Next, we define clusters for NK cells and dendritic cells from the top
2 PCs of the topic proportions in the U cluster.

```{r clustering-2}
rows <- which(x == "U")
n    <- length(rows)
fit2 <- select(poisson2multinom(fit),loadings = rows)
pca  <- prcomp(fit2$L)$x
y    <- rep("U",n)
pc1  <- pca[,1]
pc2  <- pca[,2]
pc3  <- pca[,3]
pc4  <- pca[,4]
y[pc1 < -0.3 & 1.1*pc1 < -pc2 - 0.57] <- "NK"
y[pc3 > 0.4 & pc4 < 0.2] <- "dendritic"
x[rows] <- y
```

Among the remaining cells, we define a cluster for CD8+ cells, noting
that this is much less distinct than the other cells. The rest are
labeled as T-cells.

```{r clustering-3}
rows <- which(x == "U")
n    <- length(rows)
fit2 <- select(poisson2multinom(fit),loadings = rows)
pca  <- prcomp(fit2$L)$x
y    <- rep("T",n)
pc1  <- pca[,1]
pc2  <- pca[,2]
y[pc1 < 0.25 & pc2 < -0.15] <- "CD8+"
x[rows] <- y
```

In summary, we have subdivided the cells into 7 subsets. This plot
shows the clustering of the cells projected onto the top two PCs:

```{r clustering-4, fig.width=7.5, fig.height=3, message=FALSE}
cluster_colors <- c("dodgerblue",  # B-cells
                    "forestgreen", # CD14+
					"darkmagenta", # CD34+ 
                    "red",         # CD8+
					"skyblue",     # dendritic
					"gray",        # NK
					"darkorange")  # T-cells
samples$cluster <- factor(x)
p1 <- pca_plot(poisson2multinom(fit),fill = samples$cluster) +
  scale_fill_manual(values = cluster_colors) +
  labs(fill = "cluster")
p2 <- pca_hexbin_plot(poisson2multinom(fit))
plot_grid(p1,p2,rel_widths = c(10,11))
```

```{r pca-plots-for-paper-1, message=FALSE, warning=FALSE, echo=FALSE}
ggsave("pca_clusters_pbmc_purified.png",p1,height = 4,width = 5,dpi = 450)
ggsave("pca_hexbin_pbmc_purified.eps",p2,height = 3,width = 4)
```

This clustering corresponds well to the Zheng *et al* (2017) FACS cell
populations, although there are some differences.

```{r clustering-5}
with(samples,table(celltype,cluster))
```

This good correspondence is also apparent when we layer the FACS cell
population labels on the PCA plots:

```{r clustering-6, fig.width=4.25, fig.height=3, message=FALSE}
facs_colors <- c("dodgerblue",  # B-cells
                 "forestgreen", # CD14+
                 "darkmagenta", # CD34+
                 "gray",        # NK cells
                 "tomato",      # cytotoxic T-cells
                 "gold")        # T-cells
x <- as.character(samples$celltype)
x[x == "CD4+ T Helper2" | x == "CD4+/CD45RO+ Memory" |
  x == "CD8+/CD45RA+ Naive Cytotoxic" | x == "CD4+/CD45RA+/CD25- Naive T" | 
  x == "CD4+/CD45RA+/CD25- Naive T" | x == "CD4+/CD25 T Reg"] <- "T cell"
x <- factor(x)
p3 <- pca_plot(poisson2multinom(fit),fill = x) +
  scale_fill_manual(values = facs_colors) +
  labs(fill = "FACS subpopulation")
print(p3)
```

This PCA plot highlights the FACS mis-labeling of the CD34+ cells:

```{r clustering-7, fig.width=4.5, fig.height=3, message=FALSE}
rows <- which(with(samples,
                   cluster == "B" |
                   cluster == "CD14+" |
                   cluster == "CD34+" |
				   cluster == "dendritic"))
p4 <- pca_plot(select(poisson2multinom(fit),loadings = rows),
               fill = x[rows,drop = FALSE]) +
  scale_fill_manual(values = facs_colors,drop = FALSE) +
  labs(fill = "FACS subpopulation")
print(p4)
```

```{r pca-plots-for-paper-2, message=FALSE, warning=FALSE, echo=FALSE}
ggsave("pca_facs_pbmc_purified.png",p3,height = 3,width = 4.25,dpi = 300)
ggsave("pca_cd34_pbmc_purified.png",p4,height = 3,width = 4.25,dpi = 300)
```

To further drive home this connection, here we layer the PCA plots
with expression of cell-type-specific genes, such as *Xxx* for B-cells:

```{r pca-plots-with-expression, width=8, height=6}
pca_ggplot_call <- function (dat, pcs, fill.type, fill.label)
  ggplot(dat,aes_string(x = pcs[1],y = pcs[2],color = "y")) +
    geom_point(shape = 20,size = 0.5) +
    labs(x = pcs[1],y = pcs[2],fill = fill.label) +
    scale_color_gradientn(na.value = "skyblue",
	                      colors=c("skyblue","gold","darkorange","magenta")) +
    theme_cowplot(font_size = 8) +
    theme(plot.title = element_text(size = 8,face = "plain"))
x   <- counts[,"ENSG00000105369"]
p5a <- pca_plot(select(poisson2multinom(fit),loadings = order(x)),
                fill = log10(sort(x)),ggplot_call = pca_ggplot_call) +
       labs(title = "CD79A (B-cells)",color = "log10(count)")
x   <- counts[,"ENSG00000163220"]
p5b <- pca_plot(select(poisson2multinom(fit),loadings = order(x)),
 	            fill = log10(sort(x)),ggplot_call = pca_ggplot_call) +
       labs(title = "S100A9 (CD14+)",color = "log10(count)")
x   <- counts[,"ENSG00000174059"]
p5c <- pca_plot(select(poisson2multinom(fit),loadings = order(x)),
                fill = log10(sort(x)),ggplot_call = pca_ggplot_call) +
       labs(title = "CD34 (CD34+)",color = "log10(count)")
x   <- counts[,"ENSG00000197992"]
p5d <- pca_plot(select(poisson2multinom(fit),loadings = order(x)),
                fill = log10(sort(x)),ggplot_call = pca_ggplot_call) +
       labs(title = "CLEC9A (dendritic)",color = "log10(count)")
x   <- counts[,"ENSG00000105374"]
p5e <- pca_plot(select(poisson2multinom(fit),loadings = order(x)),
                fill = log10(sort(x)),ggplot_call = pca_ggplot_call) +
       labs(title = "NKG7 (NK)",color = "log10(count)")
x    <- counts[,"ENSG00000167286"]
p5f <- pca_plot(select(poisson2multinom(fit),loadings = order(x)),
                fill = log10(sort(x)),ggplot_call = pca_ggplot_call) +
       labs(title = "CD3D (T-cells)",color = "log10(count)")
x   <- counts[,"ENSG00000153563"]
p5g <- pca_plot(select(poisson2multinom(fit),loadings = order(x)),
                fill = log10(sort(x)),ggplot_call = pca_ggplot_call) +
       labs(title = "CD8A (CD8+ cells)",color = "log10(count)")
plot_grid(p5a,p5b,p5c,
          p5d,p5e,p5f,
          p5g,
		  nrow = 3,ncol = 3)
```

```{r pca-expression-plots-for-paper, echo=FALSE}
ggsave("pca_expression_pbmc_purified.png",
       plot_grid(p5a,p5b,p5c,p5d,p5e,p5f,p5g,nrow = 3,ncol = 3),
       height = 6,width = 8,dpi = 300)
```

Structure plot
--------------

The structure plot summarizes the topic proportions in each of the 7
subsets:

```{r structure-plot, fig.width=8, fig.height=1.5}
set.seed(1)
topic_colors <- c("gold","forestgreen","dodgerblue","gray",
                  "darkmagenta","violet")
topics <- c(5,3,2,4,1,6)
rows <- sort(c(sample(which(samples$cluster == "B"),1000),
               sample(which(samples$cluster == "CD14+"),300),
               sample(which(samples$cluster == "CD34+"),500),
               sample(which(samples$cluster == "CD8+"),400),
               sample(which(samples$cluster == "NK"),500),
               sample(which(samples$cluster == "T"),1000),
			   which(samples$cluster == "dendritic")))
x  <- samples[rows,"cluster"]
x  <- factor(x,c("B","CD14+","CD34+","dendritic","NK","CD8+","T"))
p6 <- structure_plot(select(poisson2multinom(fit),loadings = rows),
                     grouping = x,topics = topics,
                     colors = topic_colors[topics],
   	  			     perplexity = c(70,30,30,30,30,30,70),n = Inf,gap = 50,
					 num_threads = 4,verbose = FALSE)
print(p6)
```

```{r structure-plot-for-paper, message=FALSE, warning=FALSE, echo=FALSE, results="hide"}
set.seed(1)
fit1 <- select(poisson2multinom(fit),loadings = rows[x == "B"])
fit2 <- select(poisson2multinom(fit),loadings = rows[x == "CD14+"])
fit3 <- select(poisson2multinom(fit),loadings = rows[x == "CD34+"])
fit4 <- select(poisson2multinom(fit),loadings = rows[x == "dendritic"])
fit5 <- select(poisson2multinom(fit),loadings = rows[x == "NK"])
fit6 <- select(poisson2multinom(fit),loadings = rows[x == "CD8+"])
fit7 <- select(poisson2multinom(fit),loadings = rows[x == "T"])
k1   <- order(colMeans(fit1$L))
k2   <- order(colMeans(fit2$L))
k3   <- order(colMeans(fit3$L))
k4   <- order(colMeans(fit4$L))
k5   <- order(colMeans(fit5$L))
k6   <- order(colMeans(fit6$L))
k7   <- order(colMeans(fit7$L))
pp1  <- structure_plot(fit1,topics = k1,colors = topic_colors[k1],
                       perplexity = 70,num_threads = 4) + ggtitle("B-cells")
pp2  <- structure_plot(fit2,topics = k2,colors = topic_colors[k2],
	   				   perplexity = 30,num_threads = 4) + ggtitle("CD14+")
pp3  <- structure_plot(fit3,topics = k3,colors = topic_colors[k3],
	   				   perplexity = 30,num_threads = 4) + ggtitle("CD34+")
pp4  <- structure_plot(fit4,topics = k4,colors = topic_colors[k4],
	   				   perplexity = 30,num_threads = 4) + ggtitle("dendritic")
pp5  <- structure_plot(fit5,topics = k5,colors = topic_colors[k5],
	   				   perplexity = 30,num_threads = 4) + ggtitle("NK")
pp6  <- structure_plot(fit6,topics = k6,colors = topic_colors[k6],
	   				   perplexity = 30,num_threads = 4) + ggtitle("CD8+")
pp7  <- structure_plot(fit7,topics = k7,colors = topic_colors[k7],
	   				   perplexity = 70,num_threads = 4) + ggtitle("T")
ggsave("structure_plot_pbmc_purified.eps",
       plot_grid(pp1,pp2,pp3,pp4,pp5,pp6,pp7,nrow = 2,ncol = 4),
       height = 3,width = 12)
```

Analysis of single-cell likelihoods
-----------------------------------

*Create scatterplots comparing single-cell likelihoods using a "hard"
clustering (based on the FACS subpopulations).*

PCA vs. *t*-SNE and UMAP: an illustration
-----------------------------------------

Here we contrast use of a simple linear dimensionality reduction
technique, PCA, with nonlinear dimensionality reduction methods
*t*-SNE and UMAP.

To begin, draw a random subset of 2,000 cells from the B, CD14+ and
CD34+ clusters identified above. (The main reason for taking a random
subset is that we don't want to wait a long time for *t*-SNE and UMAP
to complete.)

```{r subset-fit}
set.seed(5)
rows <- which(with(samples,
                   cluster == "B" |
                   cluster == "CD14+" |
                   cluster == "CD34+"))
rows <- sort(sample(rows,2000))
fit2 <- select(poisson2multinom(fit),loadings = rows)
x    <- samples$cluster[rows,drop = TRUE]
```

Next, run PCA on the topic proportions for this random subset of 2,000
samples.

```{r pca}
p7 <- pca_plot(fit2,fill = x) + labs(fill = "cluster")
```

Run *t*-SNE on the topic proportions.

```{r tsne}
tsne <- Rtsne(fit2$L,dims = 2,pca = FALSE,normalize = FALSE,perplexity = 100,
              theta = 0.1,max_iter = 1000,eta = 200,verbose = FALSE)
tsne$x <- tsne$Y
colnames(tsne$x) <- c("tsne1","tsne2")
p8 <- pca_plot(fit2,out.pca = tsne,fill = x) + labs(fill = "cluster")
```

Then run UMAP on the topic proportions.

```{r umap}
out.umap <- umap(fit2$L,n_neighbors = 30,metric = "euclidean",n_epochs = 1000,
                 min_dist = 0.1,scale = "none",learning_rate = 1,
                 verbose = FALSE)
out.umap <- list(x = out.umap)
colnames(out.umap$x) <- c("umap1","umap2")
p9 <- pca_plot(fit2,out.pca = out.umap,fill = x) + labs(fill = "cluster")
```

Here are the 2-d embeddings, side-by-side:

```{r pca-vs-tsne, fig.width=8, fig.height=2}
plot_grid(p7,p8,p9,nrow = 1)
```

By the projection of the samples onto the first two PCs, 
the B-cells cluster is distinct from the others, whereas the CD14+ and
CD34+ cells do not separate as well.

By contrast, this detail is not captured in the *t*-SNE and UMAP
embeddings. This illustrates the tendency of *t*-SNE and UMAP to
accentuate clusters in the data at the risk of distorting or obscuring
finer scale substructure.

```{r pca-vs-tsne-for-paper, echo=FALSE}
ggsave("pca_vs_tsne.eps",plot_grid(p6,p7,p8,nrow = 1),height = 2,width = 8)
```

Note that the first 2 PCs should be sufficient for capturing the full
structure in the topic proportions as they explain >96% of the
variance:

```{r prcomp-summary}
summary(prcomp(fit2$L))
```

Save results
------------

Save the clustering of the PBMC data to an RDS file.

```{r save-results}
saveRDS(samples,"clustering-pbmc-purified.rds")
```
