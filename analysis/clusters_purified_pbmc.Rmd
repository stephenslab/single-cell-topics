---
title: "Identify clusters in mixture of FACS-purified PBMC data using topic model"
author: Peter Carbonetto
output: workflowr::wflow_html
---

Here we identify clusters of cells from the mixture proportions
estimated in the mixture of FACS-purified PBMC data.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below, as well as additional
functions that we will use to generate some of the plots.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(fastTopics)
library(ggplot2)
library(cowplot)
```

Load the count data.

```{r load-data}
load("../data/pbmc_purified.RData")
table(samples$celltype)
```

Load the $K = 6$ Poisson NMF model fit.

```{r load-fit}
fit <- readRDS(file.path("../output/pbmc-purified/rds",
                         "fit-pbmc-purified-scd-ex-k=6.rds"))$fit
fit <- poisson2multinom(fit)
```

From the PCs of the mixture proportions, we define clusters for B cells,
CD14+ cells and CD34+ cells. The remaining cells are assigned to the U
cluster ("U" for "unknown").

```{r clustering-1}
pca <- prcomp(fit$L)$x
n   <- nrow(pca)
x   <- rep("U",n)
pc1 <- pca[,1]
pc2 <- pca[,2]
pc3 <- pca[,3]
pc4 <- pca[,4]
pc5 <- pca[,5]
x[pc2 > 0.25] <- "B"
x[pc3 < -0.2 & pc4 < 0.2] <- "CD34+"
x[(pc4 + 0.1)^2 + (pc5 - 0.8)^2 < 0.07] <- "CD14+"
```

Next, we define clusters for NK cells and dendritic cells from the top
2 PCs of the mixture proportions in the U cluster.

```{r clustering-2}
rows <- which(x == "U")
n    <- length(rows)
fit2 <- select_loadings(fit,loadings = rows)
pca  <- prcomp(fit2$L)$x
y    <- rep("U",n)
pc1  <- pca[,1]
pc2  <- pca[,2]
pc3  <- pca[,3]
pc4  <- pca[,4]
y[pc1 < -0.3 & 1.1*pc1 < -pc2 - 0.57] <- "NK"
y[pc3 > 0.4 & pc4 < 0.2] <- "dendritic"
x[rows] <- y
```

Among the remaining cells, we define a cluster for CD8+ cells, noting
that this is much less distinct than the other cells. The rest are
labeled as T cells.

```{r clustering-3}
rows <- which(x == "U")
n    <- length(rows)
fit2 <- select_loadings(fit,loadings = rows)
pca  <- prcomp(fit2$L)$x
y    <- rep("T",n)
pc1  <- pca[,1]
pc2  <- pca[,2]
y[pc1 < 0.25 & pc2 < -0.15] <- "CD8+"
x[rows] <- y
```

In summary, we have subdivided the cells into 7 subsets:

```{r clustering-4}
samples$cluster <- factor(x)
table(samples$cluster)
```

This plot
shows the clustering of the cells projected onto the top two PCs:

```{r clustering-5, fig.width=7.5, fig.height=2.75, message=FALSE}
cluster_colors <- c("dodgerblue",  # B cells
                    "forestgreen", # CD14+
					"darkmagenta", # CD34+ 
                    "red",         # CD8+
					"skyblue",     # dendritic
					"gray",        # NK
					"darkorange")  # T cells
p1 <- pca_plot(fit,fill = samples$cluster) +
  scale_fill_manual(values = cluster_colors) +
  labs(fill = "cluster")
p2 <- pca_hexbin_plot(fit)
plot_grid(p1,p2,rel_widths = c(10,11))
```

This clustering corresponds well to the Zheng *et al* (2017) FACS cell
populations, although there are some differences.

```{r clustering-6}
with(samples,table(celltype,cluster))
```

Compare the FACS subpopulations projected onto the top two PCs with
the clustering in the PCA plot above:

```{r clustering-7, fig.width=4.5, fig.height=3, message=FALSE}
facs_colors <- c("forestgreen", # CD14+
                 "dodgerblue",  # B cells
                 "darkmagenta", # CD34+
                 "gray",        # NK cells
                 "tomato",      # cytotoxic T cells
                 "gold")        # T cells
x <- as.character(samples$celltype)
x[x == "CD4+ T Helper2" | x == "CD4+/CD45RO+ Memory" |
  x == "CD8+/CD45RA+ Naive Cytotoxic" | x == "CD4+/CD45RA+/CD25- Naive T" | 
  x == "CD4+/CD45RA+/CD25- Naive T" | x == "CD4+/CD25 T Reg"] <- "T cell"
x <- factor(x)
p3 <- pca_plot(fit,fill = x) +
  scale_fill_manual(values = facs_colors) +
  labs(fill = "FACS subpopulation")
print(p3)
```

```{r pca-plots-for-paper, echo=FALSE}
ggsave("../plots/pca_clusters_pbmc_purified.png",
       p1,height = 4,width = 5,dpi = 450)
ggsave("../plots/pca_hexbin_pbmc_purified.eps",
	   p2,height = 3,width = 4)
ggsave("../plots/pca_facs_pbmc_purified.png",
       p3,height = 4,width = 5.5,dpi = 450)
```

The continuous variation in T cells captured by topics 1 and 6 
suggests CD4+/CD8+ lineage differentiation in T cells:

```{r loadings-plot-t, fig.width=2.5, fig.height=3.5}
x  <- samples$celltype
i  <- names(sort(tapply(fit$L[,1],x,mean)))
x  <- factor(as.character(x),i)
rows <- which(with(samples,!(celltype == "CD19+ B" |
                             celltype == "CD14+ Monocyte" |
                             celltype == "CD34+" |
							 celltype == "CD56+ NK")))
p4 <- loadings_plot(select_loadings(fit,loadings = rows),
                    x = x[rows],k = 1) +
      scale_y_continuous(limits = c(0,1)) +
      labs(y = "topic 1 mixture proportion",title = "")
print(p4)
```

```{r loadings-plot-for-paper, echo=FALSE}
ggsave("../plots/loadings_plot_pbmc_purified.eps",
       p4,width = 2.5,height = 3.5)
```

The Structure plot summarizes the mixture proportions in each of the 7
clusters:

```{r structure-plot, fig.width=8, fig.height=1.5}
set.seed(1)
topic_colors <- c("gold","forestgreen","dodgerblue","gray",
                  "darkmagenta","violet")
topics <- c(5,3,2,4,1,6)
x    <- samples$cluster
rows <- sort(c(sample(which(x == "B"),1000),
               sample(which(x == "CD14+"),300),
               sample(which(x == "CD34+"),500),
               sample(which(x == "CD8+"),400),
               sample(which(x == "NK"),500),
               sample(which(x == "T"),1000),
			   which(samples$cluster == "dendritic")))
x  <- x[rows]
x  <- factor(x,c("B","CD14+","CD34+","dendritic","NK","CD8+","T"))
p5 <- structure_plot(select_loadings(fit,loadings = rows),
                     grouping = x,topics = topics,
                     colors = topic_colors[topics],
   	  			     perplexity = c(70,30,30,30,30,30,70),n = Inf,gap = 50,
					 num_threads = 4,verbose = FALSE)
print(p5)
```

This Structure plot summarizes the correspondence between the topics
and the FACS cell populations. It shows the FACS mislabeling of the
CD34+ cells.

```{r structure-plot-2, fig.width=8, fig.height=1.8}
set.seed(1)
x <- as.character(samples$celltype)
x[x == "CD4+/CD45RA+/CD25- Naive T"] <- "T cell"
x[x == "CD8+ Cytotoxic T"] <- "T cell"
x[x == "CD4+/CD45RO+ Memory"] <- "T cell"
x[x == "CD8+/CD45RA+ Naive Cytotoxic"] <- "T cell"
x[x == "CD4+ T Helper2"] <- "T cell"
x[x == "CD4+/CD25 T Reg"] <- "T cell"
x <- factor(x,c("CD19+ B","CD14+ Monocyte","CD34+","CD56+ NK","T cell"))
rows <- sort(c(sample(which(x == "CD19+ B"),500),
               sample(which(x == "CD14+ Monocyte"),250),
               sample(which(x == "CD34+"),500),
               sample(which(x == "CD56+ NK"),400),
               sample(which(x == "T cell"),1000)))
x <- x[rows]
p6 <- structure_plot(select_loadings(fit,loadings = rows),grouping = x,
                     topics = topics,colors = topic_colors[topics],
   	  			     perplexity = c(70,30,30,70,70),n = Inf,gap = 30,
					 num_threads = 4,verbose = FALSE)
print(p6)
```

```{r structure-plots-for-paper, message=FALSE, warning=FALSE, echo=FALSE, results="hide"}
ggsave("../plots/structure_plot_clusters_pbmc_purified.eps",
       p5,height = 1.5,width = 8)
ggsave("../plots/structure_plot_facs_pbmc_purified.eps",
	   p6,height = 1.85,width = 8)
```

Save the clustering of the PBMC data to an RDS file.

```{r save-results}
saveRDS(samples,"clustering-pbmc-purified.rds")
```

