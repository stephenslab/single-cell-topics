---
title: "Analysis of rare epithelial cell types in droplet data"
author: Peter Carbonetto
output: workflowr::wflow_html
---

Based on the topic modeling results in the droplet data, with $K = 7$
topics, one of the topics, topic 6, appears to be capturing rare,
specialized epithelial cells, including ionocyte, tuft and
neuroendocrine cells. Therefore, here we reanalyze the cells with
membership to this topic.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis.

```{r load-pkgs, message=FALSE}
library(fastTopics)
library(ggplot2)
library(cowplot)
```

Initialize the sequence of pseudorandom numbers.

```{r set-seed}
set.seed(1)
```

Load the previously prepared count data.

```{r load-data}
load("../data/droplet.RData")
```

Load the results on the rare cell types.

```{r load-results-1}
out       <- readRDS("../output/droplet/refit-droplet.rds")
fits      <- out$fits
de        <- out$de
de_merged <- out$de_merged
```

Below we will look more closely at the topic model with $K = 5$
topics:

```{r load-results-2}
fit <- poisson2multinom(fits$k5)
```

Find the subset of genes and samples that were used to fit the model:

```{r subset-fit}
rownames(samples) <- with(samples,paste(mouse.id,barcode,sep = "_"))
samples <- samples[rownames(fit$L),]
counts  <- counts[rownames(fit$L),rownames(fit$F)]
dim(counts)
```

This plot shows the improvement in the log-likelihood as the rank,
$K$, is increased. The log-likelihoods are shown relative to the
log-likelihood at $K = 2$. 

```{r plot-loglik-vs-k, fig.height=3, fig.width=3.5}
plot_loglik_vs_rank(fits) +
  theme_cowplot(font_size = 12)
```

```{r plots-loglik-vs-k-for-paper, message=FALSE, warning=FALSE, echo=FALSE}
p <- plot_loglik_vs_rank(fits) +
  labs(x = "number of topics (K)") +
  theme_cowplot(font_size = 12)
ggsave("../plots/loglik_vs_k_droplet_rare.eps",p,height = 3,width = 3.25)
```

This PCA plot showing the top two PCs of the topic proportions shows
that the topics correspond well with the clusters identified by
Montoro *et al* (2018):

```{r pca-plot, fig.height=3, fig.width=4.25, warning=FALSE}
clusters <- as.character(samples$tissue)
clusters[clusters == "Basal" |
         clusters == "Club" |
         clusters == "Goblet"] <- "Other"
clusters <- factor(clusters)
tissue_colors <- c("firebrick",   # ciliated
                   "darkmagenta", # ionocyte
                   "darkorange",  # neuroendocrine
				   "gainsboro",   # other
                   "skyblue")     # tuft
p <- pca_plot(fit,pcs = 1:2,fill = clusters) +
  scale_fill_manual(values = tissue_colors)
print(p)
```

```{r pca-plot-for-paper}
ggsave("../plots/pca_cluster_droplet_rare.png",p,
       height = 3,width = 4,dpi = 450,bg = "white")
```

The structure plot summarizes the estimated topic proportions:

```{r structure-plot, fig.width=6, fig.height=1.5, message=FALSE}
set.seed(1)
topic_colors <- c("skyblue","darkorange","red","violet","gainsboro")
topics <- c(5,2,1,3,4)
p <- structure_plot(fit,topics = topics,colors = topic_colors,
                    perplexity = 70,num_threads = 2,verbose = FALSE)
print(p)
```

```{r structure-plot-for-paper, message=FALSE, warning=FALSE, echo=FALSE, results="hide"}
ggsave("../plots/structure_plot_droplet_rare.eps",p,height = 1.6,width = 5)
```

These volcano plots summarize the results of the GoM DE analysis after
merging topics 3 and 4:

```{r volcano-plots-1, fig.height=7, fig.width=8}
p1 <- volcano_plot(de_merged,k = "k1",ymax = 50)
p2 <- volcano_plot(de_merged,k = "k2",ymax = 100)
p3 <- volcano_plot(de_merged,k = "k3+k4",ymax = 100)
p4 <- volcano_plot(de_merged,k = "k5",ymax = 100)
plot_grid(p1,p2,p3,p4)
```

Judging by the most distinctive genes in these volcano plots, the
topics capture tuft cells (topic 1), neuroendocrine cells (topic 2)
and ciliated cells (topics 3 + 4).

Meanwhile, from the structure plot above, we see that topics 3 and 4
capture continuous variation in the ciliated cells. The most
distinctive genes in these two topics suggest...

```{r volcano-plots-2, fig.height=3.5, fig.width=8}
p5 <- volcano_plot(de,k = "k3",ymax = 50)
p6 <- volcano_plot(de,k = "k4",ymax = 200)
plot_grid(p5,p6)
```

```{r volcano-plots-for-paper, echo=FALSE}
ggsave("../plots/volcano_plots_droplet_part1.eps",
       plot_grid(p1,p2,p3,p4,p5,p6,nrow = 2,ncol = 3),
	   height = 7,width = 12.5)
```

TO DO: Create interactive volcano plots.
