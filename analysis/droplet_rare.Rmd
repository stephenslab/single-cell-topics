---
title: "Analysis of rare epithelial cell types in droplet data"
author: Peter Carbonetto
output: workflowr::wflow_html
---

*Add text here.*

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis.

```{r load-pkgs, message=FALSE}
library(fastTopics)
library(ggplot2)
library(cowplot)
```

Initialize the sequence of pseudorandom numbers.

```{r set-seed}
set.seed(1)
```

Load the previously prepared count data.

```{r load-data}
load("../data/droplet.RData")
```

Load the results on the rare cell types.

```{r load-results-1}
out       <- readRDS("../output/droplet/refit-droplet.rds")
fits      <- out$fits
de        <- out$de
de_merged <- out$de_merged
```

Below we will look more closely at the topic model with $K = 5$
topics:

```{r load-results-2}
fit <- poisson2multinom(fits$k5)
```

Find the subset of genes and samples that were used to fit the model:

```{r subset-fit}
rownames(samples) <- with(samples,paste(mouse.id,barcode,sep = "_"))
samples <- samples[rownames(fit$L),]
counts  <- counts[rownames(fit$L),rownames(fit$F)]
```

This plot shows the improvement in the log-likelihood as the rank,
$K$, is increased. The log-likelihoods are shown relative to the
log-likelihood at $K = 2$. 

```{r plot-loglik-vs-k, fig.height=3, fig.width=5}
plot_loglik_vs_rank(fits) +
  theme_cowplot(font_size = 12)
```

```{r plots-loglik-vs-k-for-paper, message=FALSE, warning=FALSE, echo=FALSE}
p <- plot_loglik_vs_rank(fits) +
  labs(x = "number of topics (K)") +
  theme_cowplot(font_size = 12)
ggsave("../plots/loglik_vs_k_droplet_rare.eps",p,height = 3,width = 3.25)
```

Results to add:

+ PCA plot for "rare cells" in droplet data showing correspondence
  between topics and Montoro *et al* (2018) clusters.

+ Volcano plots for "rare cells" in droplet data.

+ Structure plot for "rare cells" in droplet data.
