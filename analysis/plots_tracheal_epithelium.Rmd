---
title: Visualize and interpret droplet and pulse-seq topics
author: Peter Carbonetto
output: workflowr::wflow_html
---

*Add introductory text here.*

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below, as well as additional
functions that we will use to generate some of the plots.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(dplyr)
library(fastTopics)
library(ggplot2)
library(ggrepel)
library(cowplot)
source("../code/plots.R")
```

Load data and results
---------------------

Load the smaller "droplet" data set, the $k = 7$ Poisson NMF model fit
for these data, and the 8 clusters identified in the
[clustering analysis](clusters_droplet.html).

```{r load-droplet-data}
load("../data/droplet.RData")
counts_droplet <- counts
samples_droplet <- readRDS("../output/droplet/clustering-droplet.rds")
fit_droplet <- readRDS("../output/droplet/rds/fit-droplet-scd-ex-k=7.rds")$fit
rm(samples,counts)
```

For reference, we show here the Structure plot from the
[clustering analysis of the droplet data](clusters_droplet.html). This
Structure plot summarizes the topic proportions in each of the 8
subsets.

![](figure/clusters_droplet.Rmd/structure-plot-1.png)

Next, load the larger "pulse-seq" data set, the $k = 11$ Poisson NMF
model fit for these data, and the 7 clusters identified in the
[clustering analysis](clusters_pulseseq.html).

```{r load-pulseseq-data}
load("../data/pulseseq.RData")
counts_pulseseq  <- counts
samples_pulseseq <- readRDS("../output/pulseseq/clustering-pulseseq.rds")
fit_pulseseq <- readRDS("../output/pulseseq/rds/fit-pulseseq-scd-ex-k=11.rds")$fit
rm(samples,counts)
```

For reference, we show here the Structure plot from the
[clustering analysis of the pulse-seq data](clusters_pulseseq.html).
This Structure plot summarizes the topic proportions in each of the 7
subsets:

![](figure/clusters_pulseseq.Rmd/structure-plot-1.png)

Differential expression analysis
--------------------------------

Perform differential expression analysis using the topic model fitted
to the droplet data.

```{r diff-count-analysis-topics-droplet, cache=TRUE}
timing <- system.time(
  diff_count_droplet <- diff_count_analysis(fit_droplet,counts_droplet))
cat(sprintf("Computation took %0.2f seconds.\n",timing["elapsed"]))
```

Perform a differential expression analysis using the topic model
fitted to the pulse-seq data.

```{r diff-count-analysis-topics-pulseseq, cache=TRUE}
timing <- system.time(
  diff_count_pulseseq <- diff_count_analysis(fit_pulseseq,counts_pulseseq))
cat(sprintf("Computation took %0.2f seconds.\n",timing["elapsed"]))
```

Now, calculate differential expression statistics using the clusters
identified in the droplet data.

```{r diff-count-analysis-clusters-droplet, cache=TRUE}
fit_clusters_droplet <-
  init_poisson_nmf_from_clustering(counts_droplet,samples_droplet$cluster)
timing <- system.time(
  diff_count_clusters_droplet <- diff_count_analysis(fit_clusters_droplet,
                                                     counts_droplet))
cat(sprintf("Computation took %0.2f seconds.\n",timing["elapsed"]))
```

And do the same in the pulse-seq data.

```{r diff-count-analysis-clusters-pulseseq, cache=TRUE}
fit_clusters_pulseseq <-
  init_poisson_nmf_from_clustering(counts_pulseseq,samples_pulseseq$cluster)
timing <- system.time(
  diff_count_clusters_pulseseq <- diff_count_analysis(fit_clusters_pulseseq,
                                                      counts_pulseseq))
cat(sprintf("Computation took %0.2f seconds.\n",timing["elapsed"]))
```

Ciliated cells
--------------

We begin with the cluster that captures ciliated cells in the droplet
data. This cluster is one of the most clearly separated clusters in
both the droplet and pulse-seq data sets.

```{r volcano-plot-droplet-cil, fig.width=4.5, fig.height=4}
cilitated_genes <- c("Ccdc113","Ccdc153","Cdhr3","Foxj1","Lztfl1","Mlf1")
p1 <- volcano_plot_with_highlighted_genes(diff_count_clusters_droplet,"Cil",
                                          cilitated_genes,
										  label_above_quantile = 0.998)
print(p1)
```

In this volcano plot, marker genes and transcription factors
identified in Montoro *et al* (2018) are highlighted in black.

We obtain similar top differentially expressed genes in the pulse-seq
data:

```{r volcano-plot-pulseseq-cil, fig.width=4.5, fig.height=4}
p2 <- volcano_plot_with_highlighted_genes(diff_count_clusters_pulseseq,"Cil",
                                          cilitated_genes,
										  label_above_quantile = 0.998)
print(p2)
```

Ionocytes
---------

Volcano plot for "I" cluster in pulse-seq data:

```{r volcano-plot-pulseseq-I, fig.width=4, fig.height=4, eval=FALSE}
genes_ionocytes <- c("Ascl3","Asgr1","Atp6v1c2","Cftr","Foxi1",
                     "Moxd1","P2ry14")
genes <- colnames(counts_pulseseq)
genes[!is.element(genes,genes_ionocytes) &
      diff_count_clusters_pulseseq$Z[,"I"] < 100] <- ""
p3 <- volcano_plot(diff_count_clusters_pulseseq,k = "I",labels = genes,
                   label_above_quantile = 0,ggplot_call = ggplot_call) +
      labs(title = "")
print(p3)
```

We detect a very small cluster of ionocytes in the droplet data, at
least using *Foxi1* as a marker for ionocytes:

```{r pca-plot-droplet-Foxi1, fig.width=4, fig.height=3, eval=FALSE}
pca  <- prcomp(poisson2multinom(fit_droplet)$L)$x
pdat <- data.frame(PC1  = pca[,1],
                   PC2  = pca[,2],
                   Foxi1 = counts_droplet[,"Foxi1"])
p4 <- ggplot(pdat,aes(x = PC1,y = PC2,fill = Foxi1)) +
  geom_point(shape = 21,color = "white",size = 1.25) +
  scale_fill_gradientn(colors = c("skyblue","gold","darkorange","magenta"),
                        na.value = "lightskyblue") +
  theme_cowplot(font_size = 10) +
  labs(fill = "expression level")
print(p4)
```

Goblet cells
------------

Volcano plot for "G" cluster in droplet data:

```{r volcano-plot-droplet-G, fig.width=3, fig.height=4, eval=FALSE}
genes_goblet <- "Gp2"
genes <- colnames(counts_droplet)
p5 <- volcano_plot(diff_count_clusters_droplet,k = "G",labels = genes) +
      labs(title = "")
print(p5)
```
