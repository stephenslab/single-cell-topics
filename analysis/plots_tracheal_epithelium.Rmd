---
title: Visualize and interpret droplet and pulse-seq topics
author: Peter Carbonetto
output: workflowr::wflow_html
---

*Add introductory text here.*

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below, as well as additional
functions that we will use to generate some of the plots.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(dplyr)
library(fastTopics)
library(ggplot2)
library(ggrepel)
library(cowplot)
source("../code/plots.R")
```

Load data and results
---------------------

Load the smaller "droplet" data set, the $k = 7$ Poisson NMF model fit
for these data, and the 8 clusters identified in the
[clustering analysis](clusters_droplet.html).

```{r load-droplet-data}
load("../data/droplet.RData")
counts_droplet <- counts
samples_droplet <- readRDS("../output/droplet/clustering-droplet.rds")
fit_droplet <- readRDS("../output/droplet/rds/fit-droplet-scd-ex-k=7.rds")$fit
rm(samples,counts)
```

For convenience, we show the Structure plot from the
[clustering analysis](clusters_droplet.html), which summarizes the
topic proportions in each of the 8 subsets:

![](figure/clusters_droplet.Rmd/structure-plot-1.png)

Next, load the larger "pulse-seq" data set, the $k = 11$ Poisson NMF
model fit for these data, and the 7 clusters identified in the
[clustering analysis](clusters_pulseseq.html).

```{r load-pulseseq-data}
load("../data/pulseseq.RData")
counts_pulseseq  <- counts
samples_pulseseq <- readRDS("../output/pulseseq/clustering-pulseseq.rds")
fit_pulseseq <- readRDS("../output/pulseseq/rds/fit-pulseseq-scd-ex-k=11.rds")$fit
rm(samples,counts)
```

For convenience, we show the Structure plot from the
[clustering analysis](clusters_pulseseq.html), which summarizes the
topic proportions in each of the 7 subsets:

![](figure/clusters_pulseseq.Rmd/structure-plot-1.png)

Differential expression analysis
--------------------------------

Perform differential expression analysis for the droplet data using
the multinomial topic model.

```{r diff-count-analysis-topics-droplet, cache=TRUE}
timing <- system.time(
  diff_count_droplet <- diff_count_analysis(fit_droplet,counts_droplet))
cat(sprintf("Computation took %0.2f seconds.\n",timing["elapsed"]))
```

Perform a differential expression analysis for the pulse-seq data
using the multinomial topic model.

```{r diff-count-analysis-topics-pulseseq, cache=TRUE}
timing <- system.time(
  diff_count_pulseseq <- diff_count_analysis(fit_pulseseq,counts_pulseseq))
cat(sprintf("Computation took %0.2f seconds.\n",timing["elapsed"]))
```

Perform a standard (cluster-based) differential expression analysis
for the droplet data.

```{r diff-count-analysis-clusters-droplet, cache=TRUE}
fit_clusters_droplet <-
  init_poisson_nmf_from_clustering(counts_droplet,samples_droplet$cluster)
timing <- system.time(
  diff_count_clusters_droplet <- diff_count_analysis(fit_clusters_droplet,
                                                     counts_droplet))
cat(sprintf("Computation took %0.2f seconds.\n",timing["elapsed"]))
```

Perform a standard (cluster-based) differential expression analysis for
the pulseseq data.

```{r diff-count-analysis-clusters-pulseseq, cache=TRUE}
fit_clusters_pulseseq <-
  init_poisson_nmf_from_clustering(counts_pulseseq,samples_pulseseq$cluster)
timing <- system.time(
  diff_count_clusters_pulseseq <- diff_count_analysis(fit_clusters_pulseseq,
                                                      counts_pulseseq))
cat(sprintf("Computation took %0.2f seconds.\n",timing["elapsed"]))
```

Ciliated cells
--------------

Volcano plot for "Cil" cluster in droplet data:

```{r volcano-plot-droplet-cil, fig.width=4, fig.height=4}
ggplot_call <- function (dat, y.label, topic.label)
  ggplot(dat,aes_string(x = "beta",y = "y",fill = "mean",label = "label")) +
    geom_point(color = "white",stroke = 0.3,shape = 21,na.rm = TRUE) +
    scale_y_continuous(trans = "sqrt",
      breaks = c(0,1,2,5,10,20,50,100,200,500,1e3,2e3,5e3,1e4,2e4,5e4)) +
    scale_fill_gradient2(low = "deepskyblue",mid = "gold",high = "orangered",
                         midpoint = mean(range(dat$mean))) +
    geom_text_repel(color = "black",size = 2.25,fontface = "italic",
                    segment.color = "black",segment.size = 0.25,
                    max.overlaps = Inf,na.rm = TRUE) +
    labs(x = "log-fold change (\u03b2)",y = y.label,fill = "log10 mean",
         title = paste("topic",topic.label)) +
    theme_cowplot(font_size = 9)
genes_ciliated <- c("Cdhr3","Foxj1","Ccdc153","Mlf1","Lztfl1")
genes <- colnames(counts_droplet)
genes[!is.element(genes,genes_ciliated) &
      diff_count_clusters_droplet$Z[,"Cil"] < 150] <- ""
p1 <- volcano_plot(diff_count_clusters_droplet,k = "Cil",labels = genes,
                   label_above_quantile = 0,ggplot_call = ggplot_call) +
      labs(title = "")
print(p1)
```

Volcano plot for "Cil" cluster in pulse-seq data:

```{r volcano-plot-pulseseq-cil, fig.width=4, fig.height=4}
genes <- colnames(counts_pulseseq)
genes[!is.element(genes,genes_ciliated) &
      diff_count_clusters_pulseseq$Z[,"Cil"] < 300] <- ""
p2 <- volcano_plot(diff_count_clusters_pulseseq,k = "Cil",labels = genes,
                   label_above_quantile = 0,ggplot_call = ggplot_call) +
      labs(title = "")
print(p2)
```

Ionocytes
---------

Volcano plot for "I" cluster in pulse-seq data:

```{r volcano-plot-pulseseq-I, fig.width=4, fig.height=4}
genes_ionocytes <- c("Ascl3","Asgr1","Atp6v1c2","Cftr","Foxi1",
                     "Moxd1","P2ry14")
genes <- colnames(counts_pulseseq)
genes[!is.element(genes,genes_ionocytes) &
      diff_count_clusters_pulseseq$Z[,"I"] < 100] <- ""
p3 <- volcano_plot(diff_count_clusters_pulseseq,k = "I",labels = genes,
                   label_above_quantile = 0,ggplot_call = ggplot_call) +
      labs(title = "")
print(p3)
```

We detect a very small cluster of ionocytes in the droplet data, at
least using *Foxi1* as a marker for ionocytes:

```{r pca-plot-droplet-Foxi1, fig.width=4, fig.height=3}
pca  <- prcomp(poisson2multinom(fit_droplet)$L)$x
pdat <- data.frame(PC1  = pca[,1],
                   PC2  = pca[,2],
                   Foxi1 = counts_droplet[,"Foxi1"])
p4 <- ggplot(pdat,aes(x = PC1,y = PC2,fill = Foxi1)) +
  geom_point(shape = 21,color = "white",size = 1.25) +
  scale_fill_gradientn(colors = c("skyblue","gold","darkorange","magenta"),
                        na.value = "lightskyblue") +
  theme_cowplot(font_size = 10) +
  labs(fill = "expression level")
print(p4)
```

Goblet cells
------------

Volcano plot for "G" cluster in droplet data:

```{r volcano-plot-droplet-G, fig.width=3, fig.height=4}
genes_goblet <- "Gp2"
genes <- colnames(counts_droplet)
p5 <- volcano_plot(diff_count_clusters_droplet,k = "G",labels = genes) +
      labs(title = "")
print(p5)
```
