---
title: Visualize and interpret droplet and pulse-seq topics
author: Peter Carbonetto
output: workflowr::wflow_html
---

*Add introductory text here.*

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below, as well as additional
functions that we will use to generate some of the plots.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(dplyr)
library(fastTopics)
library(ggplot2)
library(cowplot)
source("../code/plots.R")
```

Load data and results
---------------------

Load the smaller "droplet" data set, the $k = 7$ Poisson NMF model fit
for these data, and the 8 clusters identified in the
[clustering analysis](clusters_droplet.html).

```{r load-droplet-data}
load("../data/droplet.RData")
counts_droplet <- counts
samples_droplet <- readRDS("../output/droplet/clustering-droplet.rds")
fit_droplet <- readRDS("../output/droplet/rds/fit-droplet-scd-ex-k=7.rds")$fit
rm(samples,counts)
```

For convenience, we show the Structure plot again, which summarizes
the topic proportions in each of the 8 subsets:

![](figure/clusters_droplet.Rmd/structure-plot-1.png)

Next, load the larger "pulse-seq" data set, the $k = 11$ Poisson NMF
model fit for these data, and the 7 clusters identified in the
[clustering analysis](clusters_pulseseq.html).

```{r load-pulseseq-data}
load("../data/pulseseq.RData")
counts_pulseseq  <- counts
samples_pulseseq <- readRDS("../output/pulseseq/clustering-pulseseq.rds")
fit_pulseseq <- readRDS("../output/pulseseq/rds/fit-pulseseq-scd-ex-k=11.rds")$fit
rm(samples,counts)
```

For convenience, we show the Structure plot again, which summarizes
the topic proportions in each of the 7 subsets:

![](figure/clusters_pulseseq.Rmd/structure-plot-1.png)

Differential expression analysis
--------------------------------

Perform differential expression analysis for the droplet data using
the multinomial topic model.

```{r diff-count-analysis-topics-droplet, cache=TRUE}
timing <- system.time(
  diff_count_droplet <- diff_count_analysis(fit_droplet,counts_droplet))
cat(sprintf("Computation took %0.2f seconds.\n",timing["elapsed"]))
```

Perform a differential expression analysis for the pulse-seq data
using the multinomial topic model.

```{r diff-count-analysis-topics-pulseseq, cache=TRUE}
timing <- system.time(
  diff_count_pulseseq <- diff_count_analysis(fit_pulseseq,counts_pulseseq))
cat(sprintf("Computation took %0.2f seconds.\n",timing["elapsed"]))
```

Perform a standard (cluster-based) differential expression analysis
for the droplet data.

```{r diff-count-analysis-clusters-droplet, cache=TRUE}
fit_clusters_droplet <-
  init_poisson_nmf_from_clustering(counts_droplet,samples_droplet$cluster)
diff_count_clusters_droplet <- diff_count_analysis(fit_clusters_droplet,
                                                   counts_droplet)
```

Perform a standard (cluster-based) differential expression analysis for
the pulseseq data.

```{r diff-count-analysis-clusters-pulseseq, cache=TRUE}
fit_clusters_pulseseq <-
  init_poisson_nmf_from_clustering(counts_pulseseq,samples_pulseseq$cluster)
diff_count_clusters_pulseseq <- diff_count_analysis(fit_clusters_pulseseq,
                                                    counts_pulseseq)
```

