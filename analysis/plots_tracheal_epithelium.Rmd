---
title: Visualize and interpret droplet and pulse-seq topics
author: Peter Carbonetto
output: workflowr::wflow_html
---

**TO DO:** Add introductory text here.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below.

```{r load-pkgs, message=FALSE}
library(fastTopics)
library(dplyr)
library(ggplot2)
library(cowplot)
source("../code/plots.R")
```

Load the sample annotations. (The count data are no longer needed at this
stage of the analysis.)

```{r load-data}
load("../data/droplet.RData")
samples_droplet <- samples
load("../data/pulseseq.RData")
samples_pulseseq <- samples
rm(samples,counts)
```

Load the $k = 7$ Poisson NMF model fit for the droplet data, and the
$k = 9$ and $k = 11$ Poisson NMF fits for the pulse-seq data.

```{r load-fits}
fit_droplet <- readRDS("../output/droplet/rds/fit-droplet-scd-ex-k=7.rds")$fit
fit_pulseseq9 <- readRDS("../output/pulseseq/rds/fit-pulseseq-scd-ex-k=9.rds")$fit
fit_pulseseq11 <- readRDS("../output/pulseseq/rds/fit-pulseseq-scd-ex-k=11.rds")$fit
```

The Montoro *et al* (2018) article mentions that some epithelial cell
types are abundant, whereas others are very rare. The topics in the
droplet data reflect this:

```{r abundance-plot-droplet, fig.width=3.5, fig.height=2}
p1 <- create_abundance_plot(fit_droplet)
print(p1)
```

The first topic---which is not visible in the bar chart---is indeed
very rare; only 43 out of 7,193 samples have a greater than 10%
contribution from this topic.

```{r abundance-droplet-k1}
sum(poisson2multinom(fit_droplet)$L[,1] > 0.1)
```

Likewise, we also pick up rare and abundant topics in the pulse-seq
data:

```{r abundancee-plot-pulseseq, fig.width=4, fig.height=2}
p2 <- create_abundance_plot(fit_pulseseq)
print(p2)
```

In this next part of the analysis, we perform PCA on the estimated
topic proportions to explore structure in the data as inferred by the
topic model. Typically a nonlinear embedding method such as *t*-SNE or
UMAP is used to visualize the structure, but the disadvantage such
methods is that it can often be difficult to get the (many) tuning
parameters right, and they are sometimes very slow for large data
sets; by contrast, PCA has no tuning parameters.

These three scatterplots show the droplet samples (the topic
proportions) projected onto 5 out of the 7 PCs. (PCs 3 and 7 do not
reveal any additional structure, so are not shown here.)

```{r droplet-pca, fig.height=2.5, fig.width=8}
p3 <- basic_pca_plot(fit_droplet,c("PC1","PC2"))
p4 <- basic_pca_plot(fit_droplet,c("PC4","PC5"))
p5 <- basic_pca_plot(fit_droplet,c("PC5","PC6"))
plot_grid(p3,p4,p5,nrow = 1)
```

Distinct clusters show up in the PC1 vs. PC2 plot, as well as in the
PC5 vs. PC6 plot, whereas the structure in PC4 vs. PC5 is very much
continuously varying.

Let's look more closely at the topics that show variation in the first
two PCs:

```{r droplet-pca-with-topics-1, fig.height=2.1, fig.width=6}
p6 <- pca_plot(poisson2multinom(fit_droplet),pcs = 1:2,k = c(2,5,6),
               plot_grid_call = function (plots)
			     do.call(plot_grid,c(lapply(plots,
				   function (x) x + guides(fill = "none")),list(nrow = 1))))
print(p6)
```

The bulk of the samples lie on a continuous gradient between topics 2
and 5. There is a smaller cluster at the bottom of this plot, with
high contributions from topic 6.

Next, we look closely at PCs 4 and 5:

```{r droplet-pca-with-topics-2, fig.height=2, fig.width=8}
p7 <- pca_plot(poisson2multinom(fit_droplet),pcs = 4:5,k = c(3,4,5,7),
               plot_grid_call = function (plots)
			     do.call(plot_grid,c(lapply(plots,
				   function (x) x + guides(fill = "none")),list(nrow = 1))))
print(p7)
```

Along these PCs, we see that topics 3, 4, 5 and 7 exist in many
combinations, with no apparent distinct populations.

Topic 1 captures a very small discrete population of cells:

```{r droplet-pca-with-topics-3, fig.height=2.25, fig.width=2.25}
p8 <- pca_plot(poisson2multinom(fit_droplet),pcs = 5:6,k = 1) +
        guides(fill = "none")
print(p8)
```

In summary, topics 1 and 6 pick up discrete "cell types", whereas the
other topics characterize more continuous variation in gene
expression, perhaps cell types along a continuous trajectory of
development. There are some other discrete clusters that seem to be
composed of distinct combinations of topics that we will neeed to
examine more closely.

As suggested by this analysis, we can easily delineate four clusters,
the majority of which are included in cluster labeled c_1$. Here we
construct this clustering by hand, using the PCs computed from the
topic cproportions:

```{r droplet-clustering-1}
pca_droplet <- prcomp(poisson2multinom(fit_droplet)$L)$x
n    <- nrow(pca_droplet)
x    <- rep("c0",n)
pc1  <- pca_droplet[,"PC1"]
pc2  <- pca_droplet[,"PC2"]
pc6  <- pca_droplet[,"PC6"]
x[pc2 > -0.1]  <- "c1"
x[pc6 < -0.04] <- "c2"
x[(pc1 - 0)^2 + (pc2 + 0.75)^2 < 0.09]  <- "c3"
x[(pc1 - 0.5)^2 + (pc2 + 0.9)^2 < 0.04] <- "c4"
samples_droplet$cluster <- factor(x)
print(table(samples_droplet$cluster))
```

Indeed, the vast majority of the cells are in the $c_1$ cluster.

These next few scatterplots show the same PCs as before, with the
samples labeled according to their assignment to these clusters:

```{r droplet-clustering-2, fig.height=4.5, fig.width=6}
droplet_cluster_colors <- c("gray","darkblue","gold","yellowgreen","firebrick")
p9 <- pca_plot_with_labels(fit_droplet,c("PC1","PC2"),samples_droplet$cluster,
                           droplet_cluster_colors) + labs(fill = "cluster")
p10 <- pca_plot_with_labels(fit_droplet,c("PC4","PC5"),samples_droplet$cluster,
                            droplet_cluster_colors) + labs(fill = "cluster")
p11 <- pca_plot_with_labels(fit_droplet,c("PC5","PC6"),samples_droplet$cluster,
                            droplet_cluster_colors) + labs(fill = "cluster")
plot_grid(p9,p10,p11)
```

In the following, we will treat the more abundant clusters, $c_1$ and
$c_4$, separately from the rest of the samples.

**TO DO:** Add text here.

```{r pulseseq-pca, fig.width=6, fig.height=2.5}
p12 <- pca_plot(poisson2multinom(fit_pulseseq),pcs = 3:4,k = 7)
p13 <- pca_plot(poisson2multinom(fit_pulseseq),pcs = 5:6,k = 2)
plot_grid(p12,p13)
```

**TO DO:** Add text here.

```{r droplet-structure-plot-rare, fig.width=6, fig.height=2}
droplet_topic_colors <- c("gold","royalblue","turquoise","greenyellow",
                          "forestgreen","firebrick","olivedrab")
names(droplet_topic_colors) <- paste0("k",1:7)						 
topics <- c("k1","k3","k4","k5","k7","k2","k6")
set.seed(1)
fit_droplet_rare <- select(poisson2multinom(fit_droplet),
                           loadings = which(samples_droplet$cluster != "c1" &
			                                samples_droplet$cluster != "c4"))
p12 <- structure_plot(fit_droplet_rare,verbose = FALSE,perplexity = 50,
                      topics = topics,
                      colors = droplet_topic_colors[topics])
print(p12)
```

**TO DO:** Add text here.

```{r droplet-structure-plot-abundant, fig.width=8, fig.height=2}
topics <- c("k1","k3","k4","k7","k5","k2","k6")
set.seed(1)
fit_droplet_abundant <-
  select(poisson2multinom(fit_droplet),
                          loadings = which(samples_droplet$cluster == "c1" |
						                   samples_droplet$cluster == "c4"))
p13 <- structure_plot(fit_droplet_abundant,n = 2000,perplexity = 50,
                      verbose = FALSE,topics = topics,
					  colors = droplet_topic_colors[topics],
					  scaling = c(1,1,1,1,2,1,1))
print(p13)
```

```{r, eval=FALSE}
temp <- select(poisson2multinom(fit_droplet),
               loadings = which(samples_droplet$tissue == "Ionocyte"))
structure_plot(temp,rows = order(temp$L[,3]),
                      topics = topic_ordering,
					  colors = droplet_topic_colors[topic_ordering])
temp2 <- select(poisson2multinom(fit_droplet),
                loadings = which(samples_droplet$tissue == "Tuft"))
structure_plot(temp2,perplexity = 30,
               topics = topic_ordering,
			   colors = droplet_topic_colors[topic_ordering])
temp3 <- select(poisson2multinom(fit_droplet),
                loadings = which(samples_droplet$tissue == "Neuroendocrine"))
structure_plot(temp3,perplexity = 30,
               topics = topic_ordering,
			   colors = droplet_topic_colors[topic_ordering])
```


It is helpful to compare these results with clustering reported in the
Montoro *et al* (2018) paper. To make this comparison, we layer the 7
clusters on top of these PCs:

```{r droplet-pca-with-clusters, fig.height=5.25, fig.width=8}
droplet_celltype_colors <-
  c("royalblue",      # Basal
    "firebrick",      # Ciliated
    "forestgreen",    # Club
    "gold",           # Goblet
    "darkmagenta",    # Ionocyte
    "darkorange",     # Neuroendocrine
    "lightsteelblue") # Tuft
p9 <- pca_plot_with_labels(fit_droplet,c("PC1","PC2"),samples_droplet$tissue,
                           droplet_celltype_colors) + labs(fill = "celltype")
p10 <- pca_plot_with_labels(fit_droplet,c("PC4","PC5"),samples_droplet$tissue,
                            droplet_celltype_colors) + labs(fill = "celltype")
p11 <- pca_plot_with_labels(fit_droplet,c("PC5","PC6"),samples_droplet$tissue,
                            droplet_celltype_colors) + labs(fill = "celltype")
plot_grid(p9,p10,p11)
```

**TO DO:** Add Structure plot9s) to compare Montoro *et al* (2018) clustering.

And likewise in the pulse-seq data:

```{r pulseseq-pca-old, fig.height=2, fig.width=4, eval=FALSE}
p5 <- basic_pca_plot(fit_pulseseq,c("PC3","PC4"))
p6 <- basic_pca_plot(fit_pulseseq,c("PC5","PC6"))
plot_grid(p5,p6)
```

```{r droplet-pca-with-topics-4, eval=FALSE}
ggplot(cbind(pca$x,data.frame(k2 = fit$L[,2])),
       aes(x = PC1,y = PC2,fill = k2)) +
  geom_point(shape = 21,color = "white",size = 2) +
  scale_fill_gradient2(low = "deepskyblue",mid = "gold",high = "orangered",
                       midpoint = 0.5) +
  theme_cowplot(font_size = 12)
ggplot(cbind(pca$x,data.frame(k5 = fit$L[,5])),
       aes(x = PC1,y = PC2,fill = k5)) +
  geom_point(shape = 21,color = "white",size = 2) +
  scale_fill_gradient2(low = "deepskyblue",mid = "gold",high = "orangered",
                       midpoint = 0.5) +
  theme_cowplot(font_size = 12)
ggplot(cbind(pca$x,data.frame(k6 = fit$L[,6])),
       aes(x = PC1,y = PC2,fill = k6)) +
  geom_point(shape = 21,color = "white",size = 2) +
  scale_fill_gradient2(low = "deepskyblue",mid = "gold",high = "orangered",
                       midpoint = 0.5) +
  theme_cowplot(font_size = 12)
ggplot(cbind(pca$x,data.frame(k1 = fit$L[,1])),
       aes(x = PC5,y = PC6,fill = k1)) +
  geom_point(shape = 21,color = "white",size = 2) +
  scale_fill_gradient2(low = "deepskyblue",mid = "gold",high = "orangered",
                       midpoint = 0.5) +
  theme_cowplot(font_size = 12)
```

```{r, eval=FALSE}
ggplot(cbind(pca$x,data.frame(k3 = fit$L[,3])),
       aes(x = PC1,y = PC2,fill = k3)) +
  geom_point(shape = 21,color = "white",size = 2) +
  scale_fill_gradient2(low = "deepskyblue",mid = "gold",high = "orangered",
                       midpoint = 0.5) +
  theme_cowplot(font_size = 12)
ggplot(cbind(pca$x,data.frame(k4 = fit$L[,4])),
       aes(x = PC1,y = PC2,fill = k4)) +
  geom_point(shape = 21,color = "white",size = 2) +
  scale_fill_gradient2(low = "deepskyblue",mid = "gold",high = "orangered",
                       midpoint = 0.5) +
  theme_cowplot(font_size = 12)
```

```{r, eval=FALSE}
ggplot(cbind(samples_droplet,pca$x),aes(x = PC1,y = PC2,fill = tissue)) +
  geom_point(shape = 21,color = "white",size = 2) +
  scale_fill_manual(values = clrs) +
  theme_cowplot(font_size = 12)
ggplot(cbind(samples_droplet,pca$x),aes(x = PC5,y = PC6,fill = tissue)) +
  geom_point(shape = 21,color = "white",,size = 2) +
  scale_fill_manual(values = clrs) +
  theme_cowplot(font_size = 12)
```

```{r, eval=FALSE}
clrs <- c("royalblue",      # basal
          "firebrick",      # ciliated
          "forestgreen",    # club
	      "gold",           # goblet
		  "darkmagenta",    # ionocyte
          "darkorange",     # neuroendocrine
		  "tomato",         # proliferating
		  "darkgray")       # tuft
ggplot(cbind(samples_droplet,pca$x),aes(x = PC1,y = PC2,fill = tissue)) +
  geom_point(shape = 21,color = "white",size = 2) +
  scale_fill_manual(values = clrs) +
  theme_cowplot(font_size = 12)
ggplot(cbind(samples_droplet,pca$x),aes(x = PC5,y = PC6,fill = tissue)) +
  geom_point(shape = 21,color = "white",,size = 2) +
  scale_fill_manual(values = clrs) +
  theme_cowplot(font_size = 12)
```
