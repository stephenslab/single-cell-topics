---
title: Visualize and interpret droplet and pulse-seq topics
author: Peter Carbonetto
output: workflowr::wflow_html
---

*TO DO: Add introductory text here.*

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below, as well as additional
functions that we will use to generate some of the plots.

```{r load-pkgs, message=FALSE}
library(dplyr)
library(fastTopics)
library(ggplot2)
library(cowplot)
source("../code/plots.R")
```

Droplet data
------------

We begin with the droplet data. Note that the count data are no longer
needed at this stage.

```{r load-droplet-data}
load("../data/droplet.RData")
samples_droplet <- samples
rm(samples,counts)
```

Load the $k = 7$ Poisson NMF model fit.

```{r load-droplet-fit}
fit_droplet <- readRDS("../output/droplet/rds/fit-droplet-scd-ex-k=7.rds")$fit
```

The Montoro *et al* (2018) article mentions that some epithelial cell
types are abundant whereas others are rare. The topics inferred from
the droplet data reflect this:

```{r abundance-plot-droplet, fig.width=3.5, fig.height=2}
p1 <- create_abundance_plot(fit_droplet)
print(p1)
```

The first topic---which is not actually visible in this bar chart---is
indeed very rare; only 43 out of 7,193 samples have a greater than 10%
contribution from this topic.

```{r abundance-droplet-k1}
sum(poisson2multinom(fit_droplet)$L[,1] > 0.1)
```

In this next part of the analysis, we perform PCA on the estimated
topic proportions to explore structure in the data as inferred by the
topic model. Typically, a nonlinear embedding method such as *t*-SNE
or UMAP is used to visualize the structure. The disadvantage of such
methods is that it can often be difficult to get the (many) tuning
parameters right, they can be slow when applied to large data sets,
and the embeddings are not unique; by contrast, PCA has no tuning
parameters, and the principal components (PCs) are unique.

```{r droplet-clustering-1}
fit <- poisson2multinom(fit_droplet)
pca <- prcomp(fit$L)$x
```

In the projection onto four of the PCs---PCs 1, 2, 5 and 6---we can
delineate 4 clusters. A fifth subset ("E") is used as a "background"
cluster. (Note that PCs 3 and 4 do not reveal any additional
substrcture, so are not shown.)

```{r droplet-clustering-2, fig.width=8, fig.height=3.5}
n   <- nrow(pca)
x   <- rep("E",n)
pc1 <- pca[,"PC1"]
pc2 <- pca[,"PC2"]
pc6 <- pca[,"PC6"]
x[pc2 > -0.1]  <- "A"
x[pc6 < -0.04] <- "B"
x[(pc1 - 0)^2 + (pc2 + 0.75)^2 < 0.09]  <- "C"
x[(pc1 - 0.5)^2 + (pc2 + 0.9)^2 < 0.04] <- "D"
samples_droplet$cluster <- x
p1 <- pca_plot_with_labels(fit_droplet,c("PC1","PC2"),x) +
      labs(fill = "cluster")
p2 <- pca_plot_with_labels(fit_droplet,c("PC5","PC6"),x) +
      labs(fill = "cluster")
plot_grid(p1,p2)
```

The vast majority of the cells are in cluster A:

```{r droplet-clustering-3}
table(x)
```

Cluster A further subdivides into two not-quite-so-distinct
subclusters, otherwise there does not appear to be any other
interesting substructure to delineate:

```{r droplet-clustering-4, fig.width=5, fig.height=4}
rows <- which(samples_droplet$cluster == "A")
fit  <- select(poisson2multinom(fit_droplet),loadings = rows)
pca  <- prcomp(fit$L)$x
n    <- nrow(pca)
x    <- rep("A1",n)
pc1  <- pca[,1]
x[pc1 > 0.2] <- "A2"
samples_droplet[rows,"cluster"] <- x
p3 <- pca_plot_with_labels(fit,c("PC1","PC2"),x) +
      labs(fill = "cluster")
print(p3)
```

In summary, we have subdivided the data into 6 subsets:

```{r droplet-clustering-5}
samples_droplet$cluster <- factor(samples_droplet$cluster)
table(samples_droplet$cluster)
```

The structure plot summarizes the topic proportions in each of these 6
subsets:

```{r droplet-structure-plot, fig.width=7, fig.height=1.5}
set.seed(2)
droplet_topic_colors <- c("gold","royalblue","turquoise","greenyellow",
                          "forestgreen","firebrick","olivedrab")
droplet_topics <- c(1,3,7,4,5,6,2)
rows <- sort(c(sample(which(samples_droplet$cluster == "A1"),800),
               sample(which(samples_droplet$cluster == "A2"),500),
               which(samples_droplet$cluster == "B"),
               which(samples_droplet$cluster == "C"),
               sample(which(samples_droplet$cluster == "D"),200),
               which(samples_droplet$cluster == "E"),200))
p4 <- structure_plot(select(poisson2multinom(fit_droplet),loadings = rows),
                     grouping = samples_droplet[rows,"cluster"],
                     topics = droplet_topics,
					 colors = droplet_topic_colors[droplet_topics],
					 perplexity = c(100,70,12,50,50,20),
                     n = Inf,gap = 40,num_threads = 4,verbose = FALSE)
print(p4)
```

The bulk of the samples lie on a continuous gradient between topics 2
and 5. There is a smaller cluster at the bottom of this plot, with
high contributions from topic 6.

Along these PCs, we see that topics 3, 4, 5 and 7 exist in many
combinations, with no apparent discrete populations.

Topic 1 captures a very small discrete population of cells:

In summary, topics 1 and 6 pick up discrete "cell types", whereas the
other topics characterize more continuous variation in gene
expression, perhaps cell types along a continuous trajectory of
development. There are some other discrete clusters that seem to be
composed of distinct combinations of topics that we will neeed to
examine more closely.

These next few scatterplots show the same PCs as before, with the
samples labeled according to their assignment to these clusters:

```{r droplet-clustering-2b, fig.height=4.5, fig.width=6, eval=FALSE}
droplet_cluster_colors <- c("gray","darkblue","gold","yellowgreen","firebrick")
p9 <- pca_plot_with_labels(fit_droplet,c("PC1","PC2"),samples_droplet$cluster,
                           droplet_cluster_colors) + labs(fill = "cluster")
p10 <- pca_plot_with_labels(fit_droplet,c("PC4","PC5"),samples_droplet$cluster,
                            droplet_cluster_colors) + labs(fill = "cluster")
p11 <- pca_plot_with_labels(fit_droplet,c("PC5","PC6"),samples_droplet$cluster,
                            droplet_cluster_colors) + labs(fill = "cluster")
plot_grid(p9,p10,p11)
```

In the following, we will treat the more abundant clusters, $c_1$ and
$c_4$, separately from the rest of the samples.

**TO DO:** Add text here.

```{r pulseseq-pca, fig.width=6, fig.height=2.5, eval=FALSE}
p12 <- pca_plot(poisson2multinom(fit_pulseseq),pcs = 3:4,k = 7)
p13 <- pca_plot(poisson2multinom(fit_pulseseq),pcs = 5:6,k = 2)
plot_grid(p12,p13)
```

**TO DO:** Add text here.

```{r droplet-structure-plot-rare, fig.width=6, fig.height=2, eval=FALSE}
droplet_topic_colors <- c("gold","royalblue","turquoise","greenyellow",
                          "forestgreen","firebrick","olivedrab")
names(droplet_topic_colors) <- paste0("k",1:7)						 
topics <- c("k1","k3","k4","k5","k7","k2","k6")
set.seed(1)
fit_droplet_rare <- select(poisson2multinom(fit_droplet),
                           loadings = which(samples_droplet$cluster != "c1" &
			                                samples_droplet$cluster != "c4"))
p12 <- structure_plot(fit_droplet_rare,verbose = FALSE,perplexity = 50,
                      topics = topics,
                      colors = droplet_topic_colors[topics])
print(p12)
```

**TO DO:** Add text here.

```{r droplet-structure-plot-abundant, fig.width=8, fig.height=2, eval=FALSE}
topics <- c("k1","k3","k4","k7","k5","k2","k6")
set.seed(1)
fit_droplet_abundant <-
  select(poisson2multinom(fit_droplet),
                          loadings = which(samples_droplet$cluster == "c1" |
						                   samples_droplet$cluster == "c4"))
p13 <- structure_plot(fit_droplet_abundant,n = 2000,perplexity = 50,
                      verbose = FALSE,topics = topics,
					  colors = droplet_topic_colors[topics],
					  scaling = c(1,1,1,1,2,1,1))
print(p13)
```

Pulse-seq data
--------------

```{r load-pulseseq-data, eval=FALSE}
load("../data/pulseseq.RData")
samples_pulseseq <- samples
rm(samples,counts)
```

Load the $k = 9$ and $k = 11$ Poisson NMF fits for the pulse-seq data.

```{r load-pulseseq-fits, eval=FALSE}
fit_pulseseq9 <- readRDS("../output/pulseseq/rds/fit-pulseseq-scd-ex-k=9.rds")$fit
fit_pulseseq11 <- readRDS("../output/pulseseq/rds/fit-pulseseq-scd-ex-k=11.rds")$fit
```

Likewise, we also pick up rare and abundant topics in the pulse-seq
data:

```{r abundancee-plot-pulseseq, fig.width=4, fig.height=2, eval=FALSE}
p2 <- create_abundance_plot(fit_pulseseq)
print(p2)
```

```{r, eval=FALSE}
temp <- select(poisson2multinom(fit_droplet),
               loadings = which(samples_droplet$tissue == "Ionocyte"))
structure_plot(temp,rows = order(temp$L[,3]),
                      topics = topic_ordering,
					  colors = droplet_topic_colors[topic_ordering])
temp2 <- select(poisson2multinom(fit_droplet),
                loadings = which(samples_droplet$tissue == "Tuft"))
structure_plot(temp2,perplexity = 30,
               topics = topic_ordering,
			   colors = droplet_topic_colors[topic_ordering])
temp3 <- select(poisson2multinom(fit_droplet),
                loadings = which(samples_droplet$tissue == "Neuroendocrine"))
structure_plot(temp3,perplexity = 30,
               topics = topic_ordering,
			   colors = droplet_topic_colors[topic_ordering])
```


It is helpful to compare these results with clustering reported in the
Montoro *et al* (2018) paper. To make this comparison, we layer the 7
clusters on top of these PCs:

```{r droplet-pca-with-clusters, fig.height=5.25, fig.width=8, eval=FALSE}
droplet_celltype_colors <-
  c("royalblue",      # Basal
    "firebrick",      # Ciliated
    "forestgreen",    # Club
    "gold",           # Goblet
    "darkmagenta",    # Ionocyte
    "darkorange",     # Neuroendocrine
    "lightsteelblue") # Tuft
p9 <- pca_plot_with_labels(fit_droplet,c("PC1","PC2"),samples_droplet$tissue,
                           droplet_celltype_colors) + labs(fill = "celltype")
p10 <- pca_plot_with_labels(fit_droplet,c("PC4","PC5"),samples_droplet$tissue,
                            droplet_celltype_colors) + labs(fill = "celltype")
p11 <- pca_plot_with_labels(fit_droplet,c("PC5","PC6"),samples_droplet$tissue,
                            droplet_celltype_colors) + labs(fill = "celltype")
plot_grid(p9,p10,p11)
```

**TO DO:** Add Structure plot9s) to compare Montoro *et al* (2018) clustering.

And likewise in the pulse-seq data:

```{r pulseseq-pca-old, fig.height=2, fig.width=4, eval=FALSE}
p5 <- basic_pca_plot(fit_pulseseq,c("PC3","PC4"))
p6 <- basic_pca_plot(fit_pulseseq,c("PC5","PC6"))
plot_grid(p5,p6)
```

```{r droplet-pca-with-topics-4, eval=FALSE}
ggplot(cbind(pca$x,data.frame(k2 = fit$L[,2])),
       aes(x = PC1,y = PC2,fill = k2)) +
  geom_point(shape = 21,color = "white",size = 2) +
  scale_fill_gradient2(low = "deepskyblue",mid = "gold",high = "orangered",
                       midpoint = 0.5) +
  theme_cowplot(font_size = 12)
ggplot(cbind(pca$x,data.frame(k5 = fit$L[,5])),
       aes(x = PC1,y = PC2,fill = k5)) +
  geom_point(shape = 21,color = "white",size = 2) +
  scale_fill_gradient2(low = "deepskyblue",mid = "gold",high = "orangered",
                       midpoint = 0.5) +
  theme_cowplot(font_size = 12)
ggplot(cbind(pca$x,data.frame(k6 = fit$L[,6])),
       aes(x = PC1,y = PC2,fill = k6)) +
  geom_point(shape = 21,color = "white",size = 2) +
  scale_fill_gradient2(low = "deepskyblue",mid = "gold",high = "orangered",
                       midpoint = 0.5) +
  theme_cowplot(font_size = 12)
ggplot(cbind(pca$x,data.frame(k1 = fit$L[,1])),
       aes(x = PC5,y = PC6,fill = k1)) +
  geom_point(shape = 21,color = "white",size = 2) +
  scale_fill_gradient2(low = "deepskyblue",mid = "gold",high = "orangered",
                       midpoint = 0.5) +
  theme_cowplot(font_size = 12)
```

```{r, eval=FALSE}
ggplot(cbind(pca$x,data.frame(k3 = fit$L[,3])),
       aes(x = PC1,y = PC2,fill = k3)) +
  geom_point(shape = 21,color = "white",size = 2) +
  scale_fill_gradient2(low = "deepskyblue",mid = "gold",high = "orangered",
                       midpoint = 0.5) +
  theme_cowplot(font_size = 12)
ggplot(cbind(pca$x,data.frame(k4 = fit$L[,4])),
       aes(x = PC1,y = PC2,fill = k4)) +
  geom_point(shape = 21,color = "white",size = 2) +
  scale_fill_gradient2(low = "deepskyblue",mid = "gold",high = "orangered",
                       midpoint = 0.5) +
  theme_cowplot(font_size = 12)
```

```{r, eval=FALSE}
ggplot(cbind(samples_droplet,pca$x),aes(x = PC1,y = PC2,fill = tissue)) +
  geom_point(shape = 21,color = "white",size = 2) +
  scale_fill_manual(values = clrs) +
  theme_cowplot(font_size = 12)
ggplot(cbind(samples_droplet,pca$x),aes(x = PC5,y = PC6,fill = tissue)) +
  geom_point(shape = 21,color = "white",,size = 2) +
  scale_fill_manual(values = clrs) +
  theme_cowplot(font_size = 12)
```

```{r, eval=FALSE}
clrs <- c("royalblue",      # basal
          "firebrick",      # ciliated
          "forestgreen",    # club
	      "gold",           # goblet
		  "darkmagenta",    # ionocyte
          "darkorange",     # neuroendocrine
		  "tomato",         # proliferating
		  "darkgray")       # tuft
ggplot(cbind(samples_droplet,pca$x),aes(x = PC1,y = PC2,fill = tissue)) +
  geom_point(shape = 21,color = "white",size = 2) +
  scale_fill_manual(values = clrs) +
  theme_cowplot(font_size = 12)
ggplot(cbind(samples_droplet,pca$x),aes(x = PC5,y = PC6,fill = tissue)) +
  geom_point(shape = 21,color = "white",,size = 2) +
  scale_fill_manual(values = clrs) +
  theme_cowplot(font_size = 12)
```
