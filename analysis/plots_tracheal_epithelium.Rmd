---
title: Visualize and interpret droplet and pulse-seq topics
author: Peter Carbonetto
output: workflowr::wflow_html
---

**TO DO:** Add introductory text here.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below.

```{r load-pkgs, message=FALSE}
library(fastTopics)
library(ggplot2)
library(cowplot)
source("../code/plots.R")
```

Load the sample annotations. (The count data are no longer needed at this
stage of the analysis.)

```{r load-data}
load("../data/droplet.RData")
samples_droplet <- samples
load("../data/pulseseq.RData")
samples_pulseseq <- samples
rm(samples,counts)
```

Load the $k = 7$ Poisson NMF model fit for the droplet data, and the
$k = 11$ Poisson NMF fit for the pulse-seq data.

```{r load-fits}
fit_droplet <- readRDS("../output/droplet/rds/fit-droplet-scd-ex-k=7.rds")$fit
fit_pulseseq <- readRDS("../output/pulseseq/rds/fit-pulseseq-scd-ex-k=11.rds")$fit
```

Rare and abundant cell types in the droplet data:

```{r abundance-plot-droplet, fig.width=3.5, fig.height=2}
p1 <- create_abundance_plot(fit_droplet)
print(p1)
```

The first topic is indeed very rare; only 43 samples have a greater
than 10% contribution from this topic.

```{r k1-abundance}
sum(poisson2multinom(fit_droplet)$L[,1] > 0.1)
```

Rare and abundant cell types in the pulse-seq data:

```{r abundancee-plot-pulseseq, fig.width=4, fig.height=2}
p2 <- create_abundance_plot(fit_pulseseq)
print(p2)
```

```{r droplet-pca, eval=FALSE}
fit <- poisson2multinom(droplet_fit)
pca <- prcomp(fit$L)
ggplot(as.data.frame(pca$x),aes(x = PC1,y = PC2)) +
  geom_point(shape = 21,color = "white",fill = "black",size = 2) +
  theme_cowplot(font_size = 12)
ggplot(as.data.frame(pca$x),aes(x = PC5,y = PC6)) +
  geom_point(shape = 21,color = "white",fill = "black",size = 2) +
  theme_cowplot(font_size = 12)
```

```{r droplet-pca-with-topics, eval=FALSE}
ggplot(cbind(pca$x,data.frame(k2 = fit$L[,2])),
       aes(x = PC1,y = PC2,fill = k2)) +
  geom_point(shape = 21,color = "white",size = 2) +
  scale_fill_gradient2(low = "deepskyblue",mid = "gold",high = "orangered",
                       midpoint = 0.5) +
  theme_cowplot(font_size = 12)
ggplot(cbind(pca$x,data.frame(k5 = fit$L[,5])),
       aes(x = PC1,y = PC2,fill = k5)) +
  geom_point(shape = 21,color = "white",size = 2) +
  scale_fill_gradient2(low = "deepskyblue",mid = "gold",high = "orangered",
                       midpoint = 0.5) +
  theme_cowplot(font_size = 12)
ggplot(cbind(pca$x,data.frame(k6 = fit$L[,6])),
       aes(x = PC1,y = PC2,fill = k6)) +
  geom_point(shape = 21,color = "white",size = 2) +
  scale_fill_gradient2(low = "deepskyblue",mid = "gold",high = "orangered",
                       midpoint = 0.5) +
  theme_cowplot(font_size = 12)
ggplot(cbind(pca$x,data.frame(k1 = fit$L[,1])),
       aes(x = PC5,y = PC6,fill = k1)) +
  geom_point(shape = 21,color = "white",size = 2) +
  scale_fill_gradient2(low = "deepskyblue",mid = "gold",high = "orangered",
                       midpoint = 0.5) +
  theme_cowplot(font_size = 12)
```

```{r, eval=FALSE}
ggplot(cbind(pca$x,data.frame(k3 = fit$L[,3])),
       aes(x = PC1,y = PC2,fill = k3)) +
  geom_point(shape = 21,color = "white",size = 2) +
  scale_fill_gradient2(low = "deepskyblue",mid = "gold",high = "orangered",
                       midpoint = 0.5) +
  theme_cowplot(font_size = 12)
ggplot(cbind(pca$x,data.frame(k4 = fit$L[,4])),
       aes(x = PC1,y = PC2,fill = k4)) +
  geom_point(shape = 21,color = "white",size = 2) +
  scale_fill_gradient2(low = "deepskyblue",mid = "gold",high = "orangered",
                       midpoint = 0.5) +
  theme_cowplot(font_size = 12)
```

```{r, eval=FALSE}
clrs <- c("royalblue",      # basal
          "firebrick",      # ciliated
          "forestgreen",    # club
		  "gold",           # goblet
		  "darkmagenta",    # ionocyte
          "darkorange",     # neuroendocrine
		  "darkgray")       # tuft
ggplot(cbind(samples_droplet,pca$x),aes(x = PC1,y = PC2,fill = tissue)) +
  geom_point(shape = 21,color = "white",size = 2) +
  scale_fill_manual(values = clrs) +
  theme_cowplot(font_size = 12)
ggplot(cbind(samples_droplet,pca$x),aes(x = PC5,y = PC6,fill = tissue)) +
  geom_point(shape = 21,color = "white",,size = 2) +
  scale_fill_manual(values = clrs) +
  theme_cowplot(font_size = 12)
```
