---
title: Annotate topics and clusters in mixture of FACS-purified PBMC data
author: Peter Carbonetto
output: workflowr::wflow_html
---

*Add text here.*

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below, as well as additional
functions that we will use to generate some of the plots.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(fastTopics)
library(ggplot2)
library(ggrepel)
library(cowplot)
source("../code/functions_for_plots_purified_pbmc.R")
```

Load the count data, the $K = 6$ topic model fit, and the 7 clusters
identified in the [clustering analysis](clusters_purified_pbmc.html).

```{r load-data}
load("../data/pbmc_purified.RData")
fit <- readRDS(file.path("../output/pbmc-purified/rds",
                         "fit-pbmc-purified-scd-ex-k=6.rds"))$fit
fit <- poisson2multinom(fit)
samples <- readRDS("../output/pbmc-purified/clustering-pbmc-purified.rds")
```

*Code used temporarily for testing:*

```{r testing}
rows <- sample(1:94655,9000)
counts <- counts[rows,]
samples <- samples[rows,]
fit <- select_loadings(fit,loadings = rows)
```

Perform differential expression analysis using the FACS labeling.

```{r diff-count-analysis-subpop, cache=TRUE}
celltype <- as.character(samples$celltype)
celltype[celltype == "CD4+/CD45RA+/CD25- Naive T" |
         celltype == "CD8+ Cytotoxic T" |
         celltype == "CD4+/CD45RO+ Memory" |
         celltype == "CD8+/CD45RA+ Naive Cytotoxic" |
         celltype == "CD4+ T Helper2" |
         celltype == "CD4+/CD25 T Reg"] <- "T cell"
celltype <- factor(celltype)
timing <- system.time(
  diff_count_facs <- diff_count_clusters(celltype,counts))
cat(sprintf("Computation took %0.2f seconds.\n",timing["elapsed"]))
```

Perform differential expression analysis using the clusters.

```{r diff-count-analysis-clusters, cache=TRUE}
timing <- system.time(
  diff_count_clusters <- diff_count_clusters(samples$cluster,counts))
cat(sprintf("Computation took %0.2f seconds.\n",timing["elapsed"]))
```

Perform differential expression analysis using the multinomial topic
model, after removing the dendritic cells cluster, and after merging
the two T-cell topics.

```{r diff-count-analysis-topics, cache=TRUE}
rows <- which(samples$cluster != "dendritic")
fit_merged <- select_loadings(fit,loadings = rows)
fit_merged <- merge_topics(fit,c(1,6))
timing <- system.time(
  diff_count_topics <- diff_count_analysis(fit_merged,counts))
cat(sprintf("Computation took %0.2f seconds.\n",timing["elapsed"]))
```

Perform differential expression analysis on the T cells only.

```{r diff-count-analysis-t}
rows <- which(samples$cluster == "T")
fit_t <- select_loadings(fit,loadings = rows)
timing <- system.time(
  diff_count_t <- diff_count_analysis(fit_t,counts[rows,]))
cat(sprintf("Computation took %0.2f seconds.\n",timing["elapsed"]))
```

*Add text here.*

```{r volcano-plots-1, fig.height=4, fig.width=4}
p1 <- volcano_plot_better(diff_count_topics,"k3",genes$symbol,0.998,
                          "topic 3 (B cells)",show_legend = TRUE)
print(p1)
```

*Add text here.*

```{r volcano-plots-2, fig.width=7, fig.height=8}
p2 <- volcano_plot_better(diff_count_topics,"k3",genes$symbol,0.998,
                          "topic 3 (B cells)")
p3 <- volcano_plot_better(diff_count_topics,"k4",genes$symbol,0.998,
                          "topic 4 (NK cells)")
p4 <- volcano_plot_better(diff_count_topics,"k2",genes$symbol,0.998,
                          "topic 2 (CD14+)")
p5 <- volcano_plot_better(diff_count_topics,"k5",genes$symbol,0.998,
                          "topic 5 (CD34+)")
p6 <- volcano_plot_better(diff_count_topics,"k1+k6",genes$symbol,0.998,
                          "topics 1 + 6 (T cells)")
p7 <- volcano_plot_better(diff_count_t,"k1",genes$symbol,0.995,
                          "topic 1 (CD4+/CD8+)")
p8 <- volcano_plot_better(diff_count_clusters,"CD8+",genes$symbol,0.998,
                          "CD8+ cluster") + xlim(-11,11)
p9 <- volcano_plot_better(diff_count_clusters,"dendritic",genes$symbol,0.997,
                          "dendritic cells cluster")
plot_grid(p2,p3,p4,p5,p6,p7,p8,p9,nrow = 3,ncol = 3)
```

```{r volcano-plots-for-paper, echo=FALSE, results="hide", warning=FALSE}
ggsave("../plots/volcano_plot_pbmc_purified_bcells_with_legend.eps",
       p1,height = 3.4,width = 3)
ggsave("../plots/volcano_plot_pbmc_purified_bcells.eps",
       p2,height = 3.4,width = 3)
ggsave("../plots/volcano_plot_pbmc_purified_nk.eps",
       p3,height = 3.4,width = 3)
ggsave("../plots/volcano_plot_pbmc_purified_cd14.eps",
       p4,height = 3.4,width = 3)
ggsave("../plots/volcano_plot_pbmc_purified_cd34.eps",
       p5,height = 3.4,width = 3)
ggsave("../plots/volcano_plot_pbmc_purified_tcells.eps",
       p6,height = 3.4,width = 3)
ggsave("../plots/volcano_plot_pbmc_purified_cd4cd8.eps",
       p7,height = 3.4,width = 3)
ggsave("../plots/volcano_plot_pbmc_purified_cd8.eps",
       p8,height = 3.4,width = 3)
ggsave("../plots/volcano_plot_pbmc_purified_dendritic.eps",
       p9,height = 3.4,width = 3)
```

*Add text here.*

```{r topics-vs-facs-scatterplots, fig.width=6.5, fig.height=7}
p10 <- lfc_scatterplot(diff_count_facs,diff_count_topics,"CD19+ B","k3",
                       genes$symbol,label_above_quantile = 0.998,
                       xlab = "B cells FACS subpopulation",ylab = "topic 3")
p11 <- lfc_scatterplot(diff_count_facs,diff_count_topics,"CD56+ NK","k4",
                       genes$symbol,label_above_quantile = 0.998,
                       xlab = "NK cells FACS subpopulation",ylab = "topic 4")
p12 <- lfc_scatterplot(diff_count_facs,diff_count_topics,"CD14+ Monocyte","k2",
                       genes$symbol,label_above_quantile = 0.998,
                       xlab = "CD14+ FACS subpopulation",ylab = "topic 2")
p13 <- lfc_scatterplot(diff_count_facs,diff_count_topics,"CD34+","k5",
                       genes$symbol,label_above_quantile = 0.998,
                       xlab = "CD34+ FACS subpopulation",ylab = "topic 4")
p14 <- lfc_scatterplot(diff_count_facs,diff_count_topics,"T cell","k1+k6",
                       genes$symbol,label_above_quantile = 0.998,
                       xlab = "T cells FACS subpopulation",
					   ylab = "topics 1 + 6")
plot_grid(p10,p11,p12,p13,p14,nrow = 3,ncol = 2)
```

```{r scatterplots-for-paper, echo=FALSE, results="hide"}
ggsave("../plots/scatterplot_pbmc_purified_bcells.eps",
       p10,height = 3,width = 4)
ggsave("../plots/scatterplot_pbmc_purified_nk.eps",
       p11,height = 3,width = 4)
ggsave("../plots/scatterplot_pbmc_purified_cd14.eps",
       p12,height = 3,width = 4)
ggsave("../plots/scatterplot_pbmc_purified_cd34.eps",
       p13,height = 3,width = 4)
ggsave("../plots/scatterplot_pbmc_purified_tcells.eps",
       p14,height = 3,width = 4)
```

TO DO:

+ Save images to files.

+ Create interactive volcano plots.
