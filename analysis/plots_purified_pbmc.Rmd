---
title: Perform differential expression analysis on topics and clusters identified in mixture of FACS-purified PBMC data
author: Peter Carbonetto
output: workflowr::wflow_html
---

Here we perform a differential expression analysis using the topic
model fit to the mixture of FACS-purified data, as well as the
clusters identified from this topic model.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below, as well as additional
functions that we will use to generate some of the plots.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(fastTopics)
library(ggplot2)
library(ggrepel)
library(cowplot)
source("../code/functions_for_plots_purified_pbmc.R")
```

Load the count data, the $K = 6$ topic model fit, and the 7 clusters
identified in the [clustering analysis](clusters_purified_pbmc.html).

```{r load-data}
load("../data/pbmc_purified.RData")
fit <- readRDS(file.path("../output/pbmc-purified/rds",
                         "fit-pbmc-purified-scd-ex-k=6.rds"))$fit
fit <- poisson2multinom(fit)
samples <- readRDS("../output/pbmc-purified/clustering-pbmc-purified.rds")
```

Perform differential expression analysis using the FACS labeling:

```{r diff-count-analysis-subpop, cache=TRUE}
celltype <- as.character(samples$celltype)
celltype[celltype == "CD4+/CD45RA+/CD25- Naive T" |
         celltype == "CD4+/CD45RO+ Memory" |
         celltype == "CD8+/CD45RA+ Naive Cytotoxic" |
         celltype == "CD4+ T Helper2" |
         celltype == "CD4+/CD25 T Reg"] <- "T cell"
celltype <- factor(celltype)
table(celltype)
diff_count_facs <- diff_count_clusters(celltype,counts)
```

These volcano plots summarize the results of the differential
expression analysis using the FACS labeling:

```{r volcano-plots-1, fig.width=7, fig.height=5.5, message=FALSE}
p1 <- volcano_plot(diff_count_facs,"CD19+ B",genes$symbol,
                   label_above_quantile = 0.9995,
				   subsample_below_quantile = 0.5,
				   filter_low_counts = 5e-5) +
  guides(fill = "none") +
  ggtitle("B cells")
p2 <- volcano_plot(diff_count_facs,"CD14+ Monocyte",genes$symbol,
                   label_above_quantile = 0.9995,
				   subsample_below_quantile = 0.5,
				   filter_low_counts = 5e-5) +
  guides(fill = "none") +
  ggtitle("CD14+ cells")
p3 <- volcano_plot(diff_count_facs,"CD34+",genes$symbol,
                   label_above_quantile = 0.999,
				   subsample_below_quantile = 0.5,
				   filter_low_counts = 5e-5) +
  guides(fill = "none") +
  ggtitle("CD34+ cells")
p4 <- volcano_plot(diff_count_facs,"CD56+ NK",genes$symbol,
                   label_above_quantile = 0.9995,
				   subsample_below_quantile = 0.5,
				   filter_low_counts = 5e-5) +
  guides(fill = "none") +
  ggtitle("NK cells")
p5 <- volcano_plot(diff_count_facs,"CD8+ Cytotoxic T",genes$symbol,
                   label_above_quantile = 0.9995,
				   subsample_below_quantile = 0.5,
				   filter_low_counts = 5e-5) +
  guides(fill = "none") +
  ggtitle("CD8+ T cells")
p6 <- volcano_plot(diff_count_facs,"T cell",genes$symbol,
                   label_above_quantile = 0.999,
				   subsample_below_quantile = 0.5,
				   filter_low_counts = 5e-5) +
  guides(fill = "none") +
  ggtitle("T cells")
plot_grid(p1,p2,p3,p4,p5,p6,nrow = 2,ncol = 3)
```

```{r volcano-plots-for-paper-1, echo=FALSE, message=FALSE, warning=FALSE, results="hide"}
x <- genes$symbol
x[which(diff_count_facs$beta[,"CD19+ B"] < 2)] <- ""
pp1 <- volcano_plot(diff_count_facs,"CD19+ B",x,
                    label_above_quantile = 0.998,
					subsample_below_quantile = 0.5,
					filter_low_counts = 5e-5) +
  ggtitle("B cells")
x <- genes$symbol
x[which(diff_count_facs$beta[,"CD14+ Monocyte"] < 2)] <- ""
pp2 <- volcano_plot(diff_count_facs,"CD14+ Monocyte",x,
                    label_above_quantile = 0.998,
				    subsample_below_quantile = 0.5,
				    filter_low_counts = 5e-5) +
  ggtitle("CD14+ cells")
x <- genes$symbol
x[which(diff_count_facs$beta[,"CD34+"] < 8 &
        diff_count_facs$Z[,"CD34+"] < 200)] <- ""
pp3 <- volcano_plot(diff_count_facs,"CD34+",x,
                    label_above_quantile = 0.95,
				    subsample_below_quantile = 0.5,
				    filter_low_counts = 5e-5) +
  ggtitle("CD34+ cells")
x <- genes$symbol
x[which(diff_count_facs$beta[,"CD56+ NK"] < 2)] <- ""
pp4 <- volcano_plot(diff_count_facs,"CD56+ NK",x,
                    label_above_quantile = 0.997,
				    subsample_below_quantile = 0.5,
				    filter_low_counts = 5e-5) +
  ggtitle("NK cells")
x <- genes$symbol
x[which(diff_count_facs$beta[,"CD8+ Cytotoxic T"] < 1)] <- ""
pp5 <- volcano_plot(diff_count_facs,"CD8+ Cytotoxic T",x,
                   label_above_quantile = 0.995,
				    subsample_below_quantile = 0.5,
				    filter_low_counts = 5e-5) +
  ggtitle("CD8+ T cells")
x <- genes$symbol
x[which(diff_count_facs$beta[,"T cell"] < 1)] <- ""
pp6 <- volcano_plot(diff_count_facs,"T cell",x,
                    label_above_quantile = 0.995,
				    subsample_below_quantile = 0.5,
				    filter_low_counts = 5e-5) +
  ggtitle("T cells")
ggsave("../plots/volcano_plots_pbmc_purified_facs.eps",
       plot_grid(pp1,pp2,pp3,pp4,pp5,pp6,nrow = 2,ncol = 3),
	   height = 7,width = 11)
```

Perform differential expression analysis using the clusters:

```{r diff-count-analysis-clusters, cache=TRUE}
table(samples$cluster)
diff_count_clusters <- diff_count_clusters(samples$cluster,counts)
```

These volcano plots summarize the results of the differential
expression analysis using the clusters:

```{r volcano-plots-2, fig.width=7, fig.height=8}
p7 <- volcano_plot(diff_count_clusters,"B",genes$symbol,
                   label_above_quantile = 0.999,
				   subsample_below_quantile = 0.5,
				   filter_low_counts = 5e-5) +
  guides(fill = "none") +
  ggtitle("B cells")
p8 <- volcano_plot(diff_count_clusters,"CD14+",genes$symbol,
                   label_above_quantile = 0.999,
				   subsample_below_quantile = 0.5,
				   filter_low_counts = 5e-5) +
  guides(fill = "none") +
  ggtitle("CD14+ cells")
p9 <- volcano_plot(diff_count_clusters,"CD34+",genes$symbol,
                   label_above_quantile = 0.999,
				   subsample_below_quantile = 0.5,
				   filter_low_counts = 5e-5) +
  guides(fill = "none") +
  ggtitle("CD34+ cells")
p10 <- volcano_plot(diff_count_clusters,"dendritic",genes$symbol,
                    label_above_quantile = 0.999,
 				    subsample_below_quantile = 0.5,
				    filter_low_counts = 5e-5) +
  guides(fill = "none") +
  ggtitle("dendritic cells")
p11 <- volcano_plot(diff_count_clusters,"NK",genes$symbol,
                    label_above_quantile = 0.999,
 				    subsample_below_quantile = 0.5,
				    filter_low_counts = 5e-5) +
  guides(fill = "none") +
  ggtitle("NK cells")
p12 <- volcano_plot(diff_count_clusters,"CD8+",genes$symbol,
                    label_above_quantile = 0.999,
 				    subsample_below_quantile = 0.5,
				    filter_low_counts = 5e-5) +
  guides(fill = "none") +
  ggtitle("CD8+ T cells")
p13 <- volcano_plot(diff_count_clusters,"T",genes$symbol,
                    label_above_quantile = 0.999,
 				    subsample_below_quantile = 0.5,
				    filter_low_counts = 5e-5) +
  guides(fill = "none") +
  ggtitle("T cells")
plot_grid(p7,p8,p9,p10,p11,p12,p13,nrow = 3,ncol = 3)
```

```{r volcano-plots-for-paper-2, echo=FALSE, message=FALSE, warning=FALSE, results="hide"}
x <- genes$symbol
x[which(diff_count_clusters$beta[,"B"] < 2)] <- ""
pp7 <- volcano_plot(diff_count_clusters,"B",x,
                    label_above_quantile = 0.998,
				    subsample_below_quantile = 0.5,
				    filter_low_counts = 5e-5) +
  ggtitle("B cells")
x <- genes$symbol
x[which(diff_count_clusters$beta[,"CD14+"] < 2)] <- ""
pp8 <- volcano_plot(diff_count_clusters,"CD14+",x,
                    label_above_quantile = 0.998,
				    subsample_below_quantile = 0.5,
				    filter_low_counts = 5e-5) +
  ggtitle("CD14+ cells")
x <- genes$symbol
x[which(diff_count_clusters$beta[,"CD34+"] < 4)] <- ""
pp9 <- volcano_plot(diff_count_clusters,"CD34+",x,
                    label_above_quantile = 0.99,
				    subsample_below_quantile = 0.5,
				    filter_low_counts = 5e-5) +
  ggtitle("CD34+ cells")
x <- genes$symbol
x[which(diff_count_clusters$beta[,"dendritic"] < 3)] <- ""
pp10 <- volcano_plot(diff_count_clusters,"dendritic",x,
                     label_above_quantile = 0.9975,
 				     subsample_below_quantile = 0.5,
				     filter_low_counts = 5e-5) +
  ggtitle("dendritic cells")
x <- genes$symbol
x[which(diff_count_clusters$beta[,"NK"] < 2)] <- ""
pp11 <- volcano_plot(diff_count_clusters,"NK",x,
                     label_above_quantile = 0.998,
 				     subsample_below_quantile = 0.5,
				     filter_low_counts = 5e-5) +
  ggtitle("NK cells")
x <- genes$symbol
x[which(diff_count_clusters$beta[,"CD8+"] < 1)] <- ""
pp12 <- volcano_plot(diff_count_clusters,"CD8+",x,
                     label_above_quantile = 0.998,
 				     subsample_below_quantile = 0.5,
				     filter_low_counts = 5e-5) +
  ggtitle("CD8+ T cells")
x <- genes$symbol
x[which(diff_count_clusters$beta[,"T"] < 1)] <- ""
pp13 <- volcano_plot(diff_count_clusters,"T",x,
                     label_above_quantile = 0.995,
 				     subsample_below_quantile = 0.5,
				     filter_low_counts = 5e-5) +
  ggtitle("T cells")
ggsave("../plots/volcano_plots_pbmc_purified_clusters.eps",
       plot_grid(pp7,pp8,pp9,pp10,pp11,pp12,pp13),
	   height = 10.5,width = 11)
```

Perform differential expression analysis using the multinomial topic
model, after removing the dendritic cells cluster, and after merging
the two T cell topics:

```{r diff-count-analysis-topics, cache=TRUE}
rows <- which(samples$cluster != "dendritic")
fit_merged <- select_loadings(fit,loadings = rows)
fit_merged <- merge_topics(fit,c(1,6))
diff_count_topics <- diff_count_analysis(fit_merged,counts)
```

Perform differential expression analysis on the T cells only:

```{r diff-count-analysis-t, cache=TRUE}
rows <- which(samples$cluster == "T")
fit_t <- select_loadings(fit,loadings = rows)
diff_count_t <- diff_count_analysis(fit_t,counts[rows,])
```

These volcano plots summarize the results of the differential
expression analysis using the topic model:

```{r volcano-plots-3, fig.width=7, fig.height=5.5, message=FALSE}
volcano_plot(diff_count_topics,"k3",genes$symbol,
             label_above_quantile = 0.998) +
  ggtitle("topic 3 (B cells)")
```

Here are more volcano plots:

```{r, eval=FALSE}
p2 <- volcano_plot_better(diff_count_topics,"k3",genes$symbol,0.998,
                          "topic 3 (B cells)")
p3 <- volcano_plot_better(diff_count_topics,"k4",genes$symbol,0.998,
                          "topic 4 (NK cells)")
p4 <- volcano_plot_better(diff_count_topics,"k2",genes$symbol,0.998,
                          "topic 2 (CD14+)")
p5 <- volcano_plot_better(diff_count_topics,"k5",genes$symbol,0.998,
                          "topic 5 (CD34+)")
p6 <- volcano_plot_better(diff_count_topics,"k1+k6",genes$symbol,0.998,
                          "topics 1 + 6 (T cells)")
p7 <- volcano_plot_better(diff_count_t,"k1",genes$symbol,0.997,
                          "topic 1 (CD4+/CD8+)")
plot_grid(p2,p3,p4,p5,p6,p7,p8,p9,nrow = 3,ncol = 3)
```

```{r volcano-plots-for-paper-3, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
p1 <- volcano_plot(diff_count_topics,"k3",genes$symbol,
                   label_above_quantile = 0.998) +
  scale_x_continuous(expand = expansion(mult = 1),breaks = seq(-10,10,5)) +
  ggtitle("topic 3 (B cells)")
ggsave("../plots/volcano_plot_pbmc_purified_bcells.eps",
       p1,height = 4,width = 8)
ggsave("../plots/volcano_plot_pbmc_purified_nk.eps",
       p3,height = 3.4,width = 3)
ggsave("../plots/volcano_plot_pbmc_purified_cd14.eps",
       p4,height = 3.4,width = 3)
ggsave("../plots/volcano_plot_pbmc_purified_cd34.eps",
       p5,height = 3.4,width = 3)
ggsave("../plots/volcano_plot_pbmc_purified_tcells.eps",
       p6,height = 3.4,width = 3)
ggsave("../plots/volcano_plot_pbmc_purified_cd4cd8.eps",
       p7,height = 3.4,width = 3)
ggsave("../plots/volcano_plot_pbmc_purified_cd8.eps",
       p8,height = 3.4,width = 3)
ggsave("../plots/volcano_plot_pbmc_purified_dendritic.eps",
       p9,height = 3.4,width = 3)
```

The results of the differential expression analyses can also be
browsed in interactive volcano plots:

```{r volcano-plots-4, results="hide", eval=FALSE}
volcano_plotly(diff_count_topics,"k3","volcano_plot_purified_pbmc_bcells.html",
               genes$symbol,title = "topic 3 (B cells)")
volcano_plotly(diff_count_topics,"k4","volcano_plot_purified_pbmc_nk.html",
 		       genes$symbol,title = "topic 4 (NK cells)")
volcano_plotly(diff_count_topics,"k2","volcano_plot_purified_pbmc_cd14.html",
			   genes$symbol,title = "topic 2 (CD14+)")
volcano_plotly(diff_count_topics,"k5","volcano_plot_purified_pbmc_cd34.html",
			   genes$symbol,title = "topic 5 (CD34+)")
volcano_plotly(diff_count_topics,"k1+k6",
			   "volcano_plot_purified_pbmc_tcells.html",genes$symbol,
               title = "topics 1 + 6 (T cells)")
volcano_plotly(diff_count_t,"k1","volcano_plot_purified_pbmc_cd4cd8.html",
			   genes$symbol,title = "topic 1 (CD4+/CD8+)")
volcano_plotly(diff_count_clusters,"CD8+",
			   "volcano_plot_purified_pbmc_cd8.html",genes$symbol,
               title = "CD8+ cluster")
volcano_plotly(diff_count_clusters,"dendritic",
			   "volcano_plot_purified_pbmc_dendritic.html",genes$symbol,
               title = "dendritic cells cluster")
```

The interactive volcano plots can also be viewed by clicking on these
links:

+ [topic 3 (B cells)](volcano_plot_purified_pbmc_bcells.html)

+ [topic 4 (NK cells)](volcano_plot_purified_pbmc_nk.html)

+ [topic 2 (CD14+)](volcano_plot_purified_pbmc_cd14.html)

+ [topic 5 (CD34+)](volcano_plot_purified_pbmc_cd34.html)

+ [topics 1 and 6 (T cells)](volcano_plot_purified_pbmc_tcells.html)

+ [topic 1 (CD4+/CD8+ lineage differentiation)](volcano_plot_purified_pbmc_cd4cd8.html)

+ [CD8+ cluster](volcano_plot_purified_pbmc_cd8.html)

+ [dendritic cells cluster](volcano_plot_purified_pbmc_dendritic.html)

```{r topics-vs-facs-scatterplots, fig.width=7, fig.height=7.5, eval=FALSE}
p10 <- lfc_scatterplot(diff_count_facs,diff_count_topics,"CD19+ B","k3",
                       genes$symbol,label_above_quantile = 0.998,
                       xlab = "B cells FACS subpopulation",ylab = "topic 3")
p11 <- lfc_scatterplot(diff_count_facs,diff_count_topics,"CD56+ NK","k4",
                       genes$symbol,label_above_quantile = 0.998,
                       xlab = "NK cells FACS subpopulation",ylab = "topic 4")
p12 <- lfc_scatterplot(diff_count_facs,diff_count_topics,"CD14+ Monocyte","k2",
                       genes$symbol,label_above_quantile = 0.998,
                       xlab = "CD14+ FACS subpopulation",ylab = "topic 2")
p13 <- lfc_scatterplot(diff_count_facs,diff_count_topics,"CD34+","k5",
                       genes$symbol,label_above_quantile = 0.998,
                       xlab = "CD34+ FACS subpopulation",ylab = "topic 4")
p14 <- lfc_scatterplot(diff_count_facs,diff_count_topics,"T cell","k1+k6",
                       genes$symbol,label_above_quantile = 0.998,
                       xlab = "T cells FACS subpopulation",
					   ylab = "topics 1 + 6")
plot_grid(p10,p11,p12,p13,p14,nrow = 3,ncol = 2)
```

```{r scatterplots-for-paper, echo=FALSE, results="hide", eval=FALSE}
ggsave("../plots/scatterplot_pbmc_purified_bcells.eps",
       p10,height = 3,width = 4)
ggsave("../plots/scatterplot_pbmc_purified_nk.eps",
       p11,height = 3,width = 4)
ggsave("../plots/scatterplot_pbmc_purified_cd14.eps",
       p12,height = 3,width = 4)
ggsave("../plots/scatterplot_pbmc_purified_cd34.eps",
       p13,height = 3,width = 4)
ggsave("../plots/scatterplot_pbmc_purified_tcells.eps",
       p14,height = 3,width = 4)
```
