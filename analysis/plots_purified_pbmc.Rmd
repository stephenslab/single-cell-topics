---
title: Perform differential expression analysis on topics and clusters identified in mixture of FACS-purified PBMC data
author: Peter Carbonetto
output: workflowr::wflow_html
---

Here we perform a differential expression analysis using the topic
model fit to the mixture of FACS-purified data, as well as the
clusters identified from this topic model.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below, as well as additional
functions that we will use to generate some of the plots.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(fastTopics)
library(fgsea)
library(ggplot2)
library(ggrepel)
library(cowplot)
library(plotly)
library(htmlwidgets)
source("../code/gsea.R")
source("../code/functions_for_plots_purified_pbmc.R")
```

Load the count data, the $K = 6$ topic model fit, and the 7 clusters
identified in the [clustering analysis](clusters_purified_pbmc.html).

```{r load-data}
load("../data/pbmc_purified.RData")
fit <- readRDS(file.path("../output/pbmc-purified/rds",
                         "fit-pbmc-purified-scd-ex-k=6.rds"))$fit
fit <- poisson2multinom(fit)
samples <- readRDS("../output/pbmc-purified/clustering-pbmc-purified.rds")
```

Load the gene set data.

```{r load-gene-sets}
load("../data/gene_sets_human.RData")
rownames(gene_sets) <- gene_info$Ensembl
```

Perform differential expression analysis using the FACS labeling:

```{r diff-count-analysis-subpop, cache=TRUE}
celltype <- as.character(samples$celltype)
celltype[celltype == "CD4+/CD45RA+/CD25- Naive T" |
         celltype == "CD4+/CD45RO+ Memory" |
         celltype == "CD8+/CD45RA+ Naive Cytotoxic" |
         celltype == "CD4+ T Helper2" |
         celltype == "CD4+/CD25 T Reg"] <- "T cell"
celltype <- factor(celltype)
table(celltype)
diff_count_facs <- diff_count_clusters(celltype,counts)
```

These volcano plots summarize the results of the differential
expression analysis using the FACS labeling:

```{r volcano-plots-1, fig.width=7, fig.height=5.5, message=FALSE}
p1 <- volcano_plot(diff_count_facs,"CD19+ B",genes$symbol,
                   betamax = 10,label_above_quantile = 0.995,
				   subsample_below_quantile = 0.5) +
  guides(fill = "none") +
  ggtitle("B cells")
p2 <- volcano_plot(diff_count_facs,"CD14+ Monocyte",genes$symbol,
                   betamax = 10,label_above_quantile = 0.995,
				   subsample_below_quantile = 0.5) +
  guides(fill = "none") +
  ggtitle("CD14+ cells")
p3 <- volcano_plot(diff_count_facs,"CD34+",genes$symbol,
                   betamax = 10,label_above_lfc = 2,
				   label_above_quantile = 0.995,
				   subsample_below_quantile = 0.5) +
  guides(fill = "none") +
  ggtitle("CD34+ cells")
p4 <- volcano_plot(diff_count_facs,"CD56+ NK",genes$symbol,
                   betamax = 10,label_above_quantile = 0.995,
				   subsample_below_quantile = 0.5) +
  guides(fill = "none") +
  ggtitle("NK cells")
p5 <- volcano_plot(diff_count_facs,"CD8+ Cytotoxic T",genes$symbol,
                   betamax = 10,label_above_quantile = 0.995,
				   subsample_below_quantile = 0.5) +
  guides(fill = "none") +
  ggtitle("CD8+ T cells")
p6 <- volcano_plot(diff_count_facs,"T cell",genes$symbol,
                   betamax = 10,label_above_quantile = 0.998,
				   subsample_below_quantile = 0.5) +
  guides(fill = "none") +
  ggtitle("T cells")
plot_grid(p1,p2,p3,p4,p5,p6,nrow = 2,ncol = 3)
```

```{r volcano-plots-for-paper-1, echo=FALSE, message=FALSE, warning=FALSE, results="hide"}
pp1 <- volcano_plot(diff_count_facs,"CD19+ B",genes$symbol,betamax = 10,
                    label_above_lfc = 2,label_above_quantile = 0.99,
					subsample_below_quantile = 0.5) +
  ggtitle("B cells")
pp2 <- volcano_plot(diff_count_facs,"CD14+ Monocyte",genes$symbol,betamax = 10,
                    label_above_lfc = 2,label_above_quantile = 0.99,
				    subsample_below_quantile = 0.5) +
  ggtitle("CD14+ cells")
pp3 <- volcano_plot(diff_count_facs,"CD34+",genes$symbol,betamax = 10,
                    label_above_lfc = 5,label_above_quantile = 0.98,
				    subsample_below_quantile = 0.5) +
  ggtitle("CD34+ cells")
pp4 <- volcano_plot(diff_count_facs,"CD56+ NK",genes$symbol,betamax = 10,
                    label_above_lfc = 2,label_above_quantile = 0.99,
				    subsample_below_quantile = 0.5) +
  ggtitle("NK cells")
pp5 <- volcano_plot(diff_count_facs,"CD8+ Cytotoxic T",genes$symbol,
                    betamax = 10,label_above_lfc = 1,
					label_above_quantile = 0.98,
				    subsample_below_quantile = 0.5) +
  ggtitle("CD8+ T cells")
pp6 <- volcano_plot(diff_count_facs,"T cell",genes$symbol,betamax = 10,
                    label_above_lfc = 1,label_above_quantile = 0.993,
				    subsample_below_quantile = 0.5) +
  ggtitle("T cells")
ggsave("../plots/volcano_plots_pbmc_purified_facs.eps",
       plot_grid(pp1,pp2,pp3,pp4,pp5,pp6,nrow = 2,ncol = 3),
	   height = 7,width = 11)
```

Perform differential expression analysis using the clusters:

```{r diff-count-analysis-clusters, cache=TRUE}
table(samples$cluster)
diff_count_clusters <- diff_count_clusters(samples$cluster,counts)
```

These volcano plots summarize the results of the differential
expression analysis using the clusters:

```{r volcano-plots-2, fig.width=7, fig.height=8, message=FALSE}
p7 <- volcano_plot(diff_count_clusters,"B",genes$symbol,betamax = 10,
                   label_above_quantile = 0.995,
				   subsample_below_quantile = 0.5) +
  guides(fill = "none") +
  ggtitle("B cells")
p8 <- volcano_plot(diff_count_clusters,"CD14+",genes$symbol,betamax = 10,
                   label_above_quantile = 0.993,
				   subsample_below_quantile = 0.5) +
  guides(fill = "none") +
  ggtitle("CD14+ cells")
p9 <- volcano_plot(diff_count_clusters,"CD34+",genes$symbol,betamax = 10,
                   label_above_lfc = 4,label_above_quantile = 0.99,
				   subsample_below_quantile = 0.5) +
  guides(fill = "none") +
  ggtitle("CD34+ cells")
p10 <- volcano_plot(diff_count_clusters,"dendritic",genes$symbol,betamax = 10,
                    label_above_lfc = 4,label_above_quantile = 0.98,
 				    subsample_below_quantile = 0.5) +
  guides(fill = "none") +
  ggtitle("dendritic cells")
p11 <- volcano_plot(diff_count_clusters,"NK",genes$symbol,betamax = 10,
                    label_above_lfc = 2,label_above_quantile = 0.995,
 				    subsample_below_quantile = 0.5) +
  guides(fill = "none") +
  ggtitle("NK cells")
p12 <- volcano_plot(diff_count_clusters,"CD8+",genes$symbol,betamax = 10,
                    label_above_lfc = 2,label_above_quantile = 0.98,
 				    subsample_below_quantile = 0.5) +
  guides(fill = "none") +
  ggtitle("CD8+ T cells")
p13 <- volcano_plot(diff_count_clusters,"T",genes$symbol,betamax = 10,
                    label_above_lfc = 2,label_above_quantile = 0.995,
 				    subsample_below_quantile = 0.5) +
  guides(fill = "none") +
  ggtitle("T cells")
plot_grid(p7,p8,p9,p10,p11,p12,p13,nrow = 3,ncol = 3)
```

```{r volcano-plots-for-paper-2, echo=FALSE, message=FALSE, warning=FALSE, results="hide"}
pp7 <- volcano_plot(diff_count_clusters,"B",genes$symbol,betamax = 10,
                    label_above_lfc = 2,label_above_quantile = 0.99,
				    subsample_below_quantile = 0.5) +
  ggtitle("B cells")
pp8 <- volcano_plot(diff_count_clusters,"CD14+",genes$symbol,betamax = 10,
                    label_above_lfc = 2,label_above_quantile = 0.99,
				    subsample_below_quantile = 0.5) +
  ggtitle("CD14+ cells")
pp9 <- volcano_plot(diff_count_clusters,"CD34+",genes$symbol,betamax = 10,
                    label_above_lfc = 5,label_above_quantile = 0.98,
				    subsample_below_quantile = 0.5) +
  ggtitle("CD34+ cells")
pp10 <- volcano_plot(diff_count_clusters,"dendritic",genes$symbol,betamax = 10,
                     label_above_lfc = 4,label_above_quantile = 0.96,
 				     subsample_below_quantile = 0.5) +
  ggtitle("dendritic cells")
pp11 <- volcano_plot(diff_count_clusters,"NK",genes$symbol,betamax = 10,
                     label_above_lfc = 2,label_above_quantile = 0.99,
 				     subsample_below_quantile = 0.5) +
  ggtitle("NK cells")
pp12 <- volcano_plot(diff_count_clusters,"CD8+",genes$symbol,betamax = 10,
                     label_above_lfc = 2,label_above_quantile = 0.96,
 				     subsample_below_quantile = 0.5) +
  ggtitle("CD8+ T cells")
pp13 <- volcano_plot(diff_count_clusters,"T",genes$symbol,betamax = 10,
                     label_above_lfc = 2,label_above_quantile = 0.993,
 				     subsample_below_quantile = 0.5) +
  ggtitle("T cells")
ggsave("../plots/volcano_plots_pbmc_purified_clusters.eps",
       plot_grid(pp7,pp8,pp9,pp10,pp11,pp12,pp13,nrow = 3,ncol = 3),
	   height = 10.5,width = 11)
```

Perform differential expression analysis using the multinomial topic
model, after removing the dendritic cells cluster:

```{r diff-count-analysis-topics, cache=TRUE}
rows <- which(samples$cluster != "dendritic")
fit_no_dendritic <- select_loadings(fit,loadings = rows)
diff_count_topics <- diff_count_analysis(fit_no_dendritic,counts[rows,])
```

These volcano plots summarize the results of the differential
expression analysis using the topic model:

```{r volcano-plots-3, fig.width=7, fig.height=5.5, message=FALSE}
p14 <- volcano_plot(diff_count_topics,"k3",genes$symbol,
                    label_above_lfc = 4,label_above_quantile = 0.995,
 				    subsample_below_quantile = 0.5) +
  guides(fill = "none") +
  ggtitle("topic 3 (B cells)")
p15 <- volcano_plot(diff_count_topics,"k2",genes$symbol,
                    label_above_quantile = 0.994,
 				    subsample_below_quantile = 0.5) +
  guides(fill = "none") +
  ggtitle("topic 2 (CD14+ cells)")
p16 <- volcano_plot(diff_count_topics,"k5",genes$symbol,
                    label_above_lfc = 2,label_above_quantile = 0.995,
 				    subsample_below_quantile = 0.5) +
  guides(fill = "none") +
  ggtitle("topic 5 (CD34+ cells)")
p17 <- volcano_plot(diff_count_topics,"k4",genes$symbol,
                    label_above_lfc = 4,label_above_quantile = 0.995,
 				    subsample_below_quantile = 0.5) +
  guides(fill = "none") +
  ggtitle("topic 4 (NK cells)")
p18 <- volcano_plot(diff_count_topics,"k1",genes$symbol,
                    label_above_quantile = 0.998,
 				    subsample_below_quantile = 0.5) +
  guides(fill = "none") +
  ggtitle("topic 1 (T cells)")
p19 <- volcano_plot(diff_count_topics,"k6",genes$symbol,
                    label_above_quantile = 0.998,
 				    subsample_below_quantile = 0.5) +
  guides(fill = "none") +
  ggtitle("topic 6 (ribosomal proteins)")
plot_grid(p14,p15,p16,p17,p18,p19,nrow = 2,ncol = 3)
```

```{r volcano-plots-for-paper-3, echo=FALSE, message=FALSE, warning=FALSE}
pp14 <- volcano_plot(diff_count_topics,"k3",genes$symbol,
                     label_above_lfc = 5,label_above_quantile = 0.985,
 				     subsample_below_quantile = 0.5) +
  ggtitle("topic 3 (B cells)")
pp15 <- volcano_plot(diff_count_topics,"k2",genes$symbol,
                     label_above_lfc = 8,label_above_quantile = 0.97,
 				     subsample_below_quantile = 0.5) +
  ggtitle("topic 2 (CD14+ cells)")
pp16 <- volcano_plot(diff_count_topics,"k5",genes$symbol,
                     label_above_lfc = 8,label_above_quantile = 0.98,
 				     subsample_below_quantile = 0.5) +
  ggtitle("topic 5 (CD34+ cells)")
pp17 <- volcano_plot(diff_count_topics,"k4",genes$symbol,
                     label_above_lfc = 8,label_above_quantile = 0.97,
 				     subsample_below_quantile = 0.5) +
  ggtitle("topic 4 (NK cells)")
pp18 <- volcano_plot(diff_count_topics,"k1",genes$symbol,
                     label_above_lfc = 6,label_above_quantile = 0.98,
 				     subsample_below_quantile = 0.5) +
  ggtitle("topic 1 (T cells)")
pp19 <- volcano_plot(diff_count_topics,"k6",genes$symbol,
                     label_above_quantile = 0.997,
 				     subsample_below_quantile = 0.5) +
  ggtitle("topic 6 (ribosomal proteins)")
ggsave("../plots/volcano_plots_pbmc_purified_topics.eps",
       plot_grid(pp14,pp15,pp16,pp17,pp18,pp19,nrow = 2,ncol = 3),
	   height = 7,width = 11)
```

The results of the differential expression analysis can also be
browsed in interactive volcano plots:

```{r volcano-plots-5, results="hide", message=FALSE}
volcano_plotly(diff_count_topics,"k3",
               "volcano_plot_purified_pbmc_bcells.html",
               genes$symbol,title = "topic 3 (B cells)",
			   subsample_below_quantile = 0.5,
			   width = 450,height = 500)
volcano_plotly(diff_count_topics,"k2",
               "volcano_plot_purified_pbmc_cd14.html",
			   genes$symbol,title = "topic 2 (CD14+)",
			   subsample_below_quantile = 0.5,
			   width = 450,height = 500)
volcano_plotly(diff_count_topics,"k5",
               "volcano_plot_purified_pbmc_cd34.html",
			   genes$symbol,title = "topic 5 (CD34+)",
			   subsample_below_quantile = 0.5,
			   width = 450,height = 500)
volcano_plotly(diff_count_topics,"k4",
               "volcano_plot_purified_pbmc_nk.html",
 		       genes$symbol,title = "topic 4 (NK cells)",
			   subsample_below_quantile = 0.5,
			   width = 450,height = 500)
volcano_plotly(diff_count_topics,"k1",
			   "volcano_plot_purified_pbmc_tcells.html",
               genes$symbol,title = "topic 1 (T cells)",
			   subsample_below_quantile = 0.5,
			   width = 450,height = 500)
volcano_plotly(diff_count_topics,"k6",
			   "volcano_plot_purified_pbmc_ribosomal_proteins.html",
               genes$symbol,title = "topic 6 (ribosomal proteins)",
			   subsample_below_quantile = 0.5,
			   width = 450,height = 500)
volcano_plotly(diff_count_clusters,"CD8+",
			   "volcano_plot_purified_pbmc_cd8.html",
			   genes$symbol,title = "CD8+ cluster",
			   subsample_below_quantile = 0.5,
			   width = 450,height = 500)
volcano_plotly(diff_count_clusters,"dendritic",
			   "volcano_plot_purified_pbmc_dendritic.html",
			   genes$symbol,title = "dendritic cells cluster",
			   subsample_below_quantile = 0.5,
			   width = 450,height = 500)
```

The interactive volcano plots may also be viewed by clicking these
links: [topic 3 (B cells)](volcano_plot_purified_pbmc_bcells.html),
[topic 4 (NK cells)](volcano_plot_purified_pbmc_nk.html),
[topic 2 (CD14+)](volcano_plot_purified_pbmc_cd14.html),
[topic 5 (CD34+)](volcano_plot_purified_pbmc_cd34.html),
[topics 1 (T cells)](volcano_plot_purified_pbmc_tcells.html),
[topics 6 (T cells)](volcano_plot_purified_pbmc_ribosomal_proteins.html),
[CD8+ cluster](volcano_plot_purified_pbmc_cd8.html) and
[dendritic cells cluster](volcano_plot_purified_pbmc_dendritic.html).

The volcano plot for topic 6 suggests an enrichment of ribosomal
protein genes. Indeed, there is a very strong correlation between the
topic 6 mixture proportion and the fraction of total expression
attributed to ribosomal genes:

```{r ribosomal-proteins-topic-6, fig.width=7, fig.height=2.5, message=FALSE}
rpgenes <- c("RPS2","RPS3","RPS3A","RPS4X","RPS6","RPS7","RPS8","RPS9",
             "RPS10","RPS11","RPS12","RPS13","RPS14","RPS15","RPS15A",
			 "RPS16","RPS17","RPS18","RPS19","RPS20","RPS21","RPS23",
			 "RPS24","RPS25","RPS26","RPS27","RPS27A","RPS28","RPS29",
			 "RPL3","RPL4","RPL5","RPL6","RPL7A","RPL8","RPL9","RPL10",
			 "RPL10A","RPL12","RPL13A","RPL14","RPL15","RPL17","RPL18",
			 "RPL18A","RPL19","RPL21","RPL22","RPL23","RPL23A","RPL24",
			 "RPL26","RPL27A","RPL30","RPL31","RPL32","RPL34","RPL35",
			 "RPL36","RPL36A","RPL37","RPL39","RPL41")
rgscatterplot <- function (i, title = NULL) {
  j    <- which(is.element(genes$symbol,rpgenes))
  pdat <- data.frame(x = fit$L[i,6],
                     y = rowSums(counts[i,j])/rowSums(counts[i,]))
  return(ggplot(pdat,aes(x = x,y = y)) +
         geom_point() +
         geom_smooth(method = "lm",se = FALSE,color = "dodgerblue",
                     size = 0.5,linetype = "dashed") +
         ylim(0,0.6) +
         labs(x     = "topic 6 proportion",
              y     = "ribosomal expression",
	          title = title) + 
         theme_cowplot(font_size = 10) +
         theme(plot.title = element_text(size = 10,face = "plain")))
}
p20 <- rgscatterplot(which(celltype == "CD19+ B"),"B cells")
p21 <- rgscatterplot(which(celltype == "CD34+"),"CD34+ cells")
p22 <- rgscatterplot(which(!(celltype == "CD19+ B" | celltype == "CD34+")),
                     "all other cells")
plot_grid(p20,p21,p22,nrow = 1,ncol = 3)
```

The list of ribosomal protein genes comes from [Yoshihama *et al*
(2002)][yoshihama-2002].

Four out of the 6topics closely correspond to the FACS cell
populations: B cells, T cells, NK cells and CD14+ cells. We would
expect then that the differential expression in these 4 topics is
similar to differential expression in the corresponding FACS
populations. Let's check this.

```{r topics-vs-facs-scatterplots-1, cache=TRUE}
celltype <- as.character(celltype)
celltype[celltype == "CD8+ Cytotoxic T"] <- "T cell"
celltype <- factor(celltype)
table(celltype)
diff_count_facs <- diff_count_clusters(celltype,counts)
```

These scatterplots compare log-fold change estimated using the FACS
labeling and using the topic model. Some of the top genes in each
topic are highlighted.

```{r topics-vs-facs-scatterplots-2, fig.width=7, fig.height=5}
p23 <- lfc_scatterplot(diff_count_facs,diff_count_topics,"CD19+ B","k3",
                       genes$symbol,label_above_lfc = 6,
					   label_above_quantile = 0.99,
                       xlab = "B cells FACS subpopulation",ylab = "topic 3")
p24 <- lfc_scatterplot(diff_count_facs,diff_count_topics,"CD14+ Monocyte",
                       "k2",genes$symbol,label_above_lfc = 6,
					   label_above_quantile = 0.98,
                       xlab = "CD14+ FACS subpopulation",ylab = "topic 2")
p25 <- lfc_scatterplot(diff_count_facs,diff_count_topics,"CD56+ NK","k4",
                       genes$symbol,label_above_lfc = 5,
					   label_above_quantile = 0.99,
                       xlab = "NK cells FACS subpopulation",ylab = "topic 4")
p26 <- lfc_scatterplot(diff_count_facs,diff_count_topics,"T cell","k1",
                       genes$symbol,label_above_lfc = 5,
					   label_above_quantile = 0.99,
                       xlab = "T cells FACS subpopulation",
					   ylab = "topic 1")
plot_grid(p23,p24,p25,p26,nrow = 2,ncol = 2)
```

Overall, the LFC estimates are strongly correlated. But the
differential expression in the topic is much higher for many of the
top genes. In particular, the topic model seems to be more adept at
picking out cell-type-specific genes---that is, genes that are
uniquely expressed in a cell type.

```{r scatterplots-for-paper, echo=FALSE, results="hide"}
ggsave("../plots/scatterplots_topics_vs_facs_pbmc_purified.eps",
       plot_grid(p23,p24,p25,p26,nrow = 2,ncol = 2),
	   height = 7,width = 9)
```

Prepare the gene set data and differential expression results for the
gene set enrichment analysis. First, align the gene-set data with the
gene-wise statistics.

```{r gsea-1, eval=FALSE}
de        <- diff_count_topics
out       <- align_gene_data(gene_sets,de)
gene_sets <- out$gene_sets
de        <- out$diff_count_res
ids       <- rownames(gene_sets)
gene_info <- gene_info[match(ids,gene_info$Ensembl),]
genes     <- genes[match(ids,genes$ensembl),]
```

Next, remove gene sets with fewer than 4 genes, and with more than
400 genes.

```{r gsea-2, eval=FALSE}
i <- which(colSums(gene_sets) >= 4 & colSums(gene_sets) <= 400)
gene_set_info <- gene_set_info[i,]
gene_sets     <- gene_sets[,i]
```

For each topic, perform a gene-set enrichment analysis using fgsea.

```{r gsea-3, eval=FALSE, cache=TRUE}
gsea_res <- perform_gsea_all_topics(gene_sets,de,nproc = 4)
```

*Add text here.*

```{r gsea-4, eval=FALSE}
gsea_res$ES[is.na(gsea_res$ES)] <- 0
p <- create_gsea_plotly(gene_set_info,gsea_res,1,title = "")
saveWidget(p,"gsea_plot.html",selfcontained = TRUE)
```

[yoshihama-2002]: https://doi.org/10.1101/gr.214202
