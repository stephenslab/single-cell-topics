---
title: "Identify clusters in 68k PBMC data using topic model"
author: Peter Carbonetto
output: workflowr::wflow_html
---

Here we identify clusters of cells from the mixture proportions
estimated in the 68k PBMC data.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below, as well as additional
functions that we will use to generate some of the plots.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(fastTopics)
library(ggplot2)
library(cowplot)
```

Load the count data.

```{r load-data}
load("../data/pbmc_68k.RData")
```

Load the $K = 12$ Poisson NMF model fit.

```{r load-fit}
fit <- readRDS("../output/pbmc-68k/rds/fit-pbmc-68k-scd-ex-k=12.rds")$fit
fit <- poisson2multinom(fit)
```

From the PCs of the mixture proportions, we define clusters...

```{r clustering-1}
pca  <- prcomp(fit$L)$x
n    <- nrow(pca)
x    <- rep("U",n)
pc2  <- pca[,2]
pc4  <- pca[,4]
pc8  <- pca[,8]
pc10 <- pca[,10]
x[pc2 < -0.4] <- "B"
x[pc4 < -0.15] <- "CD14+"
x[pc8 > 0.2] <- "dendritic"
x[pc10 > 0.1] <- "CD34+"
```

*Add text here.*

```{r clustering-2}
rows <- which(x == "U")
n    <- length(rows)
fit2 <- select_loadings(fit,loadings = rows)
pca  <- prcomp(fit2$L)$x
y    <- rep("T",n)
pc1  <- pca[,1]
pc2  <- pca[,2]
y[pc2 > -1.7*pc1 - 0.11] <- "CD8+"
y[pc2 > -1.55*pc1 + 0.55] <- "NK"
x[rows] <- y
```

*Add text here.*

```{r clustering-3}
rows <- which(x == "CD14+")
n    <- length(rows)
fit2 <- select_loadings(fit,loadings = rows)
pca  <- prcomp(fit2$L)$x
y    <- rep("CD14+ A",n)
pc1  <- pca[,1]
y[pc1 > 0] <- "CD14+ B"
x[rows] <- y
```

*Add text here.*

In summary, we have subdivided the cells into 8 subsets:

```{r clustering-4}
samples$cluster <- factor(x)
table(samples$cluster)
```

```{r, eval=FALSE}
facs_colors <- c("forestgreen",
                 "dodgerblue",
                 "darkmagenta",
                 "firebrick",
                 "gray",
                 "tomato",
                 "yellow",
                 "magenta",
                 "darkorange",
                 "gold",
                 "darkblue",
                 "greenyellow")
p1 <- pca_plot(fit2,pcs = 1:2,fill = samples$celltype[rows]) +
  scale_fill_manual(values = facs_colors)
p2 <- pca_plot(fit2,pcs = 1:2,fill = factor(x[rows]))
p3 <- pca_hexbin_plot(fit2,pcs = 1:2) +
  scale_x_continuous(breaks = seq(-1,1,0.1)) +
  scale_y_continuous(breaks = seq(-1,1,0.1)) +
  theme_cowplot(font_size = 8)
plot_grid(p1,p2,p3,rel_widths = c(4,3,3),ncol = 3)
```
