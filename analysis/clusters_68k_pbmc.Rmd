---
title: "Identify clusters in 68k PBMC data using topic model"
author: Peter Carbonetto
output: workflowr::wflow_html
---

Here we identify clusters of cells from the mixture proportions
estimated in the 68k PBMC data.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below, as well as additional
functions that we will use to generate some of the plots.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(fastTopics)
library(ggplot2)
library(cowplot)
```

Load the count data.

```{r load-data}
load("../data/pbmc_68k.RData")
```

Load the $K = 12$ Poisson NMF model fit.

```{r load-fit}
fit <- readRDS("../output/pbmc-68k/rds/fit-pbmc-68k-scd-ex-k=12.rds")$fit
fit <- poisson2multinom(fit)
```

From the PCs of the mixture proportions, we define clusters...

```{r clustering-1}
pca  <- prcomp(fit$L)$x
n    <- nrow(pca)
x    <- rep("U",n)
pc2  <- pca[,2]
pc4  <- pca[,4]
pc8  <- pca[,8]
pc10 <- pca[,10]
x[pc2 < -0.4] <- "B"
x[pc4 < -0.15] <- "CD14+"
x[pc8 > 0.2] <- "dendritic"
x[pc10 > 0.1] <- "CD34+"
```

*Add text here.*

```{r clustering-2}
rows <- which(x == "U")
n    <- length(rows)
fit2 <- select_loadings(fit,loadings = rows)
pca  <- prcomp(fit2$L)$x
y    <- rep("T",n)
pc1  <- pca[,1]
pc2  <- pca[,2]
y[pc2 > -1.7*pc1 - 0.11] <- "CD8+"
y[pc2 > -1.55*pc1 + 0.55] <- "NK"
x[rows] <- y
```

*Add text here.*

```{r clustering-3}
rows <- which(x == "CD14+")
n    <- length(rows)
fit2 <- select_loadings(fit,loadings = rows)
pca  <- prcomp(fit2$L)$x
y    <- rep("CD14+ A",n)
pc1  <- pca[,1]
y[pc1 > 0] <- "CD14+ B"
x[rows] <- y
```

*Add text here.*

```{r clustering-4}
rows <- which(x == "T")
n    <- length(rows)
fit2 <- select_loadings(fit,loadings = rows)
pca  <- prcomp(fit2$L)$x
y    <- rep("TA",n)
pc1  <- pca[,1]
pc2  <- pca[,2]
y[pc2 > -1.5*pc1 - 0.05] <- "TB"
x[rows] <- y
```

In summary, we have subdivided the cells into 9 subsets:

```{r clustering-5}
samples$cluster <- factor(x)
table(samples$cluster)
```

The Structure plot summarizes the mixture proportions in each of the 9
clusters:

```{r structure-plot, fig.width=8, fig.height=1.6, results="hide", message=FALSE}
set.seed(1)
topic_colors <- c("darkmagenta", # CD34+
                  "darkgray",    # NK 2
                  "darkorange",  # T cells 2
				  "skyblue",     # dendritic
                  "red",         # T cells 3
				  "wheat",       # (unknown)
				  "dimgray",     # NK 1
				  "azure",       # (unknown)
				  "forestgreen", # CD14+ A
				  "gold",        # T cells 1
				  "olivedrab",   # CD14+ B
				  "dodgerblue")  # B cells
topics <- c(6,8,5,2,7,9,11,4,3,10,1,12)
x    <- samples$cluster
x    <- factor(x,c("B","CD14+ A","CD14+ B","CD34+","dendritic",
                   "NK","CD8+","TA","TB"))
rows <- sort(c(sample(which(x == "B"),500),
               sample(which(x == "CD14+ A"),300),
               sample(which(x == "CD14+ B"),300),
               which(x == "CD34+"),
               sample(which(x == "CD8+"),500),
               sample(which(x == "dendritic"),250),
               sample(which(x == "NK"),500),
               sample(which(x == "TB"),600),
               sample(which(x == "TA"),400)))
p1 <- structure_plot(select_loadings(fit,loadings = rows),
                     grouping = x[rows],topics = topics,
                     colors = topic_colors[topics],
					 perplexity = c(70,30,30,30,30,70,70,70,70),
   	  			     n = Inf,gap = 25,num_threads = 4,verbose = FALSE)
print(p1)
```

```{r structure-plots-for-paper, echo=FALSE, results="hide"}
ggsave("../plots/structure_plot_pbmc_68k.eps",p1,height = 1.6,width = 8)
```

Save the clustering of the 68k PBMC data to an RDS file.

```{r save-results}
saveRDS(samples,"clustering-pbmc-68k.rds")
```
