---
title: "Differential expression analysis using a topic model: illustration in mixture of FACS-purified PBMC data"
author: Peter Carbonetto
output: workflowr::wflow_html
---

The aim of this analysis is to understand the differences between a
classical differential expresion analysis comparing expression among
cell types (implemented using DESEq2) and a differential expression
analysis using the topic model, which allows for grades of membership
to cell types or cell states.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Begin by loading the packages used in the analysis.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(fastTopics)
library(ggplot2)
library(cowplot)
```

Load the UMI gene count data.

```{r load-data}
load("../data/pbmc_purified.RData")
```

Load the $K = 6$ Poisson NMF model fit, and convert it to a
topic model.

```{r load-fit}
fit <- readRDS(file.path("../output/pbmc-purified/rds",
                         "fit-pbmc-purified-scd-ex-k=6.rds"))$fit
fit <- poisson2multinom(fit)
```

The cells are subdivided, based on FACS sorting, into 10 "cell types",
almost many of the cell types are virtually indistinguishable based on
their gene expression, so we combine them into a single "T cell"
category. This results in 5 predefined cell types:

```{r cell-types}
set.seed(1)
celltype <- as.character(samples$celltype)
celltype[celltype == "CD4+ T Helper2" |
         celltype == "CD4+/CD45RO+ Memory" |
         celltype == "CD8+/CD45RA+ Naive Cytotoxic" |
         celltype == "CD4+/CD45RA+/CD25- Naive T" |
         celltype == "CD8+ Cytotoxic T" |
         celltype == "CD4+/CD25 T Reg"] <- "T cell"
celltype <- factor(celltype,
                   c("CD19+ B","CD14+ Monocyte","CD34+","CD56+ NK","T cell"))
table(celltype)
```

This Structure plot, in which cells are arranged horizontally
according to their predefined cell type, shows how the estimated topic
proportions relate to the predefined cell types.

```{r structure-plot, fig.width=8, fig.height=1.8}
topic_colors <- c("gold","forestgreen","dodgerblue","gray",
                  "darkmagenta","violet")
topics <- c(5,3,2,4,1,6)
rows <- sort(c(sample(which(celltype == "CD19+ B"),500),
               sample(which(celltype == "CD14+ Monocyte"),250),
               sample(which(celltype == "CD34+"),500),
               sample(which(celltype == "CD56+ NK"),400),
               sample(which(celltype == "T cell"),1000)))
p1 <- structure_plot(select_loadings(fit,loadings = rows),
                     grouping = celltype[rows],
                     topics = topics,colors = topic_colors[topics],
   	  			     perplexity = c(70,30,30,30,70),n = Inf,gap = 30,
					 num_threads = 4,verbose = FALSE)
print(p1)
```

In particular, topics 1 through 4 closely correspond, respectively, to
T cells, CD14+ monocytes (myeloid cells), B cells and natural killer
cells. Topic 5 (violet) also closely corresponds to the "CD34+" FACS
cell type label but also suggests considerable FACS FACS mislabeling
of the CD34+ cells. Topic 6 (magenta) does not correspond to any FACS
cell type and as we will it is capturing a different characteristic of
the cells---specifically, abundance of ribosomal protein genes.
Therefore, we expect the results from the topic-model-based DE
analysis for topics 1--4 to most closely resemble the DESeq2 results
for the corresponding cell types.

Before entering into this comparison, we first assess accuracy of the
Monte Carlo computations.

Assessing accuracy of the Monte Carlo estimates
-----------------------------------------------

To assess accuracy of the posterior calculations, we perform the DE
analysis twice (using different seeds), and compare the posterior mean
estimates and *z*-scores returned by the two `de_analysis` runs.

```{r load-de-analysis}
load("../output/pbmc-purified/de-pbmc-purified-seed=1.RData")
de1 <- de
load("../output/pbmc-purified/de-pbmc-purified-seed=2.RData")
de2 <- de
rm(de)
```

```{r assess-monte-carlo-1}
```

*Next:* compare classical DE analysis (DESeq2) against DE analysis
allowing for grades of membership.
