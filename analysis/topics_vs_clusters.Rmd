---
title: "Topic modeling vs. clustering of gene expression data: an illustration"
author: Peter Carbonetto
output: workflowr::wflow_html
---

Clustering methods are widely used to discover interesting
substructure in bulk or single-cell RNA sequencing ("RNA-seq")
data. An alternative is to use a topic model, which explains each
sample (an expression profile) as a mixture of "gene programs" that
are estimated from the data. In a topic modeling analysis, the gene
expression programs are the topics.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

In this short vignette, we show that a topic model picks up a very
different kind of substructure that cannot be identified by (hard)
clustering methods.

```{r load-pkgs, message=FALSE}
library(ggplot2)
library(cowplot)
library(Ternary)
library(Rtsne)
library(fastTopics)
source("../code/functions_for_topics_vs_clusters.R")
```

Simulate a "toy" gene expression data set from the multinomial topic
model. Each sample---here, a vector of 400 counts---is generated as a
mixture of three gene programs (the topics in the topic model). In
particular, samples are mostly generated by either a single gene
program or an approximately equal mixture of the three gene programs.

```{r simulate-data}
set.seed(1)
X <- simulate_toy_gene_data(n = 400,m = 40,k = 3,s = 1000)$X
```

Topic modeling analysis
-----------------------

To illustrate a topic modeling analysis, we fit a multinomial topic
model to these data,

```{r fit-multinom-topic-model, message=FALSE}
fit <- fit_poisson_nmf(X,k = 3,numiter = 100,verbose = FALSE,
                       control = list(extrapolate = TRUE))
fit <- poisson2multinom(fit)
```

then we plot the estimated topic proportions.

```{r plot-topic-proportions, fig.height=3, fig.width=3}
par(mar = c(0,0,0,0))
create_ternary_plot(fit$L)
```

We observe in this plot that the estimated topic model recaptures the
simulation: according to the model, samples are primarily explained by
a single gene program, or by an approximately equal mixture of three
gene programs.

Clustering analysis
-------------------

To illustrate a clustering analysis, we use the *t*-SNE algorithm to
project the samples onto a 2-d embedding.

```{r tsne-from-counts-1, fig.height=3, fig.width=3}
tsne1 <- Rtsne(X,2,pca = FALSE,normalize = FALSE)
plot_tsne(tsne1)
```

This 2-d projection immediately suggests four clusters. (In practice,
one could automate the clustering of these data using a community
detection method such as the Louvain algorithm, or by applying
$k$-means to the $t$-SNE projection.)

Although the clustering is correct---there are indeed four
clusters---it fails to reveal any insight into the relationship
between these clusters. In particular, the distribution of genes in
the middle cluster is an equal mixture of the gene distributions in
the other clusters. This is a limitation of any clustering method that
does not allow for partial membership to clusters.

To further understand this point, we label each sample by the topic
with the highest estimated weight:

```{r tsne-from-counts-2, fig.height=3, fig.width=3}
plot_tsne_with_topics(tsne1,fit$L)
```

In general, a clustering will align closely with the topic modeling
whenever the samples can be largely explained by a single topic or
gene program. Outside this setting, topic modeling and clustering can
reveal very different sorts of substructure.

Inferring clusters from the topic model
---------------------------------------

Despite this limitation of the clustering methods, it can nonetheless
be useful to identify the clusters exhibiting markedly different gene
expression patterns. This can also be done within a topic modeling
analysis: the topic model contains enough information to identify
these clusters, at least in the artificial setting where the data are
simulated from a topic model.

For example, a 2-d *t*-SNE projection of the topic proportions reveals
the same four clusters:

```{r tsne-from-loadings, fig.height=3, fig.width=3}
tsne2 <- Rtsne(fit$L,2,pca = FALSE,normalize = FALSE)
plot_tsne_with_topics(tsne2,fit$L)
```

Or we can achieve a similar result using PCA:

```{r pca-from-loadings, fig.height=3, fig.width=3}
pca <- prcomp(fit$L,center = TRUE,scale = FALSE)
plot_pca(pca,fit$L)
```

In short, the topic modeling analysis retains the benefits of the
clustering analysis, while revealing additional substrcuture that
cannot be identified by standard clustering methods.
