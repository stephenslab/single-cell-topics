---
title: "Examine topic-model-based single-cell likelihoods in FACS-purified PBMC data"
author: Peter Carbonetto
output: workflowr::wflow_html
---

Here we calculate single-cell likelihoods to assess how well the
multinomial topic model captures expression in different cells and
cell types.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(fastTopics)
library(ggplot2)
library(cowplot)
```

Load the count data, the $K = 6$ topic model fit, and the 7 clusters
identified in the [clustering analysis](clusters_purified_pbmc.html).

```{r load-data}
load("../data/pbmc_purified.RData")
fit <- readRDS(file.path("../output/pbmc-purified/rds",
                         "fit-pbmc-purified-scd-ex-k=6.rds"))$fit
fit <- poisson2multinom(fit)
samples <- readRDS("../output/pbmc-purified/clustering-pbmc-purified.rds")
```

Calculate the multinomial topic model likelihood for each cell.

```{r loglik-1}
loglik <- loglik_multinom_topic_model(counts,fit)
```

This can be used to assess how well the topic model "fits" each cell.

```{r loglik-2, fig.height=2, fig.width=5.5}
pdat <- data.frame(loglik)
p1 <- ggplot(pdat,aes(loglik)) +
  geom_histogram(bins = 64,color = "white",fill = "black") +
  scale_x_continuous(breaks = seq(-20000,0,2500)) +
  labs(y = "number of cells") +
  theme_cowplot(font_size = 10)
print(p1)
```

Combine the T-cell subpopulations into one category:

```{r combine-facs-subpop}
celltype <- as.character(samples$celltype)
celltype[celltype == "CD14+ Monocyte"] <- "CD14+"
celltype[celltype == "CD4+/CD45RA+/CD25- Naive T" |
         celltype == "CD4+/CD45RO+ Memory" |
         celltype == "CD8+/CD45RA+ Naive Cytotoxic" |
         celltype == "CD4+ T Helper2" |
         celltype == "CD4+/CD25 T Reg"] <- "T cell"
celltype <- factor(celltype)
```

Most of the poorly fit cells are in the CD34+ subpopulation:

```{r loglik-3, fig.height=4, fig.width=6}
pdat <- data.frame(loglik = loglik,celltype = celltype)
p2 <- ggplot(pdat,aes(x = loglik)) +
  geom_histogram(bins = 64,color = "white",fill = "black") +
  facet_wrap(vars(celltype),scales = "free_y",ncol = 2) +
  scale_x_continuous(breaks = seq(-20000,0,2500)) +
  labs(y = "number of cells") +
  theme_cowplot(font_size = 9)
print(p2)
```

Here, we compare the single-cell likelihoods under the multinomial
topic model against the likelihoods under a simple "clustering" model
in which the underlying pattern of expression is estimated from all
the cells in the FACS subpopulation. Thus, the predictions are based
on 10 different expression patterms, one for each of the 10 FACS
subpopulations. This serves partly as a "sanity check", as we expect
the more flexible topic model to offer a better fit.

```{r loglik-4}
fit_subpop <- init_poisson_nmf_from_clustering(counts,samples$celltype)
fit_subpop <- poisson2multinom(fit_subpop)
loglik_subpop <- loglik_multinom_topic_model(counts,fit_subpop)
```

Indeed, the topic model provides a better fit for almost all cells:

```{r loglik-5, fig.width=4, fig.height=2.5}
facs_colors <- c("dodgerblue",  # B cells
                 "forestgreen", # CD14+
                 "darkmagenta", # CD34+
                 "gray",        # NK cells
                 "tomato",      # cytotoxic T cells
                 "gold")        # T cells
pdat <- data.frame(x = loglik_subpop,y = loglik,celltype = celltype)
p3 <- ggplot(pdat,aes(x = x,y = y,fill = celltype)) +
  geom_point(shape = 21,color = "white") +
  geom_abline(intercept = 0,slope = 1,linetype = "dotted") +
  scale_x_continuous(limits = c(-10000,0),breaks = seq(-10000,0,2500)) +
  scale_y_continuous(limits = c(-10000,0),breaks = seq(-10000,0,2500)) +
  scale_fill_manual(values = facs_colors) +
  labs(x = "cluster model",y = "topic model",fill = "FACS subpopulation") +
  theme_cowplot(font_size = 9)
print(p3)
```

The improvement in fit is greatest for cells in the CD34+ and T cell
FACS subpopulations:

```{r loglik-6, fig.width=6.5, fig.height=3.5}
p4 <- ggplot(pdat,aes(x = x,y = y,fill = celltype)) +
  geom_point(shape = 21,color = "white") +
  geom_abline(intercept = 0,slope = 1,linetype = "dotted") +
  facet_wrap(vars(celltype)) +
  scale_x_continuous(limits = c(-10000,0),breaks = seq(-10000,0,2500)) +
  scale_y_continuous(limits = c(-10000,0),breaks = seq(-10000,0,2500)) +
  scale_fill_manual(values = facs_colors) +
  labs(x = "cluster model",y = "topic model",fill = "FACS subpopulation") +
  theme_cowplot(font_size = 9)
print(p4)
```

It is interesting that the topic model almost always provides a better
fit for the T cells considering that the simple "clustering" model
estimates a different expression pattern for each T cell subtype
(e.g., naive T cells), whereas the topic model does not reach this
level of granularity in the T cells.

Finally, we compare the topic model likelihoods against another
"clustering" model, this time using the clusters identifies from the
mixture proportions.

```{r loglik-7}
fit_clusters <- init_poisson_nmf_from_clustering(counts,samples$cluster)
fit_clusters <- poisson2multinom(fit_clusters)
loglik_clusters <- loglik_multinom_topic_model(counts,fit_clusters)
```

This is an interesting case where defining a separate cluster for the
dendritic cells actually yields a better fit than the topic
model. However, because only 308 cells are assigned to this
cluster---only 0.3% of the total---the overall impact on the fit to
the data is small.

```{r loglik-8}
pdat <- data.frame(x = loglik_clusters,y = loglik,cluster = samples$cluster)
p5 <- ggplot(pdat,aes(x = x,y = y)) +
  geom_point(shape = 21,color = "white",fill = "royalblue") +
  geom_abline(intercept = 0,slope = 1,linetype = "dotted") +
  facet_wrap(vars(cluster)) +
  scale_x_continuous(limits = c(-10000,0),breaks = seq(-10000,0,2500)) +
  scale_y_continuous(limits = c(-10000,0),breaks = seq(-10000,0,2500)) +
  labs(x = "cluster model",y = "topic model") +
  theme_cowplot(font_size = 9)
print(p5)
```

```{r save-plots, echo=FALSE, results="hide"}
ggsave("../plots/loglik_histogram_pbmc_purified.eps",
       p1,height = 2,width = 4.5)
ggsave("../plots/loglik_histogram_by_subpop_pbmc_purified.eps",
       p2,height = 4,width = 4.5)
ggsave("../plots/loglik_scatterplot_all_pbmc_purified.png",
       p3,height = 3.5,width = 5)
ggsave("../plots/loglik_scatterplot_by_subpop_pbmc_purified.png",
       p4,height = 4,width = 7.5)
ggsave("../plots/loglik_scatterplot_by_cluster_pbmc_purified.png",
       p5,height = 6,width = 7.5)
```
