---
title: "Identify clusters in droplet data using topic model"
author: Peter Carbonetto
output: workflowr::wflow_html
---

Here we perform PCA on the topic proportions to identify clusters in
the droplet data. 

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below, as well as additional
functions that we will use to generate some of the plots.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(fastTopics)
library(ggplot2)
library(cowplot)
source("../code/plots.R")
```

Load the count data.

```{r load-data}
load("../data/droplet.RData")
```

Load the $K = 7$ Poisson NMF model fit.

```{r load-fit}
fit <- readRDS("../output/droplet/rds/fit-droplet-scd-ex-k=7.rds")$fit
fit <- poisson2multinom(fit)
```

From the PCs of the topic proportions, we define two subsets, labeled
as "abundant" and "rare" to indicate that these subsets roughly
capture the more abundant (e.g., basal) and more rare cell types
(e.g., neuroendocrine).

```{r clustering-1}
pca <- prcomp(fit$L)$x
x   <- rep("rare",nrow(pca))
pc2 <- pca[,2]
pc6 <- pca[,6]
x[pc2 > -0.15] <- "abundant"
x[pc6 < -0.05] <- "rare"
samples$cluster <- factor(x)
table(samples$cluster)
```

The reduced representation of the cells (from the topic proportions
with $K = 7$ topics) mostly preserves the 7 clusters identified in the
Montoro *et al* (2018) paper:

```{r clustering-5, fig.width=7.5, fig.height=2.5, message=FALSE}
tissue_colors <- c("royalblue",   # basal
                   "firebrick",   # ciliated
                   "forestgreen", # club
                   "gold",        # goblet
                   "darkmagenta", # ionocyte
                   "darkorange",  # neuroendocrine
                   "skyblue")     # tuft
p1 <- pca_plot(fit,pcs = 1:2,fill = samples$tissue) +
  scale_fill_manual(values = tissue_colors)
p2 <- pca_plot(fit,pcs = 5:6,fill = samples$tissue) +
  scale_fill_manual(values = tissue_colors)
plot_grid(p1,p2)
```

```{r pca-plots-for-paper, echo=FALSE}
ggsave("../plots/pca_cluster_droplet.png",plot_grid(p1,p2),
       height = 3,width = 8,dpi = 450,bg = "white")
```

The structure plot summarizes the topic proportions in the "abundant"
and "rare" subsets:

```{r structure-plot, fig.width=8, fig.height=1.5, message=FALSE}
set.seed(1)
topic_colors <- c("gold","royalblue","salmon","turquoise","olivedrab",
                  "firebrick","forestgreen")
topics <- c(3,4,5,1,7,2,6)
rows <- sort(c(sample(which(samples$cluster == "abundant"),1200),
               which(samples$cluster == "rare")))
p <- structure_plot(select_loadings(fit,loadings = rows),
                    grouping = samples[rows,"cluster"],
                    topics = topics,colors = topic_colors,
                    perplexity = 70,n = Inf,gap = 20,
                    num_threads = 4,verbose = FALSE)
print(p)
```

```{r structure-plot-for-paper, message=FALSE, warning=FALSE, echo=FALSE, results="hide"}
ggsave("../plots/structure_plot_droplet.eps",p,height = 1.6,width = 7)
```

Save the clustering of the droplet data to an RDS file:

```{r save-results}
saveRDS(samples,"clustering-droplet.rds")
```

Analysis of single-cell likelihoods
-----------------------------------

Here we calculate single-cell likelihoods to assess how well the topic
model captures expression in different cell types.

```{r likelihood-1}
fit_merge      <- merge_topics(poisson2multinom(fit),c("k5","k7"))
fit_montoro    <- init_poisson_nmf_from_clustering(counts,samples$tissue)
fit_montoro    <- poisson2multinom(fit_montoro)
loglik_topics  <- loglik_multinom_topic_model(counts,fit_merge)
loglik_montoro <- loglik_multinom_topic_model(counts,fit_montoro)
```

Next, we compare the topic-model likelihoods to the clustering-based
likelihoods. In most cases, the topic model provides a fit that is
better or at least as good as the clustering-based fit. The exceptions
are the less abundant tuft, neuroendocrine and ionocyte cell types.

```{r likelihood-2, fig.width=6, fig.height=6}
minloglik <- -20000
p1 <- loglik_scatterplot(loglik_montoro,loglik_topics,samples$tissue,
                         "Basal",minloglik,"cluster","topics")
p2 <- loglik_scatterplot(loglik_montoro,loglik_topics,samples$tissue,
                         "Ciliated",minloglik,"cluster","topics")
p3 <- loglik_scatterplot(loglik_montoro,loglik_topics,samples$tissue,
                         "Club",minloglik,"cluster","topics")
p4 <- loglik_scatterplot(loglik_montoro,loglik_topics,samples$tissue,
                         "Goblet",minloglik,"cluster","topics")
p5 <- loglik_scatterplot(loglik_montoro,loglik_topics,samples$tissue,
                         "Ionocyte",minloglik,"cluster","topics")
p6 <- loglik_scatterplot(loglik_montoro,loglik_topics,samples$tissue,
                         "Neuroendocrine",minloglik,"cluster","topics")
p7 <- loglik_scatterplot(loglik_montoro,loglik_topics,samples$tissue,
                         "Tuft",minloglik,"cluster","topics")
plot_grid(p1,p2,p3,p4,p5,p6,p7,nrow = 3,ncol = 3)
```
