---
title: "Identify clusters in droplet data using topic model"
author: Peter Carbonetto
output: workflowr::wflow_html
---

Here we perform PCA on the topic proportions to identify clusters in
the droplet data. 

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below, as well as additional
functions that we will use to generate some of the plots.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(dplyr)
library(fastTopics)
library(ggplot2)
library(cowplot)
source("../code/plots.R")
```

Load data and results
---------------------

Load the droplet data.

```{r load-data}
load("../data/droplet.RData")
```

Load the $k = 7$ Poisson NMF model fit.

```{r load-fit}
fit <- readRDS("../output/droplet/rds/fit-droplet-scd-ex-k=7.rds")$fit
```

Identify clusters from principal components
-------------------------------------------

To identify clusters, we begin by plotting PCs computed from the topic
proportions. (Note that only 6 PCs are needed for 7 topics.)

```{r clustering-1, fig.width=8, fig.height=2.5}
p1 <- basic_pca_plot(fit,1:2)
p2 <- basic_pca_plot(fit,3:4)
p3 <- basic_pca_plot(fit,5:6)
plot_grid(p1,p2,p3,nrow = 1,ncol = 3)
```

Some of the structure is more evident from "hexbin" plots showing the
density of the points.

```{r clustering-2, fig.width=8, fig.height=2.5}
bins <- c(0,1,5,10,100,Inf)
p4 <- pca_hexbin_plot(fit,1:2,bins = bins) + guides(fill = "none")
p5 <- pca_hexbin_plot(fit,3:4,bins = bins) + guides(fill = "none")
p6 <- pca_hexbin_plot(fit,5:6,bins = bins) + guides(fill = "none")
plot_grid(p4,p5,p6,nrow = 1,ncol = 3)
```

From these PCA plots, we define 4 clusters, labeled A, Cil, G and
T+N. (The reasoning behind these labels will become clear later.)
Points that do not fit in any of these clusters are assigned to a
"background cluster", labeled U.

```{r clustering-3}
pca <- prcomp(poisson2multinom(fit)$L)$x
x   <- rep("U",nrow(pca))
pc1 <- pca[,1]
pc2 <- pca[,2]
pc6 <- pca[,6]
x[pc2 > -0.15] <- "A"
x[pc1 > 0.3 & pc2 < -0.75] <- "Cil"
x[pc1 <= 0.3 & pc2 >= -0.75 & pc2 < -0.4] <- "T+N"
x[pc6 < -0.05] <- "G"
```

There is additional substructure in cluster A, which is more apparent
in the projection onto the top 2 PCs computed from cluster A only.

```{r clustering-4, fig.width=6, fig.height=3}
rows <- which(x == "A")
fit2 <- select(poisson2multinom(fit),loadings = rows)
p7   <- basic_pca_plot(fit2,1:2)
p8   <- pca_hexbin_plot(fit2,1:2,bins = bins) + guides(fill = "none")
plot_grid(p7,p8)
```

The variation in PCs 1 and 2 is mostly produced by topics 2, 4 and 5.

```{r clustering-5, fig.width=5.5, fig.height=4.5}
p9 <- pca_plot(fit2,pcs = 1:2,k = c(2,4,5))
print(p9)
```

Topic 4 in particular corresponds closely to expression of *Krt13*
which was identified as being uniquely expressed by transitional
"hillock" cells.

```{r clustering-6, fig.width=3.25, fig.height=2.5}
p10 <- pca_plot_with_counts(fit2,counts[rows,"Krt13"],pcs = 1:2,log = TRUE)
print(p10)
```

We label the three more-or-less distinct subclusters as B, C and H,
and assign the remaining "in between" data points to a new "background
cluster", B+C.

```{r clustering-7}
pca <- prcomp(fit2$L)$x
pc1 <- pca[,1]
pc2 <- pca[,2]
y   <- rep("B+C",nrow(pca))
y[pc1 < 0.1] <- "B"
y[pc1 > 0.4 & pc2 < 0.45] <- "C"
y[pc2 > 0.55] <- "H"
x[rows] <- y
```

In summary, we have subdivided the droplet data into 8 subsets.

```{r clustering-8, fig.width=8, fig.height=2}
samples$cluster <- factor(x,c("B","C","B+C","H","Cil","T+N","G","U"))
cluster_colors <- c("royalblue",   # B
                    "forestgreen", # C
                    "slategray",   # B+C
                    "turquoise",   # H
					"firebrick",   # Cil
					"darkorange",  # T+N
					"gold",        # G
					"gainsboro")   # U
p11 <- labeled_pca_plot(fit,1:2,samples$cluster,cluster_colors,font_size = 8)
p12 <- labeled_pca_plot(fit,3:4,samples$cluster,cluster_colors,font_size = 8)
p13 <- labeled_pca_plot(fit,5:6,samples$cluster,cluster_colors,font_size = 8)
plot_grid(p11,p12,p13,nrow = 1,ncol = 3)
```

The clusters identified here correspond well to the Montoro *et al*
(2018) clustering, with some exceptions (e.g., we do not identify an
ionocytes cluster, and the neuroendocrine and tuft cells are included
in the same cluster).

```{r clustering-9}
with(samples,table(tissue,cluster))
```

Structure plot
--------------

The structure plot summarizes the topic proportions in each of these 8
subsets:

```{r structure-plot, fig.width=8, fig.height=1.5}
set.seed(1)
topic_colors <- c("gold","royalblue","salmon","turquoise","olivedrab",
                  "firebrick","forestgreen")
topics <- c(3,4,5,1,7,2,6)
rows <- sort(c(sample(which(samples$cluster == "B"),800),
               sample(which(samples$cluster == "C"),800),
			   which(samples$cluster == "B+C"),
               which(samples$cluster == "H"),
               which(samples$cluster == "Cil"),
               which(samples$cluster == "T+N"),
               which(samples$cluster == "G"),
			   which(samples$cluster == "U")))
p14 <- structure_plot(select(poisson2multinom(fit),loadings = rows),
                      grouping = samples[rows,"cluster"],
                      topics = topics,colors = topic_colors[topics],
		  			  perplexity = c(70,70,30,30,50,30,12,18),
                      n = Inf,gap = 30,num_threads = 4,verbose = FALSE)
print(p14)
```

Based on this structure plot, and the above results, we roughly
subdivide the droplet data into two: (1) the Cil, T+N and G clusters
that give rise to well-separated clusters, and (2) the B, C, B+C and H
subsets that contain interesting substructure but much less distinct
clustering. Therefore,the cluster labels B, C, B+C and H are useful as
a guide but should be taken with a grain of salt as the boundaries
between these clusters are somewhat arbitrary.

Note the distribution of the topics in cluster C suggests that there
is further substantial heterogeneity in these cells beyond what can be
captured by identifying "hard" clusters. In particular, there is
additional continuous variation in gene expression primarily captured
by topics 5 and 7:

```{r pca-plot, fig.width=6, fig.height=4.75}
rows <- which(is.element(x,c("B","C","H","B+C")))
fit2 <- select(poisson2multinom(fit),loadings = rows)
p15  <- pca_plot(fit2,pcs = 2:3,k = c(4,5,7))
print(p15)
```

Save results
------------

Save the clustering of the droplet data to an RDS file.

```{r save-results}
saveRDS(samples,"clustering-droplet.rds")
```
