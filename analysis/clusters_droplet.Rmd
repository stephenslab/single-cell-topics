---
title: "Identify clusters in droplet data using topic model"
author: Peter Carbonetto
output: workflowr::wflow_html
---

Here we perform PCA on the topic proportions to identify clusters in
the droplet data. 

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below, as well as additional
functions that we will use to generate some of the plots.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(fastTopics)
library(ggplot2)
library(cowplot)
source("../code/plots.R")
```

Load the count data.

```{r load-data}
load("../data/droplet.RData")
```

Load the $K = 7$ Poisson NMF model fit.

```{r load-fit}
fit <- readRDS("../output/droplet/rds/fit-droplet-scd-ex-k=7.rds")$fit
fit <- poisson2multinom(fit)
```

From the PCs of the topic proportions, we define 4 clusters, labeled
A, Cil, G and T+N. (The reasoning behind these labels will become
clear later.)  Points that do not fit in any of these clusters are
assigned to a "background cluster", labeled U.

```{r clustering-1}
pca <- prcomp(fit$L)$x
x   <- rep("U",nrow(pca))
pc1 <- pca[,1]
pc2 <- pca[,2]
pc6 <- pca[,6]
x[pc2 > -0.15] <- "A"
x[pc1 > 0.3 & pc2 < -0.75] <- "Cil"
x[pc1 <= 0.3 & pc2 >= -0.75 & pc2 < -0.4] <- "T+N"
x[pc6 < -0.05] <- "G"
```

Within the "A" cluster, we label the three more-or-less distinct
subclusters as B, C and H, and assign the remaining "in between" data
points to cluster "B+C+H".

```{r clustering-2}
rows <- which(x == "A")
fit2 <- select_loadings(fit,loadings = rows)
pca  <- prcomp(fit2$L)$x
pc1  <- pca[,1]
pc2  <- pca[,2]
y    <- rep("B+C+H",nrow(pca))
y[pc1 < 0.1] <- "B"
y[pc1 > 0.4 & pc2 < 0.45] <- "C"
y[pc2 > 0.55] <- "H"
x[rows] <- y
```

In summary, we have subdivided the droplet data into 8 subsets:

```{r clustering-3}
samples$cluster <- factor(x,c("B","C","H","B+C+H","Cil","T+N","G","U"))
table(samples$cluster)
```

There is a close correspondence, with some exceptions, between these
clusters based on the topic proportions and the Montoro *et al* (2018)
clustering:

```{r clustering-4}
with(samples,table(tissue,cluster))
```

This correspondence can also be seen from these PCA plots:

```{r clustering-5, fig.width=7.5, fig.height=2.5, message=FALSE}
abundant      <- c("B","C","H","B+C+H")
rare          <- c("Cil","T+N","G","U")
tissue_colors <- c("royalblue",   # basal
                   "firebrick",   # ciliated
                    "forestgreen", # club
                    "gold",        # goblet
                    "darkmagenta", # ionocyte
                    "darkorange",  # neuroendocrine
                    "skyblue")     # tuft
rows1 <- which(is.element(samples$cluster,abundant))
rows2 <- which(is.element(samples$cluster,rare))
fit1  <- select_loadings(fit,loadings = rows1)
fit2  <- select_loadings(fit,loadings = rows2)
p1 <- pca_plot(fit1,fill = samples[rows1,"tissue"]) +
        scale_fill_manual(values = tissue_colors,drop = FALSE) +
	    labs(fill = "cluster")
p2 <- pca_plot(fit2,fill = samples[rows2,"tissue"]) +
        scale_fill_manual(values = tissue_colors,drop = FALSE) +
	    labs(fill = "cluster")
plot_grid(p1,p2)
```

The structure plot summarizes the topic proportions in each of these 8
subsets:

```{r structure-plot, fig.width=8, fig.height=1.5, message=FALSE}
set.seed(1)
topic_colors <- c("gold","royalblue","salmon","turquoise","olivedrab",
                  "firebrick","forestgreen")
topics <- c(3,4,5,1,7,2,6)
rows <- sort(c(sample(which(samples$cluster == "B"),400),
               sample(which(samples$cluster == "C"),400),
               which(samples$cluster == "H"),
			   sample(which(samples$cluster == "B+C+H"),200),
               sample(which(samples$cluster == "Cil"),200),
               which(samples$cluster == "T+N"),
               which(samples$cluster == "G"),
			   which(samples$cluster == "U")))
p <- structure_plot(select_loadings(fit,loadings = rows),
                    grouping = samples[rows,"cluster"],
                    topics = topics,colors = topic_colors,
  					perplexity = 70,n = Inf,gap = 15,
					num_threads = 4,verbose = FALSE)
print(p)
```

Save the clustering of the droplet data to an RDS file:

```{r save-results}
saveRDS(samples,"clustering-droplet.rds")
```

Analysis of single-cell likelihoods
-----------------------------------

Here we calculate single-cell likelihoods to assess how well the topic
model captures expression in different cell types.

```{r likelihood-1}
fit_merge      <- merge_topics(poisson2multinom(fit),c("k5","k7"))
fit_montoro    <- init_poisson_nmf_from_clustering(counts,samples$tissue)
fit_montoro    <- poisson2multinom(fit_montoro)
loglik_topics  <- loglik_multinom_topic_model(counts,fit_merge)
loglik_montoro <- loglik_multinom_topic_model(counts,fit_montoro)
```

Next, we compare the topic-model likelihoods to the clustering-based
likelihoods. In most cases, the topic model provides a fit that is
better or at least as good as the clustering-based fit. The exceptions
are the less abundant tuft, neuroendocrine and ionocyte cell types.

```{r likelihood-2, fig.width=6, fig.height=6}
minloglik <- -20000
p1 <- loglik_scatterplot(loglik_montoro,loglik_topics,samples$tissue,
                         "Basal",minloglik,"cluster","topics")
p2 <- loglik_scatterplot(loglik_montoro,loglik_topics,samples$tissue,
                         "Ciliated",minloglik,"cluster","topics")
p3 <- loglik_scatterplot(loglik_montoro,loglik_topics,samples$tissue,
                         "Club",minloglik,"cluster","topics")
p4 <- loglik_scatterplot(loglik_montoro,loglik_topics,samples$tissue,
                         "Goblet",minloglik,"cluster","topics")
p5 <- loglik_scatterplot(loglik_montoro,loglik_topics,samples$tissue,
                         "Ionocyte",minloglik,"cluster","topics")
p6 <- loglik_scatterplot(loglik_montoro,loglik_topics,samples$tissue,
                         "Neuroendocrine",minloglik,"cluster","topics")
p7 <- loglik_scatterplot(loglik_montoro,loglik_topics,samples$tissue,
                         "Tuft",minloglik,"cluster","topics")
plot_grid(p1,p2,p3,p4,p5,p6,p7,nrow = 3,ncol = 3)
```
