---
title: Assess Poisson NMF fits in mixture of FACS-purified PBMC data
author: Peter Carbonetto
output: workflowr::wflow_html
---

Here we compare the quality of the fits obtained from the different
updates (EM, CCD, SCD, with and without extrapolation), and with
different $K$.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center")
```

Load the packages used in the analysis below, as well as some
additional functions for creating the plots.

```{r load-pkgs, message=FALSE}
library(fastTopics)
library(ggplot2)
library(cowplot)
source("../code/functions_for_assessing_fits.R")
```

Load the results of running `fit_poisson_nmf` on the mixture of
FACS-purified PBMC data, with the different updates, and for various
choices of $K$ (the number of topics, or equivalently the dimension of
the matrix factorization).

```{r load-results}
load("../output/pbmc-purified/fits-pbmc-purified.RData")
```

This plot shows the improvement in the log-likelihood as the rank,
$K$, is increased. The log-likelihoods are shown relative to the
log-likelihood at $K = 2$. 

```{r plot-loglik-vs-k, fig.height=3, fig.width=3.5}
plot_loglik_vs_rank(fits) +
  theme_cowplot(font_size = 12)
```

The likelihood improves as the rank, $K$, increases.

The next set of plots shows the improvement in the fit over time, for
all choices of $K$, and for each of the three updates (EM, CCD, SCD),
with and without the extrapolation scheme. The quality of the fit is
measured by the log-likelihood relative to the best log-likelihood
that was identified among all methods compared.

```{r plot-loglik, fig.height=6, fig.width=9}
create_progress_plots(dat,fits,"loglik")
```

The last set of plots shows the evolution of the KKT residuals over
time; the KKT residuals should vanish near a stationary point of the
log-likelihood, so looking at the largest KKT residual can be used to
assess how close we are to a solution. Note that, unlike the
log-likelihood, the KKT residuals are not expected to decrease
monotonically over time.

```{r plot-res, fig.height=6, fig.width=9}
create_progress_plots(dat,fits,"res")
```

```{r plots-for-paper, message=FALSE, warning=FALSE, echo=FALSE}
p1 <- plot_loglik_vs_rank(fits) +
  scale_y_continuous(breaks = seq(0,12e6,2e6)) +
  labs(x = "number of topics (K)") +
  theme_cowplot(font_size = 12)
p2 <- create_progress_plots(dat,fits,"loglik")
p3 <- create_progress_plots(dat,fits,"res")
ggsave("../plots/loglik_vs_k_pbmc_purified.eps",p1,height = 3,width = 3.25)
ggsave("../plots/progress_loglik_pbmc_purified.eps",p2,height = 6,width = 9)
ggsave("../plots/progress_res_pbmc_purified.eps",p3,height = 6,width = 9)
```
