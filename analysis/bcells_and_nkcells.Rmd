---
title: Examine B-cell and NK cell topics and clusters
author: Peter Carbonetto
output: workflowr::wflow_html
---

*Add text here.*

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(fastTopics)
library(ggplot2)
library(ggrepel)
library(cowplot)
source("../code/more_plots.R")
```

Load the mixture of FACS-purified PBMC data, the $k = 6$ Poisson NMF
model fit, and the results of the differential expression analysis
using this model fit.

```{r load-purified-data}
fit_purified <-
  readRDS("../output/pbmc-purified/rds/fit-pbmc-purified-scd-ex-k=6.rds")$fit
load("../output/pbmc-purified/postfit-pbmc-purified-scd-ex-k=6.RData")
load("../data/pbmc_purified.RData")
ids                 <- rownames(diff_count_res$Z)
counts_purified     <- counts[,ids]
genes_purified      <- genes[match(ids,genes$ensembl),]
diff_count_purified <- diff_count_res
rm(samples,genes,counts,diff_count_res,gene_info,ids)
rm(gene_set_info,gene_sets,gsea_res)
```

Load the "unsorted" 68k PBMC data, the $k = 6$ Poisson NMF model fit,
and the results of the differential expression analysis using this
model fit.

```{r load-68k-data}
fit_68k <- readRDS("../output/pbmc-68k/rds/fit-pbmc-68k-scd-ex-k=6.rds")$fit
load("../output/pbmc-68k/postfit-pbmc-68k-scd-ex-k=6.RData")
load("../data/pbmc_68k.RData")
ids            <- rownames(diff_count_res$Z)
counts_68k     <- counts[,ids]
genes_68k      <- genes[match(ids,genes$ensembl),]
diff_count_68k <- diff_count_res
rm(samples,genes,counts,diff_count_res,ids,gene_set_info,gene_sets,gsea_res)
```

Load the clustering of the purified and 68k data set that was
determined in the "plots_pbmc" analysis.

```{r load-clustering}
load("../output/pbmc-clustering.RData")
```

Perform a differential expression analysis using the clustering of the
purified data.

```{r diff-count-analysis-clusters-purified, cache=TRUE}
fit_clusters_purified <-
  init_poisson_nmf_from_clustering(counts_purified,samples_purified$cluster)
diff_count_clusters_purified <- diff_count_analysis(fit_clusters_purified,
                                                    counts_purified)
```

Perform a differential expression analysis using the clustering of the
68k data.

```{r diff-count-analysis-clusters-68k, cache=TRUE}
fit_clusters_68k <- init_poisson_nmf_from_clustering(counts_68k,
                                                     samples_68k$cluster)
diff_count_clusters_68k <- diff_count_analysis(fit_clusters_68k,counts_68k)
```

In the purified data set, compare the gene-wise *z*-scores from topic
3 to the $z$-scores from cluster B.

```{r z-scores-scatterplot-pbmc-purified, fig.height=4, fig.width=4.5}
p1 <- diff_count_scatterplot(diff_count_clusters_purified$Z[,"B"],
                             diff_count_purified$Z[,3],
							 diff_count_purified$colmeans,
							 genes_purified$symbol,
							 label_above_score = 100) +
  labs(x = "cluster B",y = "topic 3",title = "z-scores")
print(p1)
```

In the 68k data, compare the gene-wise *z*-scores from topic 5 to the
$z$-scores from cluster A2.

```{r z-scores-scatterplot-pbmc-68k, fig.height=4, fig.width=4.5}
p2 <- diff_count_scatterplot(diff_count_clusters_68k$Z[,"A2"],
                             diff_count_68k$Z[,5],
							 diff_count_68k$colmeans,
							 genes_68k$symbol,
							 label_above_score = 100) +
  labs(x = "cluster A2",y = "topic 5",title = "z-scores")
print(p2)
```

Plot histograms of the topic 3 proportions inside and outside
cluster B in the purified data.

```{r topic-3-histogram-pbmc-purified, fig.width=6, fig.height=2}
fit <- poisson2multinom(fit_purified)
p3 <- ggplot(data.frame(x = fit$L[,3]),aes(x)) +
  geom_histogram(bins = 50,color = "white",fill = "black",na.rm = TRUE) +
  ylim(c(0,2000)) +
  labs(x = "topic 3 proportion",y = "number of cells") +
  theme_cowplot(font_size = 10)
p4 <- ggplot(data.frame(x = fit$L[samples_purified$cluster == "B",3]),aes(x)) +
  geom_histogram(bins = 30,color = "white",fill = "black",na.rm = TRUE) +
  labs(x = "topic 3 proportion",y = "number of cells") +
  theme_cowplot(font_size = 10)
plot_grid(p3,p4)
```

Plot histograms of the topic 5 proportions inside and outside cluster
A3 in the 68k data.

```{r topic-5-histogram-pbmc-68k, fig.width=6, fig.height=2}
fit <- poisson2multinom(fit_68k)
p5 <- ggplot(data.frame(x = fit$L[,5]),aes(x)) +
  geom_histogram(bins = 50,color = "white",fill = "black",na.rm = TRUE) +
  ylim(c(0,1200)) +
  labs(x = "topic 5 proportion",y = "number of cells") +
  theme_cowplot(font_size = 10)
p6 <- ggplot(data.frame(x = fit$L[samples_68k$cluster == "A2",5]),aes(x)) +
  geom_histogram(bins = 30,color = "white",fill = "black",na.rm = TRUE) +
  labs(x = "topic 5 proportion",y = "number of cells") +
  theme_cowplot(font_size = 10)
plot_grid(p5,p6)
```

Examine closely the relationship between topic 3 and expression of
*CD79A* in the purified data.

```{r topic-3-vs-cd79a-pbmc-purified, fig.width=3, fig.height=2.5}
fit  <- poisson2multinom(fit_purified)
i    <- which(genes_purified$symbol == "CD79A")
pdat <- data.frame(x = cut(fit$L[,3],seq(0,1,0.05)),
                   y = counts_purified[,i])
pdat <- data.frame(x = seq(0,0.95,0.05),
                   y = with(pdat,tapply(y,x,mean)))
names(pdat) <- c("x","y")
p7 <- ggplot(pdat,aes(x = x,y = y)) +
  geom_col(color = "white",fill = "black") +
  labs(x = "topic 3 proportion",
       y = "CD79A expression level") +
  theme_cowplot(font_size = 10)
print(p7)
```

Examine closely the relationship between topic 5 and expression of
*CD79A* in the 68k data.

```{r topic-5-vs-cd79a-pbmc-68k, fig.width=3, fig.height=2.5}
fit  <- poisson2multinom(fit_68k)
i    <- which(genes_68k$symbol == "CD79A")
pdat <- data.frame(x = cut(fit$L[,5],seq(0,1,0.05)),
                   y = counts_68k[,i])
pdat <- data.frame(x = seq(0,0.95,0.05),
                   y = with(pdat,tapply(y,x,mean)))
names(pdat) <- c("x","y")
p8 <- ggplot(pdat,aes(x = x,y = y)) +
  geom_col(color = "white",fill = "black") +
  labs(x = "topic 5 proportion",
       y = "CD79A expression level") +
  theme_cowplot(font_size = 10)
print(p8)
```
