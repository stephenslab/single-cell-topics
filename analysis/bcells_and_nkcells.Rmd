---
title: Examine B-cell and NK cell topics and clusters
author: Peter Carbonetto
output: workflowr::wflow_html
---

*Add text here.*

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(dplyr)
library(fastTopics)
library(ggplot2)
library(ggrepel)
library(cowplot)
source("../code/more_plots.R")
```

Load the mixture of FACS-purified PBMC data, the $k = 6$ Poisson NMF
model fit, and the results of the differential expression analysis
using this model fit.

```{r load-purified-data}
fit_purified <-
  readRDS("../output/pbmc-purified/rds/fit-pbmc-purified-scd-ex-k=6.rds")$fit
load("../output/pbmc-purified/postfit-pbmc-purified-scd-ex-k=6.RData")
load("../data/pbmc_purified.RData")
ids                 <- rownames(diff_count_res$Z)
counts_purified     <- counts[,ids]
genes_purified      <- genes[match(ids,genes$ensembl),]
diff_count_purified <- diff_count_res
rm(samples,genes,counts,diff_count_res,gene_info,ids)
rm(gene_set_info,gene_sets,gsea_res)
```

Load the "unsorted" 68k PBMC data, the $k = 6$ Poisson NMF model fit,
and the results of the differential expression analysis using this
model fit.

```{r load-68k-data}
fit_68k <- readRDS("../output/pbmc-68k/rds/fit-pbmc-68k-scd-ex-k=6.rds")$fit
load("../output/pbmc-68k/postfit-pbmc-68k-scd-ex-k=6.RData")
load("../data/pbmc_68k.RData")
ids            <- rownames(diff_count_res$Z)
counts_68k     <- counts[,ids]
genes_68k      <- genes[match(ids,genes$ensembl),]
diff_count_68k <- diff_count_res
rm(samples,genes,counts,diff_count_res,ids,gene_set_info,gene_sets,gsea_res)
```

Load the clustering of the purified and 68k data set that was
determined in the "plots_pbmc" analysis.

```{r load-clustering}
load("../output/pbmc-clustering.RData")
```

Perform a differential expression analysis using the clustering of the
purified data.

```{r diff-count-analysis-clusters-purified, cache=TRUE}
fit_clusters_purified <-
  init_poisson_nmf_from_clustering(counts_purified,samples_purified$cluster)
diff_count_clusters_purified <- diff_count_analysis(fit_clusters_purified,
                                                    counts_purified)
```

Perform a differential expression analysis using the clustering of the
68k data.

```{r diff-count-analysis-clusters-68k, cache=TRUE}
fit_clusters_68k <- init_poisson_nmf_from_clustering(counts_68k,
                                                     samples_68k$cluster)
diff_count_clusters_68k <- diff_count_analysis(fit_clusters_68k,counts_68k)
```

In the purified data set, compare the gene-wise *z*-scores from topic
3 to the $z$-scores from cluster B.

```{r z-scores-pbmc-purified-3-vs-B, fig.height=3.75, fig.width=4.5}
p1 <- diff_count_scatterplot(diff_count_clusters_purified$Z[,"B"],
                             diff_count_purified$Z[,3],
							 diff_count_purified$colmeans,
							 genes_purified$symbol,
							 label_above_score = 100) +
  labs(x = "cluster B",y = "topic 3",title = "z-scores")
print(p1)
```

In the 68k data, compare the gene-wise *z*-scores from topic 5 to the
$z$-scores from cluster A2.

```{r z-scores-pbmc-68k-5-vs-A2, fig.height=3.75, fig.width=4.5}
p2 <- diff_count_scatterplot(diff_count_clusters_68k$Z[,"A2"],
                             diff_count_68k$Z[,5],
							 diff_count_68k$colmeans,
							 genes_68k$symbol,
							 label_above_score = 100) +
  labs(x = "cluster A2",y = "topic 5",title = "z-scores")
print(p2)
```

In the purified data set, compare the gene-wise *z*-scores from topic
4 to the $z$-scores from cluster A1.

```{r z-scores-pbmc-purified-4-vs-A1, fig.height=4, fig.width=4.5}
p3 <- diff_count_scatterplot(diff_count_clusters_purified$Z[,"A1"],
                             diff_count_purified$Z[,4],
							 diff_count_purified$colmeans,
							 genes_purified$symbol,
							 label_above_score = 200) +
  labs(x = "cluster A1",y = "topic 4",title = "z-scores")
print(p3)
```

In the 68k data, compare the gene-wise *z*-scores from topic 3 to the
$z$-scores from cluster A1b.

```{r z-scores-pbmc-68k-3-vs-A1b, fig.height=3.75, fig.width=4.5}
p4 <- diff_count_scatterplot(diff_count_clusters_68k$Z[,"A1b"],
                             diff_count_68k$Z[,3],
							 diff_count_68k$colmeans,
							 genes_68k$symbol,
							 label_above_score = 100) +
  labs(x = "cluster A2",y = "topic 5",title = "z-scores")
print(p4)
```
