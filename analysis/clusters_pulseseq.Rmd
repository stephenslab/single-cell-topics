---
title: "Identify clusters in pulse-seq data using topic model"
author: Peter Carbonetto
output: workflowr::wflow_html
---

*Briefly explain the aims of this analysis, and what we find.*

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below, as well as additional
functions that we will use to generate some of the plots.

```{r load-pkgs, message=FALSE}
library(dplyr)
library(fastTopics)
library(ggplot2)
library(cowplot)
source("../code/plots.R")
```

Load data and results
---------------------

Load the pulse-seq data. The UMI counts are not needed for this analysis.

```{r load-data}
load("../data/pulseseq.RData")
x <- as.character(samples$tissue)
x[x == "club (hillock-associated)"] <- "hillock"
x[x == "goblet.1" | x == "goblet.2" | x == "goblet.progenitor"] <- "goblet"
x[x == "tuft.1" | x == "tuft.2" | x == "tuft.progenitor"] <- "tuft"
samples$tissue <- factor(x)
rm(counts)
```

Load the $k = 11$ Poisson NMF fit.

```{r load-fit}
fit <- readRDS("../output/pulseseq/rds/fit-pulseseq-scd-ex-k=11.rds")$fit
```

Identify clusters from principal components
-------------------------------------------

*Explain the process used to identify clusters.*

Show the PCA projection of the cells. Note that only 10 PCs are needed
for 11 topics.

```{r clustering-1, fig.width=8, fig.height=5}
p1 <- basic_pca_plot(poisson2multinom(fit),1:2)
p2 <- basic_pca_plot(poisson2multinom(fit),3:4)
p3 <- basic_pca_plot(poisson2multinom(fit),5:6)
p4 <- basic_pca_plot(poisson2multinom(fit),7:8)
p5 <- basic_pca_plot(poisson2multinom(fit),9:10)
plot_grid(p1,p2,p3,p4,p5,nrow = 2,ncol = 3)
```

These next plots show the *density* of the points in the PCA projection.

```{r clustering-2, fig.width=8, fig.height=5}
p6 <- pca_hexbin_plot(poisson2multinom(fit),1:2) + guides(fill = "none")
p7 <- pca_hexbin_plot(poisson2multinom(fit),3:4) + guides(fill = "none")
p8 <- pca_hexbin_plot(poisson2multinom(fit),5:6) + guides(fill = "none")
p9 <- pca_hexbin_plot(poisson2multinom(fit),7:8) + guides(fill = "none")
p10 <- pca_hexbin_plot(poisson2multinom(fit),9:10) + guides(fill = "none")
plot_grid(p6,p7,p8,p9,p10,nrow = 2,ncol = 3)
```

Identify clusters from PC plots above.

```{r clustering-3}
pca <- prcomp(poisson2multinom(fit)$L)$x
n   <- nrow(pca)
x   <- rep("U",nrow(pca))
pc3 <- pca[,3]
pc4 <- pca[,4]
pc5 <- pca[,5]
pc6 <- pca[,6]
x[pc4 < 5.5*pc3 + 0.5] <- "A"
x[(pc3 + 0.7)^2 + (pc4 - 0.1)^2 < 0.18^2] <- "Cil"
x[x == "A" & pc6 > 1.3*pc5 + 0.87] <- "T+N"
x[x == "A" & pc5 > -0.4 & pc6 < 1.3*pc5 + 0.49] <- "C"
```

```{r temp-1, echo=FALSE, eval=FALSE}
q1 <- labeled_pca_plot(fit,1:2,x)
q2 <- labeled_pca_plot(fit,3:4,x)
q3 <- labeled_pca_plot(fit,5:6,x)
q4 <- labeled_pca_plot(fit,7:8,x)
q5 <- labeled_pca_plot(fit,9:10,x)
plot_grid(q1,q2,q3,q4,q5,nrow = 2,ncol = 3)
```

```{r temp-2, echo=FALSE, eval=FALSE}
p2 +
  scale_x_continuous(n.breaks = 10) +
  scale_y_continuous(n.breaks = 10)
p8 +
  scale_x_continuous(n.breaks = 20) +
  scale_y_continuous(n.breaks = 20)
labeled_pca_plot(fit,3:4,x)
labeled_pca_plot(fit,5:6,x)
table(x)
table(samples$tissue,x)
```

```{r temp-3, echo=FALSE, eval=FALSE}
colors <- c("royalblue","firebrick","forestgreen","gold","greenyellow",
            "darkmagenta","darkorange","skyblue","peru")
q0 <- labeled_pca_plot(fit,1:2,samples$tissue,colors,"tissue") +
      xlim(0,0) + ylim(0,0)
q1 <- labeled_pca_plot(fit,1:2,samples$tissue,colors) + guides(fill = "none")
q2 <- labeled_pca_plot(fit,3:4,samples$tissue,colors) + guides(fill = "none")
q3 <- labeled_pca_plot(fit,5:6,samples$tissue,colors) + guides(fill = "none")
q4 <- labeled_pca_plot(fit,7:8,samples$tissue,colors) + guides(fill = "none")
q5 <- labeled_pca_plot(fit,9:10,samples$tissue,colors) + guides(fill = "none")
plot_grid(q1,q2,q3,q4,q5,q0,nrow = 2,ncol = 3)
```

