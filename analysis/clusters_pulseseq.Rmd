---
title: "Identify clusters in pulse-seq data using topic model"
author: Peter Carbonetto
output: workflowr::wflow_html
---

Here we perform PCA on the topic proportions to identify clusters in
the pulse-seq data. 

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load the packages used in the analysis below, as well as additional
functions that we will use to generate some of the plots.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(dplyr)
library(fastTopics)
library(ggplot2)
library(cowplot)
source("../code/plots.R")
```

Load data and results
---------------------

Load the pulse-seq data.

```{r load-data}
load("../data/pulseseq.RData")
x <- as.character(samples$tissue)
x[x == "club (hillock-associated)"] <- "club"
x[x == "goblet.1" | x == "goblet.2" | x == "goblet.progenitor"] <- "goblet"
x[x == "tuft.1" | x == "tuft.2" | x == "tuft.progenitor"] <- "tuft"
samples$tissue <- factor(x)
```

Load the $k = 11$ Poisson NMF model fit.

```{r load-fit}
fit <- readRDS("../output/pulseseq/rds/fit-pulseseq-scd-ex-k=11.rds")$fit
```

Identify clusters from principal components
-------------------------------------------

To identify clusters, we begin by plotting PCs computed from the topic
proportions. (Note that only 10 PCs are needed for 11 topics.)

```{r clustering-1, fig.width=8, fig.height=5}
p1 <- basic_pca_plot(fit,1:2)
p2 <- basic_pca_plot(fit,3:4)
p3 <- basic_pca_plot(fit,5:6)
p4 <- basic_pca_plot(fit,7:8)
p5 <- basic_pca_plot(fit,9:10)
plot_grid(p1,p2,p3,p4,p5,nrow = 2,ncol = 3)
```

Some of the structure is more evident from "hexbin" plots showing the
density of the points. For example, clear clusters emerge in the
hexbin plots for PCs 3 and 4, and for PCs 5 and 6:

```{r clustering-2, fig.width=8, fig.height=5}
p6  <- pca_hexbin_plot(fit,1:2) + guides(fill = "none")
p7  <- pca_hexbin_plot(fit,3:4) + guides(fill = "none")
p8  <- pca_hexbin_plot(fit,5:6) + guides(fill = "none")
p9  <- pca_hexbin_plot(fit,7:8) + guides(fill = "none")
p10 <- pca_hexbin_plot(fit,9:10) + guides(fill = "none")
plot_grid(p6,p7,p8,p9,p10,nrow = 2,ncol = 3)
```

From these PCA plots, we define 4 clusters, labeled A, D, Cil and
T+N. (The reasoning behind these cluster labels will become clear
later.) Points that do not fit in any of these clusters are assigned
to a "background cluster", labeled U for "unknown".

```{r clustering-3}
pca <- prcomp(poisson2multinom(fit)$L)$x
x   <- rep("U",nrow(pca))
pc3 <- pca[,3]
pc4 <- pca[,4]
pc5 <- pca[,5]
pc6 <- pca[,6]
x[pc4 < 5.5*pc3 + 0.5] <- "A"
x[(pc3 + 0.7)^2 + (pc4 - 0.1)^2 < 0.18^2] <- "Cil"
x[x == "A" & pc6 > 1.3*pc5 + 0.87] <- "T+N"
x[x == "A" & pc5 > -0.4 & pc6 < 1.3*pc5 + 0.49] <- "D"
```

We can refine the small cluster A somewhat by plotting PCs computed
from cluster A only:

```{r clustering-4, fig.width=3, fig.height=2.75}
rows <- which(x == "A")
fit2 <- select(poisson2multinom(fit),loadings = rows)
p11  <- basic_pca_plot(fit2,1:2)
print(p11)
```

We label this refined cluster as "I", and the rest are added back to
the background cluster (U).

```{r clustering-5}
pca  <- prcomp(fit2$L)$x
y    <- rep("U",nrow(pca))
pc1  <- pca[,1]
y[pc1 > -0.1] <- "I"
x[rows] <- y
```

Similarly, we mine the much larger cluster D for substructure:

```{r clustering-6, fig.width=6, fig.height=2.75}
rows <- which(x == "D")
fit2 <- select(poisson2multinom(fit),loadings = rows)
p12  <- basic_pca_plot(fit2,1:2)
p13  <- pca_hexbin_plot(fit2,1:2) + guides(fill = "none")
plot_grid(p12,p13)
```

The hexbin plot suggests two clusters. Although these clusters are not
distinct, it may nonetheless be useful to subdivide these data points
(somewhat arbitrarily) into two subsets, which we label as B and C.

```{r clustering-7}
pca  <- prcomp(fit2$L)$x
y    <- rep("C",nrow(pca))
pc1  <- pca[,1]
pc2  <- pca[,2]
y[pc2 > -pc1 - 0.15] <- "B"
x[rows] <- y
```

Within cluster B, there is some interesting structure along PCs 5 and
6:

```{r clustering-8, fig.width=6, fig.height=2.75}
rows <- which(x == "B")
fit2 <- select(poisson2multinom(fit),loadings = rows)
p14  <- basic_pca_plot(fit2,5:6)
p15  <- pca_hexbin_plot(fit2,5:6) + guides(fill = "none")
plot_grid(p14,p15)
```

From PCs 5 and 6 define a new cluster, "P", recognizing that this
cluster is not particularly distinct.

```{r clustering-9}
pca <- prcomp(fit2$L)$x
y   <- rep("B",nrow(pca))
pc5 <- pca[,5]
pc6 <- pca[,6]
y[pc5 > 0.1 & pc6 < 0] <- "P"
x[rows] <- y
```

In summary, we have subdivided the pulse-seq data into 7 subsets,
which includes a background cluster (U).

```{r clustering-10, fig.width=6, fig.height=5.5}
colors <- c("royalblue","forestgreen","firebrick","darkmagenta",
            "darkorange","peru","gainsboro")
p16 <- labeled_pca_plot(fit,1:2,x,colors) + guides(fill = "none")
p17 <- labeled_pca_plot(fit,3:4,x,colors) + guides(fill = "none")
p18 <- labeled_pca_plot(fit,5:6,x,colors) + guides(fill = "none")
p19 <- labeled_pca_plot(fit,1:2,x,colors,"tissue") +
       xlim(0,0) + ylim(0,0)
plot_grid(p16,p17,p18,p19)
```

Comparing this to the Montoro *et al* (2018) clustering, we observe
some close correspondence (e.g., B and "basal cells", P and
"proliferating cells"). The B and C clusters appear to contain
additional structure that is not well-captured by clusters. We will
explore this additional structure in subsequent analyses.

```{r clustering-11}
samples$cluster <- factor(x)
with(samples,table(tissue,cluster))
```

Structure plot
--------------

TO DO:

+ Add structure plot.

+ Add plot(s) showing continuous substructure in club cells.

+ Add plot(s) showing presence of Krt13+ hillock cells in B ("basal")
  cluster.

Save results
------------

Save the clustering of the pulse-seq data to an RDS file.

```{r save-results}
saveRDS(samples,"clustering-pulseseq.rds")
```
