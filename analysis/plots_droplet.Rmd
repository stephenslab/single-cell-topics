---
title: Visualize and interpret topics in droplet data
author: Peter Carbonetto
output: workflowr::wflow_html
---

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center")
```

Load the packages used in the analysis below.

```{r load-pkgs}
library(fastTopics)
library(ggplot2)
library(cowplot)
```

Load the UMI count data.

```{r load-data}
load("../data/droplet.RData")
```

Load the $k = 13$ Poisson NMF model fit:

```{r load-fit}
fit <- readRDS("../output/droplet/rds/fit-droplet-scd-ex-k=13.rds")$fit
```

Loadings plot:

```{r loading-plot}
p1 <- loadings_plot(poisson2multinom(fit),samples$tissue)
```

Plot for ionocytes:

```{r ionocytes}
fit2 <- poisson2multinom(fit)
plot(fit2$L[,3],fit2$L[,6],pch = 20,col = factor(samples$tissue == "Ionocyte"))
```

PCA plots:

```{r pca}
fit2 <- poisson2multinom(fit)
pca  <- prcomp(fit2$L)
y    <- samples$tissue
clrs <- c("royalblue",      # basal
          "firebrick",      # ciliated
          "forestgreen",    # club
		  "gold",           # goblet
		  "darkmagenta",    # ionocyte
          "darkorange",     # neuroendocrine
		  "darkgray")       # tuft
levels(y) <- clrs
pdat <- cbind(samples,pca$x)
ggplot(pdat,aes(x = PC1,y = PC2,fill = tissue)) +
  geom_point(shape = 21,color = "white",size = 2) +
  scale_fill_manual(values = clrs) +
  theme_cowplot(font_size = 12)
y <- as.character(y)
plot(pca$x[,1],pca$x[,2],pch = 21,col = "white",bg = y,cex = 0.8)
plot(pca$x[,1],pca$x[,6],pch = 21,col = "white",bg = y,cex = 0.8)
```

t-SNE plots:

```{r tsne-plot}
library(Rtsne)
set.seed(1)
n    <- nrow(fit$L)
tsne <- Rtsne(poisson2multinom(fit)$L,pca = FALSE,normalize = FALSE,
              theta = 0.1,max_iter = 1000,perplexity = 100,eta = n/12,
              num_threads = 4,verbose = TRUE)
colnames(tsne$Y) <- c("d1","d2")
p2 <- ggplot(cbind(samples,tsne$Y),aes(x = d1,y = d2,fill = tissue)) +
  geom_point(shape = 21,size = 1.5,color = "white") +
  scale_fill_manual(values = clrs) +
  theme_cowplot(font_size = 12)
```

Differential count analysis:

```{r diff-count-analysis}
diff_count_res <- diff_count_analysis(fit,counts)
```

Volcano plots:

```{r volcano-plots}
p3 <- volcano_plot(diff_count_res,labels = genes$symbol,
                   label_above_quantile = 0.995)
```
